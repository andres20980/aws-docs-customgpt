                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      "control" means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, "submitted"
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a Contribution."

      "Contributor" shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "{}"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright {yyyy} {name of copyright owner}

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.



# Guidelines for contributing

Thank you for your interest in contributing to AWS documentation! We greatly value feedback and contributions from our community.

Please read through this document before you submit any pull requests or issues. It will help us work together more effectively.

## What to expect when you contribute

When you submit a pull request, our team is notified and will respond as quickly as we can. We'll do our best to work with you to ensure that your pull request adheres to our style and standards. If we merge your pull request, we might make additional edits later for style or clarity.

The AWS documentation source files on GitHub aren't published directly to the official documentation website. If we merge your pull request, we'll publish your changes to the documentation website as soon as we can, but they won't appear immediately or automatically.

We look forward to receiving your pull requests for:

* New content you'd like to contribute (such as new code samples or tutorials)
* Inaccuracies in the content
* Information gaps in the content that need more detail to be complete
* Typos or grammatical errors
* Suggested rewrites that improve clarity and reduce confusion

**Note:** We all write differently, and you might not like how we've written or organized something currently. We want that feedback. But please be sure that your request for a rewrite is supported by the previous criteria. If it isn't, we might decline to merge it.

## How to contribute

To contribute, send us a pull request. For small changes, such as fixing a typo or adding a link, you can use the [GitHub Edit Button](https://blog.github.com/2011-04-26-forking-with-the-edit-button/). For larger changes:

1. [Fork the repository](https://help.github.com/articles/fork-a-repo/).
2. In your fork, make your change in a branch that's based on this repo's **main** branch.
3. Commit the change to your fork, using a clear and descriptive commit message.
4. [Create a pull request](https://help.github.com/articles/creating-a-pull-request-from-a-fork/), answering any questions in the pull request form.

Before you send us a pull request, please be sure that:

1. You're working from the latest source on the **main** branch.
2. You check [existing open](https://github.com/awsdocs/elastic-beanstalk-samples/pulls), and [recently closed](https://github.com/awsdocs/elastic-beanstalk-samples/pulls?q=is%3Apr+is%3Aclosed), pull requests to be sure that someone else hasn't already addressed the problem.
3. You [create an issue](https://github.com/awsdocs/elastic-beanstalk-samples/issues/new) before working on a contribution that will take a significant amount of your time.

For contributions that will take a significant amount of time, [open a new issue](https://github.com/awsdocs/elastic-beanstalk-samples/issues/new) to pitch your idea before you get started. Explain the problem and describe the content you want to see added to the documentation. Let us know if you'll write it yourself or if you'd like us to help. We'll discuss your proposal with you and let you know whether we're likely to accept it. We don't want you to spend a lot of time on a contribution that might be outside the scope of the documentation or that's already in the works.

## Finding contributions to work on

If you'd like to contribute, but don't have a project in mind, look at the [open issues](https://github.com/awsdocs/elastic-beanstalk-samples/issues) in this repository for some ideas. Any issues with the [help wanted](https://github.com/awsdocs/elastic-beanstalk-samples/labels/help%20wanted) or [enhancement](https://github.com/awsdocs/elastic-beanstalk-samples/labels/enhancement) labels are a great place to start.

In addition to written content, we really appreciate new examples and code samples for our documentation, such as examples for different platforms or environments, and code samples in additional languages.

## Code of conduct

This project has adopted the [Amazon Open Source Code of Conduct](https://aws.github.io/code-of-conduct). For more information, see the [Code of Conduct FAQ](https://aws.github.io/code-of-conduct-faq) or contact [opensource-codeofconduct@amazon.com](mailto:opensource-codeofconduct@amazon.com) with any additional questions or comments.

## Security issue notifications

If you discover a potential security issue, please notify AWS Security via our [vulnerability reporting page](http://aws.amazon.com/security/vulnerability-reporting/). Please do **not** create a public issue on GitHub.

## Licensing

See the [LICENSE](https://github.com/awsdocs/elastic-beanstalk-samples/blob/master/LICENSE) file for this project's licensing. We will ask you to confirm the licensing of your contribution. We may ask you to sign a [Contributor License Agreement (CLA)](http://en.wikipedia.org/wiki/Contributor_License_Agreement) for larger changes.



## Contribution instructions
You can submit new configuration files to the [community-provided](https://github.com/awslabs/elastic-beanstalk-samples/tree/master/configuration-files/community-provided) folder.

Name the configuration file in lowercase with terms that describe the category and use case separated by hyphens, ordered from general to specific. For example:
 
  `https-instancecert-dotnet.config`

Includes a category (HTTPS), use case (instance certificate), and platform (.NET). Always include the platform last if the config is platform dependent.

Platform keywords: php, python, nodejs, golang, ruby-passenger, ruby-puma, java-tomcat, java-se, docker-sc, docker-mc, docker-pc, dotnet

Include detailed usage instructions in the configuration file itself, in comments:
```
###################################################################################################
#### These are instructions for using the configuration file, which indicate the parameters
#### that need to be changed by the user, their meaning, and an overall description of how the
#### configuration file works. Include caveats that may apply depending on the user's VPC
#### configuration (default VPC, custom VPC or no VPC), and reference other files that may be used
#### in conjunction with this one. The bounding hash marks are 99 characters long.
####
#### Author: @yourusername
###################################################################################################
```
Gather all user-configurable values as close to the top of the file as possible. Use parameters and
Refs to populate values in `Resources` blocks:

(Parameter definition near the top of the file)
```
Parameters:
  timeout: 
    Type: Number                  # Typically Number, String or CommaDelimitedList
    Description: Description      # Description of the parameter
    Default: 1500                 # Include a useful default value if you can, otherwise leave blank
```
(farther down, in a Resources block)
```
  Properties:
    Timeout: { "Ref": "timeout" }
```
`Ref`s can't be used for everything. They don't work reliably with values for configuration
settings or things like the name or content of a file in a `files` block.

Use the following block to indicate the fold below which no values should be changed:
```
##############################################
#### Do not modify values below this line ####
##############################################
```

For complex use cases, you can split your configuration into multiple files. For example, configuring HTTPS end-to-end involves multiple resources - terminating HTTPS on the load balancer, security group and backend port configuration, and terminating HTTPS again at the instance. Much of this configuration is also useful alone or in other use cases, so each piece is provided in an independent config file with instructions for supported use cases in each.

If the components are not independent or re-usable, create a subfolder for the use case in the appropriate category folder (e.g. security configuration) and include all needed configs and instructions.

Create a separate pull request and branch for each use case.



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Use this example when your environment has a Classic Load Balancer.
#### The example uses options in the aws:elb:listener namespace to configure an HTTPS listener on
#### port 443 with the specified certificate, and to forward the decrypted traffic to the instances
#### in your environment on port 80.
####
#### Set EB_ELB_ACM in your environment variables with the ARN of your certificate. The certificate can be one
#### that you created or uploaded in AWS Certificate Manager (ACM) (preferred), or one that you uploaded to IAM with the AWS CLI.
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile
###################################################################################################

option_settings:
  aws:elb:listener:443:
    SSLCertificateId:
      "Fn::GetOptionSetting":
          Namespace: "aws:elasticbeanstalk:application:environment"
          OptionName: "EB_ELB_ACM"
          DefaultValue: {"Ref":"AWS::NoValue"}
    ListenerProtocol: HTTPS
    InstancePort: 443



###################################################################################################
####
#### HTTPS redirection configuration for AL2 PHP platforms that use NGINX
#### This will simply redirect HTTP requests to the 443 listener on the ELB
####  
#### HTTPS redirection for all HTTP requests, unless they come from the ELB healthchecker.
#### Note that this does not require a rewrite of the default EB NGINX .conf file.
####
###################################################################################################

files:
   "/etc/nginx/conf.d/elasticbeanstalk/https_redirect.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       set $redirect 0;
       if ($http_x_forwarded_proto != "https") {
         set $redirect 1;
       }
       if ($http_user_agent ~* "ELB-HealthChecker") {
         set $redirect 0;
       }
       if ($redirect = 1) {
         return 301 https://google.com;
       }



###################################################################################################
#### This configuration file uses the configuration options in the aws:elb:loadbalancer & 
#### aws:autoscaling:launchconfiguration namespaces to modify the default security groups for your environment. 
#### This allows you to bypass beanstalk auto-creating a security group for you, and use your own pre-defined groups
####
#### Note that in order for this to take effect it needs to be applied during environment creation, so an application
#### version must be uploaded and used as a VersionLabel during environment creation.
####
#### See the following topic for more information about the options in this namespace:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.as.html
#### 
#### Author: Moshe Eshel @mosheeshel
###################################################################################################

Parameters:
  asg_sg_ids:
    Type: CommaDelimitedList
    Description: Custom (list of) Security Group(s) for Auto Scaling Group (supports a list in the "sg1,sg2,sg3", as well as single value "sg")
  elb_sg_ids:   # replace with your own SG (supports a list in the "sg1,sg2,sg3", as well as single value "sg"
    Type: CommaDelimitedList
    Description: Custom (list of) Security Group(s) for Elastic Load Balancer (supports a list in the "sg1,sg2,sg3", as well as single value "sg")
  subnet_id:   
    Type: String
    Description: Subnet id of service, required in VPC situation

Resources:
  AWSEBSecurityGroup: { "CmpFn::Remove" : {} }
  AWSEBAutoScalingLaunchConfiguration:
    Properties:
      SecurityGroups:  { "Ref": "asg_sg_ids" } 
  AWSEBLoadBalancer:
    Properties:
      SecurityGroups: { "Ref": "elb_sg_ids" }

option_settings:
    - namespace: "aws:elb:loadbalancer"
      option_name: "SecurityGroups"
      value: { "Ref": "elb_sg_ids" }
    - namespace: "aws:elb:loadbalancer"
      option_name: "ManagedSecurityGroup"
      value: { "Ref": "elb_sg_ids" }
    - namespace: "aws:ec2:vpc"
      option_name: "ELBSubnets"
      value: { "Ref": "subnet_id" }



###################################################################################################
#### This configuration file runs presents an example to modify the ec2 instance metadata.
####
#### 01_hoplimit: Modifies the http-put-response-hop-limit to 2 for an instance in the
####              eu-west-2 region (change as appropriate).
####              This allows an application running in Docker able to assume the EC2's role.
####              NOTE: The 'ec2:ModifyInstanceMetadataOptions' permission is needed in the instance profile
####                    Default name of this profile is: aws-elasticbeanstalk-ec2-role
####
#### Author: Adel Haddad @adehad
###################################################################################################

commands:
  01_hoplimit:
    command: "instanceID=$(curl http://169.254.169.254/latest/meta-data/instance-id  ) && aws ec2 modify-instance-metadata-options --region eu-west-2 --instance-id $instanceID --http-put-response-hop-limit 2 --http-endpoint enabled"



###################################################################################################
#### Tag EBS volume Name with the Elastic Beanstalk environment name. This is the same naming
#### convention used on the instances to which the volumes are attached. Without this config
####Â Elastic Beanstalk leaves the volume Name tag empty.
#### This requires that the IAM role have EC2 Create Tag and EC2 Describe permissions since the
#### volume is tagged by the instance (as opposed to the service/service role).
####
#### Note: According to support this is "an ongoing feature request to add support for tagging EBS
####       volume by allowing the Resource tags to be propagated to the Launch Template".
####       Which is to say: hopefully this will not be required at some point in future.
####
#### Author: @hayd
###################################################################################################

container_commands:
  tagVolume:
    command: aws ec2 create-tags --resources $(aws ec2 describe-instances --region $(curl -H "X-aws-ec2-metadata-token:$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds:21600")" http://169.254.169.254/latest/meta-data/placement/availability-zone|  sed 's/[a-z]$//') --instance-id $(curl -H "X-aws-ec2-metadata-token:$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds:21600")" http://169.254.169.254/latest/meta-data/instance-id ) --output text --query Reservations[0].Instances[0].BlockDeviceMappings[0].Ebs.VolumeId) --region $(curl -H "X-aws-ec2-metadata-token:$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds:21600")" http://169.254.169.254/latest/meta-data/placement/availability-zone|  sed 's/[a-z]$//') --tags Key=Name,Value=$(/opt/elasticbeanstalk/bin/get-config container -k environment_name)



files:
  "/tmp/cw-instance-logs.json":
    content: |
      {
        "metrics": {
          "append_dimensions": {
            "AutoScalingGroupName": "${aws:AutoScalingGroupName}"
          },
          "metrics_collected": {
            "mem": {
              "measurement": [
                "mem_used_percent"
              ],
              "metrics_collection_interval": 1
            }
          }
        },
        "logs": {
          "logs_collected": {
            "files": {
              "collect_list": [
                {
                  "file_path": "/var/app/containerfiles/logs/production.log",
                  "log_group_name": "`{"Fn::Join":["/", ["/aws/elasticbeanstalk", { "Ref":"AWSEBEnvironmentName" }, "var/log/production"]]}`",
                  "log_stream_name": "{instance_id}"
                },
                {
                  "file_path": "/var/app/containerfiles/logs/staging.log",
                  "log_group_name": "`{"Fn::Join":["/", ["/aws/elasticbeanstalk", { "Ref":"AWSEBEnvironmentName" }, "var/log/staging"]]}`",
                  "log_stream_name": "{instance_id}"
                }
              ]
            }
          }
        }
      }

container_commands:
  01-custom-cw-config:
    command: |
      echo "Enabling custom CloudWatch configuration"
      /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -s -c file:/tmp/cw-instance-logs.json


files:
  "/opt/elasticbeanstalk/bin/get-config":
      mode: "000755"
      content : |
        #!/bin/bash

        if [ "$1" != "environment" ]
        then
            echo $0 unsupported argument $1
            exit 1
        fi

        if [ "$2" != "-k" ]
        then
            echo $0 unsupported argument $2
            exit 1
        fi

        EB_META_DATA_FILE=/tmp/metadata.json
        ENV_VARS_FILE=/tmp/envvars
        sudo /opt/aws/bin/cfn-get-metadata -s $(</opt/elasticbeanstalk/config/ebenvinfo/stackid) -r AWSEBBeanstalkMetadata --region $(</opt/elasticbeanstalk/config/ebenvinfo/region) -k "AWS::ElasticBeanstalk::Ext">${EB_META_DATA_FILE}
        ENV_VARS=$(jq -r '.Parameters.EnvironmentVariables' < ${EB_META_DATA_FILE})
        echo ${ENV_VARS} | jq -r 'to_entries[] | [.value] | join("")' >${ENV_VARS_FILE}
        #cat ${ENV_VARS_FILE}
        #source ${ENV_VARS_FILE}
        export $(cat ${ENV_VARS_FILE} | grep $3 | xargs )
        echo ${!3}
        rm $EB_META_DATA_FILE
        rm $ENV_VARS_FILE



###################################################################################################
#### This configuration file which limits the request body size for an Apache proxy
####
#### The workflow will create a *.conf file in the directory which Apache uses to check for
#### additional proxy configuration which extends the existing Apache proxy configuration.
####
#### The value which LimitRequestBody accepts is a number, and represent bytes. In this case the
#### request body is limited to 102400 bytes.
####
#### This will work for Apache proxy servers running on both Amazon Linux and Amazon Linux 2 AMIs
####
#### Author: @pedreviljoen
###################################################################################################

files:
    "/etc/httpd/conf.d/filelimit.conf":
        mode: "000755"
        owner: root
        group: root
        content: |
            LimitRequestBody 102400


###################################################################################################
#### This configuration file runs a PowerShell script that modifies the Windows registry to enable
#### Windows Update and configures it to automatically download and schedule updates.
####
#### Author: @kylegalbraith
###################################################################################################

files:
  "c:/temp/configureUpdates.ps1":
    content: |
      Invoke-Expression "reg add 'HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update' /v AUOptions /t REG_DWORD /d 4 /f"
      Invoke-Expression "sc config wuauserv start=auto"
      Invoke-Expression "net start wuauserv"
container_commands:
  01-execute-config-scirpt:
    command: Powershell.exe -ExecutionPolicy Bypass -File c:\\temp\\configureUpdates.ps1
    ignoreErrors: true
    waitAfterCompletion: 0


###################################################################################################
#### This configuration file Mount Elastic File System using Mount target IP Address.          ####
#### Before mounting to a target IP address, you have to create EFS with a specific IP address.#### 
#### It's just like you can select an IP from the range of Ip's subnets have.                  ####
####                                                                                           ####
#### Author: @karan6190                                                                        ####
###################################################################################################


option_settings:
  aws:elasticbeanstalk:application:environment:
    MOUNT_TARGET_IP: 'xx.xx.xx.xx'
    MOUNT_DIRECTORY: '/efs'

##############################################
#### Do not modify values below this line ####
##############################################

packages:
  yum:
    nfs-utils: []

commands:
  01_mount:
    command: "/tmp/mount-efs.sh"

files:
  "/tmp/mount-efs.sh":
      mode: "000755"
      content : |
        #!/bin/bash

        EFS_MOUNT_DIR=$(/opt/elasticbeanstalk/bin/get-config environment -k MOUNT_DIRECTORY)
        EFS_MOUNT_TARGET_IP=$(/opt/elasticbeanstalk/bin/get-config environment -k MOUNT_TARGET_IP)

        echo "Mounting IP Address ${EFS_MOUNT_TARGET_IP} to directory ${EFS_MOUNT_DIR} ..."

        echo 'Stopping NFS ID Mapper...'
        service rpcidmapd status &> /dev/null
        if [ $? -ne 0 ] ; then
            echo 'rpc.idmapd is already stopped!'
        else
            service rpcidmapd stop
            if [ $? -ne 0 ] ; then
                echo 'ERROR: Failed to stop NFS ID Mapper!'
                exit 1
            fi
        fi

        echo 'Checking if EFS mount directory exists...'
        if [ ! -d ${EFS_MOUNT_DIR} ]; then
            echo "Creating directory ${EFS_MOUNT_DIR} ..."
            mkdir -p ${EFS_MOUNT_DIR}
            if [ $? -ne 0 ]; then
                echo 'ERROR: Directory creation failed!'
                exit 1
            fi
        else
            echo "Directory ${EFS_MOUNT_DIR} already exists!"
        fi

        mountpoint -q ${EFS_MOUNT_DIR}
        if [ $? -ne 0 ]; then
            echo "mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 ${EFS_MOUNT_TARGET_IP}:/ ${EFS_MOUNT_DIR}"
            mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 ${EFS_MOUNT_TARGET_IP}:/ ${EFS_MOUNT_DIR}
            if [ $? -ne 0 ] ; then
                echo 'ERROR: Mount command failed!'
                exit 1
            fi
            chmod 777 ${EFS_MOUNT_DIR}
            runuser -l  ec2-user -c "touch ${EFS_MOUNT_DIR}/it_works"
            if [[ $? -ne 0 ]]; then
                echo 'ERROR: Permission Error!'
                exit 1
            else
                runuser -l  ec2-user -c "rm -f ${EFS_MOUNT_DIR}/it_works"
            fi
        else
            echo "Directory ${EFS_MOUNT_DIR} is already a valid mountpoint!"
        fi

        echo 'EFS mount complete.'



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Use this example when your environment has a Classic Load Balancer.
#### The example uses options in the aws:elb:listener namespace to configure an HTTPS listener on
#### port 443 with the specified certificate, and to forward the decrypted traffic to the instances
#### in your environment on port 80.
####
#### Replace theSSLCertificateId with the ARN of your certificate. The certificate can be one
#### that you created or uploaded in AWS Certificate Manager (ACM) (preferred), or one that you uploaded to IAM with the AWS CLI.
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile
###################################################################################################

option_settings:
  aws:elb:listener:443:
    SSLCertificateId: arn:aws:acm:us-east-2:1234567890123:certificate/####################################
    ListenerProtocol: HTTPS
    InstancePort: 80



### https-instancecert
Install a certificate and private key stored in Amazon S3, and configure the proxy server that runs in front of your application to terminate HTTPS connections. Use this configuration to terminate HTTPS in single instance environments, environments with a load balancer configured to pass through encrypted traffic as-is, or environments with a load balancer that decrypts HTTPS, then re-encrypts between the load balancer and the instance serving the request.

For single instance environments, include `https-singleinstance-securitygroup.config` as well to allow HTTPS traffic through the instance's security group.

### https-redirect
Configure the proxy server that runs in front of your application to redirect HTTP requests on port 80 to the same path on HTTPS/443.

### proxy-ratelimit-linux
Configure Apache or Nginx to rate limit the amount of unique inbound connections per instance in that environment.

### https-singleinstance-securitygroup.config
Modify your instance's security group to allow HTTPS traffic on port 443. Use in conjunction with `https-instancecert-<platform>.config` to support HTTPS connections in a single instance environment.

### loadbalancer-alb-securelistener.config
The example uses options in the aws:elbv2:listener namespace to configure an HTTPS listener on port 443 with the specified certificate.
https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile

### loadbalancer-clb-securelistener.config
The example uses options in the aws:elb:listener namespace to configure an HTTPS listener on port 443 with the specified certificate.
https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile

### loadbalancer-nlb-securelistener.config
The example uses options in the aws:elbv2:listener namespace to configure a listener on port 443. The listener routes traffic to the default process. https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile

### rds-ssl-java.config
Install SSL certificates for RDS database connections with JDBC.

### redshift-ssl-java.config
Install SSL certificates for Redshift database connections with JDBC.

### securitygroup-addexisting.config
Configure the Auto Scaling Group to launch EC2 instances with an existing Security Group. This is an additional Security Group to the one automatically created by Elastic Beanstalk for the EC2 instances. Useful when configuring a database's instance Security Group to only accept connections from a specific source Security Group of your Elastic Beanstalk environment's instances.

### securitygroup-loadbalanced-configureexisting.config
Configure the Security Groups for the ELB and the EC2 instances apart of the Auto Scaling Group. This is useful If you'd like to make changes to the default Security Groups created by Elastic Beanstalk.

### ssh-sourcerestriction.config
Use the `SSHSourceRestriction` option in the `aws:autoscaling:launchconfiguration` namespace to restrict SSH traffic to connections from instances in a security group that you control. By default, Elastic Beanstalk opens port 22 to the world when you assign a key pair to your instances. Use this configuration file to override that behavior.



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures ingress rules to the instance's and ELB security group.
#### This will override existing configuration of the Security Groups for both the instance and the
#### ELB. The configuration below allows 80 and 443 to the ELB and port 80 from the ELB to the
#### instances.
###################################################################################################

Resources:
    AWSELBSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: ELB SecurityGroup for ElasticBeanstalk environment.
            SecurityGroupIngress:
                - FromPort: 80
                  ToPort: 80
                  IpProtocol: tcp
                  CidrIp : 0.0.0.0/0
                - FromPort: 443
                  ToPort: 443
                  IpProtocol: tcp
                  CidrIp : 0.0.0.0/0
    AWSEBLoadBalancer:
        Type: AWS::ElasticLoadBalancing::LoadBalancer
        Properties:
            SecurityGroups:
                - Fn::GetAtt:
                    - AWSELBSecurityGroup
                    - GroupId
    AWSEBSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: EB SecurityGroup for ElasticBeanstalk environment.
            SecurityGroupIngress:
                - ToPort: 80
                  FromPort: 80
                  IpProtocol: tcp
                  SourceSecurityGroupId: { "Fn::GetAtt" : [ "AWSELBSecurityGroup", "GroupId" ]}



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Use this example when your environment has an Application Load Balancer.
#### The example uses options in the aws:elbv2:listener namespace to configure an HTTPS listener on
#### port 443 with the specified certificate. The listener routes traffic to the default process.

#### Replace SSLCertificateArns with the ARN of your certificate. The certificate can be one
#### that you created or uploaded in AWS Certificate Manager (ACM) (preferred), or one that you uploaded to IAM with the AWS CLI.
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile
###################################################################################################

option_settings:
  aws:elbv2:listener:443:
    ListenerEnabled: 'true'
    Protocol: HTTPS
    SSLCertificateArns: arn:aws:acm:us-east-2:1234567890123:certificate/####################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Use this example when your environment has an Network Load Balancer.
#### The example uses options in the aws:elbv2:listener namespace to configure a listener on
#### port 443. The listener routes traffic to the default process.
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html#configuring-https-elb.configurationfile
###################################################################################################

option_settings:
  aws:elbv2:listener:443:
    ListenerEnabled: 'true'



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
#### If your application listens on a port other than 5000, change the application port in the 
#### location block of the nginx configuration file.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS Server
      
      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
          ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
          ssl_prefer_server_ciphers   on;
          
          location / {
              proxy_pass  http://localhost:5000;  ## Application port
              proxy_set_header   Connection "";
              proxy_http_version 1.1;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Real-IP       $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          }
      }

##############################################
#### Do not modify values below this line ####
##############################################

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

container_commands:
  01restart_nginx:
    command: "service nginx restart"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS Server
      
      server {
        listen 443;
        server_name localhost;
        
        ssl on;
        ssl_certificate /etc/pki/tls/certs/server.crt;
        ssl_certificate_key /etc/pki/tls/certs/server.key;
        
        ssl_session_timeout 5m;
        
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
        ssl_prefer_server_ciphers on;
        
        location / {
          proxy_pass http://docker;
          proxy_http_version 1.1;
          
          proxy_set_header Connection "";
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
      }

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

container_commands:
  01restart_nginx:
    command: "service nginx restart"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a PFX certificate and password file from Amazon S3 and uses
#### them to install a certificate and bind it to port 443. Replace the values in the Settings 
#### section with the name of your bucket, the certificate, and the text file containing your
#### password. To download the files, your environment's instance profile must have S3ReadOnlyAccess
#### or a similar policy attached.
#### In a single instance environment, also include https-singleinstance-securitygroup.config to
#### allow traffic to the instance on port 443.
###################################################################################################

files:
  "C:\\certs\\install-cert.ps1":
    content: |
      import-module webadministration
      ## Settings - replace the following values with your own
      $bucket = "my-bucket"        ## S3 bucket name
      $certkey = "example.com.pfx" ## S3 object key for your PFX certificate
      $pwdkey = "password.txt"     ## S3 object key for a text file containing the certificate's password
      ##

      # Set variables
      $certfile = "C:\cert.pfx"
      $pwdfile = "C:\certs\pwdcontent"
      Read-S3Object -BucketName $bucket -Key $pwdkey -File $pwdfile
      $pwd = Get-Content $pwdfile -Raw

      # Cleanup existing binding
      if ( Get-WebBinding "Default Web Site" -Port 443 ) {
        Echo "Removing WebBinding"
        Remove-WebBinding -Name "Default Web Site" -BindingInformation *:443:
      }
      if ( Get-Item -path IIS:\SslBindings\0.0.0.0!443 ) {
        Echo "Deregistering WebBinding from IIS"
        Remove-Item -path IIS:\SslBindings\0.0.0.0!443
      }

      # Download certificate from S3
      Read-S3Object -BucketName $bucket -Key $certkey -File $certfile
      
      # Install certificate
      Echo "Installing cert..."
      $securepwd = ConvertTo-SecureString -String $pwd -Force -AsPlainText
      $cert = Import-PfxCertificate -FilePath $certfile cert:\localMachine\my -Password $securepwd
      
      # Create site binding
      Echo "Creating and registering WebBinding"
      New-WebBinding -Name "Default Web Site" -IP "*" -Port 443 -Protocol https
      New-Item -path IIS:\SslBindings\0.0.0.0!443 -value $cert -Force
      
      ## (optional) Remove the HTTP binding - uncomment the following line to unbind port 80
      # Remove-WebBinding -Name "Default Web Site" -BindingInformation *:80:
      ##
      
      # Update firewall
      netsh advfirewall firewall add rule name="Open port 443" protocol=TCP localport=443 action=allow dir=OUT

commands:
  00_install_ssl:
    command: powershell -NoProfile -ExecutionPolicy Bypass -file C:\\certs\\install-cert.ps1


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures Apache to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
#### If your application is not named "application.py" or is not in the root of your source bundle,
#### replace the application name in the Apache config below.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

files:
  # Apache HTTPS configuration
  /etc/httpd/conf.d/ssl.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule wsgi_module modules/mod_wsgi.so
      WSGIPythonHome /opt/python/run/baselinenv
      WSGISocketPrefix run/wsgi
      WSGIRestrictEmbedded On
      <VirtualHost *:443>
        SSLEngine on
        SSLCertificateFile "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        
        Alias /static/ /opt/python/current/app/static/
        <Directory /opt/python/current/app/static>
        Order allow,deny
        Allow from all
        </Directory>
        
        WSGIScriptAlias / /opt/python/current/app/application.py  ## Application name
        
        <Directory /opt/python/current/app>
        Require all granted
        </Directory>
        
        WSGIDaemonProcess wsgi-ssl processes=1 threads=15 display-name=%{GROUP} \
          python-path=/opt/python/current/app:/opt/python/run/venv/lib/python3.4/site-packages:/opt/python/run/venv/lib64/python3.4/site-packages \
          home=/opt/python/current/app \
          user=wsgi \
          group=wsgi
        WSGIProcessGroup wsgi-ssl
        
      </VirtualHost>

##############################################
#### Do not modify values below this line ####
##############################################

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

packages:
  yum:
    mod24_ssl : []

container_commands:
  1killhttpd:
    command: "killall httpd"
    ignoreErrors: true
  2wait:
    command: "sleep 3"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3. Replace the values in the
#### Parameters section with the URL of the private key in Amazon S3, and the contents of the
#### public certificate. To configure Passenger to terminate HTTPS connections, include a JSON
#### file named "passenger-standalone.json" in the root of your source code with the following
#### content:
#### {
####   "ssl" : true,
####   "ssl_port" : 443,
####   "ssl_certificate" : "/etc/pki/tls/certs/server.crt",
####   "ssl_certificate_key" : "/etc/pki/tls/certs/server.key"
#### }
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"

files:
  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS server

      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
          ssl_prefer_server_ciphers   on;
          
          location / {
              proxy_pass  http://nodejs;
              proxy_set_header   Connection "upgrade";
              proxy_http_version 1.1;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Real-IP       $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          }
      }

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"




###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures Apache to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

files:
  # Apache HTTPS configuration
  /etc/httpd/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule ssl_module modules/mod_ssl.so
      <VirtualHost *:443>
        <Proxy *>
          Order deny,allow
          Allow from all
        </Proxy>

        SSLEngine             on
        SSLCertificateFile    "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        SSLCipherSuite        EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
        SSLProtocol           All -SSLv2 -SSLv3
        SSLHonorCipherOrder   On
        
        Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
        Header always set X-Frame-Options DENY
        Header always set X-Content-Type-Options nosniff
        
        ProxyPass / http://localhost:8080/ retry=0
        ProxyPassReverse / http://localhost:8080/
        ProxyPreserveHost on

      </VirtualHost>

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

packages:
  yum:
    mod_ssl : []

container_commands:
  1killhttpd:
    command: "killall httpd"
    ignoreErrors: true
  2wait:
    command: "sleep 3"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
#### If your application listens on a port other than 5000, change the application port in the 
#### location block of the nginx configuration file.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS Server
      
      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
          ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
          ssl_prefer_server_ciphers   on;
          
          location / {
              proxy_pass  http://localhost:5000;  ## Application port
              proxy_set_header   Connection "";
              proxy_http_version 1.1;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Real-IP       $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          }
      }

##############################################
#### Do not modify values below this line ####
##############################################

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

container_commands:
  01restart_nginx:
    command: "service nginx restart"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    content: |
      # HTTPS server

      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
          ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
          ssl_prefer_server_ciphers   on;
          
          location / {
              proxy_pass  http://my_app;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          }

          # Location has a final backslash to avoid matching valid Rails routes that may start
          # with assets*, for example a controller assets_pickers_controller
          location /assets/ {
            alias /var/app/current/public/assets/;
            gzip_static on;
            gzip on;
            expires max;
            add_header Cache-Control public;
          }

          # Location has a final backslash to avoid matching valid Rails routes that may start
          # with public*, for example a controller public_profiles_controller
          location /public/ {
            alias /var/app/current/public/;
            gzip_static on;
            gzip on;
            expires max;
            add_header Cache-Control public;
          }
      }

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

container_commands:
  01restart_nginx:
    command: "service nginx restart"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures Apache to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
#### If your application is not named "application.py" or is not in the root of your source bundle,
#### replace the application name in the Apache config below.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----

files:
  # Apache HTTPS configuration
  /etc/httpd/conf.d/ssl.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule wsgi_module modules/mod_wsgi.so
      WSGIPythonHome /opt/python/run/baselinenv
      WSGISocketPrefix run/wsgi
      WSGIRestrictEmbedded On
      <VirtualHost *:443>
        SSLEngine on
        SSLCertificateFile "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        
        Alias /static/ /opt/python/current/app/static/
        <Directory /opt/python/current/app/static>
        Order allow,deny
        Allow from all
        </Directory>
        
        WSGIScriptAlias / /opt/python/current/app/application.py  ## Application name
        
        <Directory /opt/python/current/app>
        Require all granted
        </Directory>
        
        WSGIDaemonProcess wsgi-ssl processes=1 threads=15 display-name=%{GROUP} \
          python-path=/opt/python/current/app:/opt/python/run/venv/lib/python2.7/site-packages:/opt/python/run/venv/lib64/python2.7/site-packages \
          home=/opt/python/current/app \
          user=wsgi \
          group=wsgi
        WSGIProcessGroup wsgi-ssl
        
      </VirtualHost>

##############################################
#### Do not modify values below this line ####
##############################################

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

packages:
  yum:
    mod24_ssl : []

container_commands:
  1killhttpd:
    command: "killall httpd"
    ignoreErrors: true
  2wait:
    command: "sleep 3"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures Apache to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/privatekey.key"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      Paste your public certificate content here
      -----END CERTIFICATE-----


##############################################
#### Do not modify values below this line ####
##############################################

files:
  # Apache HTTPS configuration
  /etc/httpd/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule ssl_module modules/mod_ssl.so
      <VirtualHost *:443>
        <Proxy *>
          Order deny,allow
          Allow from all
        </Proxy>

        SSLEngine             on
        SSLCertificateFile    "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        SSLCipherSuite        EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
        SSLProtocol           All -SSLv2 -SSLv3
        SSLHonorCipherOrder   On
        SSLSessionTickets     Off
        
        Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
        Header always set X-Frame-Options DENY
        Header always set X-Content-Type-Options nosniff
        
        ProxyPass / http://localhost:80/ retry=0
        ProxyPassReverse / http://localhost:80/
        ProxyPreserveHost on
        RequestHeader set X-Forwarded-Proto "https" early
        
      </VirtualHost>

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

packages:
  yum:
    mod24_ssl : []

container_commands:
  1killhttpd:
    command: "killall httpd"
    ignoreErrors: true
  2wait:
    command: "sleep 3"

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Nginx for NodeJS environments to rate limit the amount of 
#### unique inbound connections to 1 connection per second with a burst of 10.
####
#### Note there are different HTTP headers used by Nginx for Load Balanced and Single Instance 
#### Environments for detecting the source IP address. Load Balanced environments will use the
#### "HTTP_X_FORWARDED_FOR" header and Single Instance will use "REMOTE_ADDR". Configure this for
#### your environment below on the line "limit_req_zone".
###################################################################################################

files:
   "/tmp/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       # Elastic Beanstalk Managed
       
       # Elastic Beanstalk managed configuration file
       # Some configuration of nginx can be by placing files in /etc/nginx/conf.d
       # using Configuration Files.
       # http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers.html 
       # 
       # Modifications of nginx.conf can be performed using container_commands to modify the staged version
       # located in /tmp/deployment/config/etc#nginx#nginx.conf
       
       upstream nodejs {
           server 127.0.0.1:8081;
           keepalive 256;
       }
       
       # limit the number of connections to 1 per second and allow to burst to 10
       limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Load Balanced environments
       #limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments

       limit_req zone=application burst=10 nodelay;
       limit_req_status 429;
       limit_conn_status 429;

       # pass real IP from client to NGINX
       real_ip_header X-Forwarded-For;
       set_real_ip_from 0.0.0.0/0;

       server {
           # set error page for HTTP code 429
           error_page 429 @ratelimit;

           location @ratelimit {
               return 429 'Connection Limit Exceeded\n';
           }

           listen 8080;
       
           if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
               set $year $1;
               set $month $2;
               set $day $3;
               set $hour $4;
           }
           access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
           access_log  /var/log/nginx/access.log  main;
       
           location / {
               proxy_pass  http://nodejs;
               proxy_set_header   Connection "";
               proxy_http_version 1.1;
               proxy_set_header        Host            $host;
               proxy_set_header        X-Real-IP       $remote_addr;
               proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
           }
       
       gzip on;
       gzip_comp_level 4;
       gzip_types text/html text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
       
       }
 
container_commands:
  99_move_config:
    command: "mv -f /tmp/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Apache for NodeJS environments to rate limit the amount of 
#### unique inbound connections to 1 connection per second with a burst of 10.
####
#### Note the default reverse proxy for Node.js is Nginx. To enable Apache have a look here:
####   http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_nodejs.container.html#nodejs-platform-configfiles
####
#### Note there are different HTTP headers used by Apache for Load Balanced and Single Instance 
#### Environments for detecting the source IP address. Load Balanced environments will use the
#### "HTTP_X_FORWARDED_FOR" header and Single Instance will use "REMOTE_ADDR". Configure this for
#### your environment below on the line "Define src_header".
###################################################################################################

packages:
  yum:
    mod24_security: []

files:
  "/etc/httpd/conf.d/mod_security.conf" :
    mode: "000644"
    owner: root
    group: root
    content: |
      # The amount of connections per second.
      Define cons_per_sec 1
      # The amount of connections that a single remote ip can burst to.
      Define cons_burst 10
      # The header to use for tracking source ip addresses. Use "X-Forwarded-For" for Load Balanced environments and "REMOTE_ADDR" for Single instance.
      Define src_header X-Forwarded-For
      #Define src_header REMOTE_ADDR

      <IfModule mod_security2.c>

      SecRuleEngine On
      SecStatusEngine Off

      <LocationMatch "^/">
          SecAction initcol:ip=%{REQUEST_HEADERS:${src_header},pass,nolog,id:11
          SecAction "phase:5,deprecatevar:ip.awscounter=${cons_per_sec}/1,pass,nolog,id:12"
          SecRule IP:AWSCOUNTER "@gt ${cons_burst}" "phase:2,deny,status:429,setenv:RATELIMITED,skip:1,log,id:13"
          SecAction "phase:2,pass,setvar:ip.awscounter=+1,nolog,id:14"
      </LocationMatch>

      SecDebugLogLevel 0
      SecDataDir /tmp

      ErrorDocument 429 "Connection Limit Exceeded"

      </IfModule>



{
   "nginx_config_template" : "/opt/elasticbeanstalk/support/conf/rate-limit.erb"
}



files:
  "/opt/elasticbeanstalk/support/conf/rate-limit.erb":
    owner: root
    group: root
    mode: "000644"
    content: |
      ##############################################################
      #  Phusion Passenger Standalone uses a template file to
      #  generate an Nginx configuration file. The original template
      #  file can be found by running the following command:
      #
      #    ls $(passenger-config about resourcesdir)/templates/standalone/config.erb
      #
      #  You can create a copy of this template file and customize it
      #  to your liking. Just make sure you tell Phusion Passenger Standalone
      #  to use your template file by passing the --nginx-config-template
      #  parameter.
      #
      #  *** NOTE ***
      #  If you customize the template file, make sure you keep an eye
      #  on the original template file and merge any changes.
      #  New Phusion Passenger features may require changes to the template
      #  file.
      ##############################################################
      
      
      master_process on;
      worker_processes 1;
      daemon on;
      error_log '<%= @options[:log_file] %>' <% if debugging? %>info<% end %>;
      pid '<%= @options[:pid_file] %>';
      
      <% if Process.euid == 0 %>
          <% if @options[:user] %>
              <%# Run workers as the given user. The master process will always run as root and will be able to bind to any port. %>
              user <%= @options[:user] %> <%= default_group_for(@options[:user]) %>;
          <% else %>
              <%# Prevent running Nginx workers as nobody. %>
              user <%= current_user %> <%= default_group_for(current_user) %>;
          <% end %>
      <% end %>
      
      events {
          worker_connections 1024;
      }
      
      http {
          log_format debug '[$time_local] $msec  "$request" $status conn=$connection sent=$bytes_sent body_sent=$body_bytes_sent';
          include '<%= PhusionPassenger.resources_dir %>/mime.types';
          passenger_ruby <%= PlatformInfo.ruby_command %>;
          passenger_root '<%= location_config_filename %>';
          passenger_abort_on_startup_error on;
          passenger_ctl cleanup_pidfiles <%= serialize_strset("#{@temp_dir}/temp_dir_toucher.pid") %>;
          passenger_user_switching off;
          passenger_max_pool_size <%= @options[:max_pool_size] %>;
          passenger_min_instances <%= @options[:min_instances] %>;
          <% if @options[:user] %>
              passenger_user <%= @options[:user] %>;
              passenger_default_user <%= @options[:user] %>;
              passenger_analytics_log_user <%= @options[:user] %>;
          <% else %>
              passenger_user <%= current_user %>;
              passenger_default_user <%= current_user %>;
              passenger_analytics_log_user <%= current_user %>;
          <% end %>
          <% if debugging? %>passenger_log_level 2;<% end %>
          <% if @options[:temp_dir] %>passenger_temp_dir '<%= @options[:temp_dir] %>';<% end %>
          <% if @options[:rolling_restarts] %>passenger_rolling_restarts on;<% end %>
          <% if @options[:resist_deployment_errors] %>passenger_resist_deployment_errors on;<% end %>
          <% if !@options[:load_shell_envvars] %>passenger_load_shell_envvars off;<% end %>
      
          <% if !@options[:friendly_error_pages].nil? -%>
              passenger_friendly_error_pages <%= boolean_config_value(@options[:friendly_error_pages]) %>;
          <% end %>
      
          <% if @options[:union_station_gateway_address] %>
              union_station_gateway_address <%= @options[:union_station_gateway_address] %>;
              union_station_gateway_port <%= @options[:union_station_gateway_port] %>;
              union_station_gateway_cert -;
          <% end %>
          
          default_type application/octet-stream;
          types_hash_max_size 2048;
          server_names_hash_bucket_size 64;
          client_max_body_size 1024m;
          access_log off;
          keepalive_timeout 60;
          underscores_in_headers on;
          gzip on;
          gzip_comp_level 3;
          gzip_min_length 150;
          gzip_proxied any;
          gzip_types text/plain text/css text/json text/javascript \
              application/javascript application/x-javascript application/json \
              application/rss+xml application/vnd.ms-fontobject application/x-font-ttf \
              application/xml font/opentype image/svg+xml text/xml;
          
          <% if @apps.size > 1 %>
          # Default server entry.
          server {
              <% if @options[:ssl] %>
                  <% if @options[:ssl_port] %>
                      listen <%= nginx_listen_address %>;
                      listen <%= nginx_listen_address_with_ssl_port %> ssl;
                  <% else %>
                      listen <%= nginx_listen_address %> ssl;
                  <% end %>
              <% else %>
                  listen <%= nginx_listen_address %>;
              <% end %>
              root '<%= PhusionPassenger.resources_dir %>/standalone_default_root';
          }
          <% end %>
      
          <% if @options[:ping_port] %>
          server {
              listen <%= nginx_listen_address(@options, true) %>;
              root '<%= PhusionPassenger.resources_dir %>/standalone_default_root';
          }
          <% end %>
          
          <% for app in @apps %>

          # Limit the number of connections to 1 per second and allow to burst to 10.
          # Change "burst=10" and "rate=1r/s" as needed.

          limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Load Balanced environments
          #limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments
 
          limit_req zone=application burst=10 nodelay;
          limit_req_status 429;
          limit_conn_status 429;
 
          server {
              # set error page for HTTP code 429
              error_page 429 @ratelimit;
 
              location @ratelimit {
                  return 429 'Connection Limit Exceeded\n';
              }

              <% if app[:ssl] %>
                  <% if app[:ssl_port] %>
                      listen <%= nginx_listen_address(app) %>;
                      listen <%= nginx_listen_address_with_ssl_port(app) %> ssl;
                  <% else %>
                      listen <%= nginx_listen_address(app) %> ssl;
                  <% end %>
              <% else %>
                  listen <%= nginx_listen_address(app) %>;
              <% end %>
              server_name <%= app[:server_names].join(' ') %>;
              <% if app[:static_files_dir] %>
                  root '<%= app[:static_files_dir] %>';
              <% else %>
                  root '<%= app[:root] %>/public';
              <% end %>
              passenger_app_root '<%= app[:root] %>';
              passenger_enabled on;
              passenger_app_env <%= app[:environment] %>;
              passenger_spawn_method <%= app[:spawn_method] %>;
              <% if app[:app_type] %>passenger_app_type <%= app[:app_type] %>;<% end %>
              <% if app[:startup_file] %>passenger_startup_file <%= app[:startup_file] %>;<% end %>
              <% if app[:concurrency_model] != DEFAULT_CONCURRENCY_MODEL %>passenger_concurrency_model <%= app[:concurrency_model] %>;<% end %>
              <% if app[:thread_count] != DEFAULT_THREAD_COUNT %>passenger_thread_count <%= app[:thread_count] %>;<% end %>
              <% if app[:min_instances] %>passenger_min_instances <%= app[:min_instances] %>;<% end %>
              <% if app[:restart_dir] %>passenger_restart_dir '<%= app[:restart_dir] %>';<% end %>
              <% if @options[:sticky_sessions] %>passenger_sticky_sessions on;<% end %>
              <% if @options[:sticky_sessions_cookie_name] %>passenger_sticky_sessions_cookie_name '<%= sticky_sessions_cookie_name %>';<% end %>
              <% if app[:union_station_key] %>
                  union_station_support on;
                  union_station_key <%= app[:union_station_key] %>;
              <% end %>
              <% if app[:ssl] %>
                  ssl_certificate <%= app[:ssl_certificate] %>;
                  ssl_certificate_key <%= app[:ssl_certificate_key] %>;
              <% end %>
      
              location / {
                  passenger_enabled on;
              }

              # Rails asset pipeline support.
              location ~ "^/assets/.+-[0-9a-f]{32}\..+" {
                  error_page 490 = @static_asset;
                  error_page 491 = @dynamic_request;
                  recursive_error_pages on;
      
                  if (-f $request_filename) {
                      return 490;
                  }
                  if (!-f $request_filename) {
                      return 491;
                  }
              }
              location @static_asset {
                  gzip_static on;
                  expires max;
                  add_header Cache-Control public;
                  add_header ETag "";
              }
              location @dynamic_request {
                  passenger_enabled on;
              }
          }
          passenger_pre_start http://<%= nginx_listen_address(app) %>;
          <% end %>                                                                                                                                                                                                           }

container_commands:
  99_restart_passenger:
    command: "service passenger restart"



# set error page for HTTP code 429
error_page 429 @ratelimit;

location @ratelimit {
    return 429 'Connection Limit Exceeded\n';
}



# Limit the number of connections to 1 per second and allow to burst to 10.
# Change "burst=10" and "rate=1r/s" as needed.

limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Elastic Load Balanced environments
#limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments
limit_req zone=application burst=10 nodelay;
limit_req_status 429;
limit_conn_status 429;

# pass real IP from client to NGINX
real_ip_header X-Forwarded-For;
set_real_ip_from 0.0.0.0/0;



LoadModule security2_module modules/mod_security2.so
LoadModule unique_id_module modules/mod_unique_id.so

<IfModule mod_security2.c>

SecRuleEngine On
SecStatusEngine Off

<LocationMatch "^/">
    # The header to use for tracking source ip addresses. Use "X-Forwarded-For" for Load Balanced environments and "REMOTE_ADDR" for Single instance.
    SecAction initcol:ip=%{REQUEST_HEADERS:X-Forwarded-For,pass,nolog,id:11
    #SecAction initcol:ip=%{REQUEST_HEADERS:REMOTE_ADDR,pass,nolog,id:11
    SecAction "phase:5,deprecatevar:ip.awscounter=1/1,pass,nolog,id:12"
    SecRule IP:AWSCOUNTER "@gt 10" "phase:2,deny,status:509,setenv:RATELIMITED,skip:1,log,id:13"
    SecAction "phase:2,pass,setvar:ip.awscounter=+1,nolog,id:14"
</LocationMatch>

SecDebugLogLevel 0
SecDataDir /tmp

ErrorDocument 509 "Connection Limit Exceeded"

</IfModule>



packages:
  yum:
    mod_security: []



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Apache for PHP environments to rate limit the amount of 
#### unique inbound connections to 1 connection per second with a burst of 10.
#### 
#### Note there are different HTTP headers used by Apache for Load Balanced and Single Instance 
#### Environments for detecting the source IP address. Load Balanced environments will use the
#### "HTTP_X_FORWARDED_FOR" header and Single Instance will use "REMOTE_ADDR". Configure this for
#### your environment below on line "Define src_header".
###################################################################################################

packages:
  yum:
    mod24_security: []

files:
  "/etc/httpd/conf.d/mod_security.conf" :
    mode: "000644"
    owner: root
    group: root
    content: |
      # The amount of connections per second.
      Define cons_per_sec 1
      # The amount of connections that a single remote ip can burst to.
      Define cons_burst 10
      # The header to use for tracking source ip addresses. Use "X-Forwarded-For" for Load Balanced environments and "REMOTE_ADDR" for Single instance.
      Define src_header X-Forwarded-For
      #Define src_header REMOTE_ADDR

      <IfModule mod_security2.c>

      SecRuleEngine On
      SecStatusEngine Off

      <LocationMatch "^/">
          SecAction initcol:ip=%{REQUEST_HEADERS:${src_header},pass,nolog,id:11
          SecAction "phase:5,deprecatevar:ip.awscounter=${cons_per_sec}/1,pass,nolog,id:12"
          SecRule IP:AWSCOUNTER "@gt ${cons_burst}" "phase:2,deny,status:429,setenv:RATELIMITED,skip:1,log,id:13"
          SecAction "phase:2,pass,setvar:ip.awscounter=+1,nolog,id:14"
      </LocationMatch>

      SecDebugLogLevel 0
      SecDataDir /tmp

      ErrorDocument 429 "Connection Limit Exceeded"

      </IfModule>



# set error page for HTTP code 429
error_page 429 @ratelimit;

location @ratelimit {
    return 429 'Connection Limit Exceeded\n';
}



# Limit the number of connections to 1 per second and allow to burst to 10.
# Change "burst=10" and "rate=1r/s" as needed.

limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Load Balanced environments
# limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments
limit_req zone=application burst=10 nodelay;
limit_req_status 429;
limit_conn_status 429;

# pass real IP from client to Nginx
real_ip_header X-Forwarded-For;
set_real_ip_from 0.0.0.0/0;



# set error page for HTTP code 429
error_page 429 @ratelimit;

location @ratelimit {
    return 429 'Connection Limit Exceeded\n';
}



# Limit the number of connections to 1 per second and allow to burst to 10.
# Change "burst=10" and "rate=1r/s" as needed.

# limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Elastic Load Balanced environments
limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments
limit_req zone=application burst=10 nodelay;
limit_req_status 429;
limit_conn_status 429;

# pass real IP from client to Nginx
real_ip_header X-Forwarded-For;
set_real_ip_from 0.0.0.0/0;



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Apache for Python environments to rate limit the amount of 
#### unique inbound connections to 1 connection per second with a burst of 10.
#### 
#### Note there are different HTTP headers used by Apache for Load Balanced and Single Instance 
#### Environments for detecting the source IP address. Load Balanced environments will use the
#### "HTTP_X_FORWARDED_FOR" header and Single Instance will use "REMOTE_ADDR". Configure this for
#### your environment below on line "Define src_header".
###################################################################################################

packages:
  yum:
    mod24_security: []

files:
  "/etc/httpd/conf.d/mod_security.conf" :
    mode: "000644"
    owner: root
    group: root
    content: |
      # The amount of connections per second.
      Define cons_per_sec 1
      # The amount of connections that a single remote ip can burst to.
      Define cons_burst 10
      # The header to use for tracking source ip addresses. Use "X-Forwarded-For" for Load Balanced environments and "REMOTE_ADDR" for Single instance.
      Define src_header X-Forwarded-For
      #Define src_header REMOTE_ADDR

      <IfModule mod_security2.c>

      SecRuleEngine On
      SecStatusEngine Off

      <LocationMatch "^/">
          SecAction initcol:ip=%{REQUEST_HEADERS:${src_header},pass,nolog,id:11
          SecAction "phase:5,deprecatevar:ip.awscounter=${cons_per_sec}/1,pass,nolog,id:12"
          SecRule IP:AWSCOUNTER "@gt ${cons_burst}" "phase:2,deny,status:429,setenv:RATELIMITED,skip:1,log,id:13"
          SecAction "phase:2,pass,setvar:ip.awscounter=+1,nolog,id:14"
      </LocationMatch>

      SecDebugLogLevel 0
      SecDataDir /tmp

      ErrorDocument 429 "Connection Limit Exceeded"

      </IfModule>



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Nginx for Single Container Docker environments to rate limit
#### the amount of unique inbound connections to 1 connection per second with a burst of 10.
####
#### Note there are different HTTP headers used by Nginx for Load Balanced and Single Instance 
#### Environments for detecting the source IP address. Load Balanced environments will use the
#### "HTTP_X_FORWARDED_FOR" header and Single Instance will use "REMOTE_ADDR". Configure this for
#### your environment below on the line "limit_req_zone".
###################################################################################################

files:
   "/etc/nginx/conf.d/rate-limit.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       # limit the number of connections to 1 per second and allow to burst to 10
       limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Load Balanced environments
       #limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments

       limit_req zone=application burst=10 nodelay;
       limit_req_status 429;
       limit_conn_status 429;

       # pass real IP from client to NGINX
       real_ip_header X-Forwarded-For;
       set_real_ip_from 0.0.0.0/0;

       server {
           # set error page for HTTP code 429
           error_page 429 @ratelimit;

           location @ratelimit {
               return 429 'Connection Limit Exceeded\n';
           }
       }



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Nginx for Ruby Puma environments to rate limit the amount of 
#### unique inbound connections to 1 connection per second with a burst of 10.
####
#### Note there are different HTTP headers used by Nginx for Load Balanced and Single Instance 
#### Environments for detecting the source IP address. Load Balanced environments will use the
#### "HTTP_X_FORWARDED_FOR" header and Single Instance will use "REMOTE_ADDR". Configure this for
#### your environment below on the line "limit_req_zone".
###################################################################################################

files:
   "/etc/nginx/conf.d/rate-limit.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       # limit the number of connections to 1 per second and allow to burst to 10
       limit_req_zone $http_x_forwarded_for zone=application:10m rate=1r/s; # For Load Balanced environments
       #limit_req_zone $remote_addr zone=application:10m rate=1r/s; # For Single Instance environments
       limit_req zone=application burst=10 nodelay;
       limit_req_status 429;
       limit_conn_status 429;

       # pass real IP from client to NGINX
       real_ip_header X-Forwarded-For;
       set_real_ip_from 0.0.0.0/0;
       
       server {
         # set error page for HTTP code 429
         error_page 429 @ratelimit;

         location @ratelimit {
             return 429 'Connection Limit Exceeded\n';
         }
       }

container_commands:
  99_restart_nginx:
    command: "service nginx restart"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file installs the SSL intermediate and root certificates for 
#### RDS into the root Java installation so that your Java Tomcat Elastic Beanstalk 
#### can securely talk to an RDS database over SSL using standard JDBC mechanisms.
####
#### For more details, see:
#### http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html
####
#### To connect to an RDS database in a different region than your Elastic Beanstalk application,
#### you may change the "APP_REGION" value to be a specific region.
####
#### NOTE: The mechanism for connecting to an RDS database over SSL varies by provider, so make 
#### sure to consult the RDS documentation.
###################################################################################################

option_settings:
  aws:elasticbeanstalk:application:environment:
    APP_REGION: '`{"Ref": "AWS::Region"}`'

##############################################
#### Do not modify values below this line ####
##############################################
    
commands:
  01_install:
    command: "/tmp/install-rds-ssl-certs.sh"

files:
  "/tmp/install-rds-ssl-certs.sh":
      mode: "000755"
      content : |
        #!/bin/bash

        APP_REGION=$(/opt/elasticbeanstalk/bin/get-config environment -k APP_REGION)
        if [ -z "$APP_REGION" ]; then
                echo "Could not determine proper environment region!"
                exit 1
        fi
        echo "Detected current region as $APP_REGION..."

        RDS_ROOT_ALIAS="rds_root"
        RDS_ROOT_LOCAL_FILE="/tmp/rds-ca-2019-root.pem"
        RDS_REGION_ALIAS="rds_${APP_REGION}"
        RDS_REGION_LOCAL_FILE="/tmp/rds-ca-2019-${APP_REGION}.pem"
        JAVA_KEYSTORE_PASSWORD="changeit"

        #via http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html
        ROOT_RDS_CERT_URL="https://s3.amazonaws.com/rds-downloads/rds-ca-2019-root.pem"
        REGION_RDS_CERT_URL="https://s3.amazonaws.com/rds-downloads/rds-ca-2019-${APP_REGION}.pem"

        if [ -z "$JAVA_HOME" ]; then
                echo "JAVA_HOME was not set. Setting to default of /usr/lib/jvm/jre..."
                export JAVA_HOME=/usr/lib/jvm/jre
        fi
        
        JAVA_KEYSTORE_FILE="$JAVA_HOME/lib/security/cacerts"

        echo "Attempting to remove any previously installed RDS SSL certificates (and ignoring errors)..."

        $JAVA_HOME/bin/keytool -delete -alias $RDS_ROOT_ALIAS -storepass $JAVA_KEYSTORE_PASSWORD -noprompt -keystore $JAVA_KEYSTORE_FILE
        $JAVA_HOME/bin/keytool -delete -alias $RDS_REGION_ALIAS -storepass $JAVA_KEYSTORE_PASSWORD -noprompt -keystore $JAVA_KEYSTORE_FILE

        echo "Downloading ${ROOT_RDS_CERT_URL}..."
        curl $ROOT_RDS_CERT_URL > $RDS_ROOT_LOCAL_FILE
        if [ $? -ne 0 ]; then
                echo "ERROR: Could not download RDS root certificate!"
                exit 1
        fi

        echo "Downloading ${REGION_RDS_CERT_URL}..."
        curl $REGION_RDS_CERT_URL > $RDS_REGION_LOCAL_FILE
        if [ $? -ne 0 ]; then
                echo "ERROR: Could not download RDS regional certificate!"
                exit 1
        fi

        #Installing new certs to the keystore requires root permissions
        echo 'Installing downloaded RDS certificates into Java keystore...'

        $JAVA_HOME/bin/keytool -import -alias $RDS_ROOT_ALIAS -storepass $JAVA_KEYSTORE_PASSWORD -noprompt -keystore $JAVA_KEYSTORE_FILE -file $RDS_ROOT_LOCAL_FILE
        if [ $? -ne 0 ]; then
                echo "ERROR: Could not install RDS root certificate!"
                exit 1
        fi
        echo 'RDS root certificate installed successfully!'

        $JAVA_HOME/bin/keytool -import -alias $RDS_REGION_ALIAS -storepass $JAVA_KEYSTORE_PASSWORD -noprompt -keystore $JAVA_KEYSTORE_FILE -file $RDS_REGION_LOCAL_FILE
        if [ $? -ne 0 ]; then
                echo "ERROR: Could not install RDS regional certificate!"
                exit 1
        fi
        echo 'RDS regional certificate installed successfully!'



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Apache for Node.js environments to redirect HTTP
#### requests on port 80 to HTTPS on port 443 after you have configured your environment to support
#### HTTPS connections.
####
#### Note the default reverse proxy for Node.js is Nginx. To enable Apache; example:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_nodejs.container.html#nodejs-platform-configfiles
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
#### Terminating HTTPS on EC2 Instances Running Node.js:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-nodejs.html
###################################################################################################

files:
  "/etc/httpd/conf.d/http-redirect.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      RewriteEngine On
      RewriteCond %{HTTP:X-Forwarded-Proto} !https
      RewriteCond %{HTTP_USER_AGENT} !ELB-HealthChecker
      RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Nginx for Node.js environments to redirect HTTP
#### requests on port 80 to HTTPS on port 443 after you have configured your environment to support
#### HTTPS connections:
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
#### Terminating HTTPS on EC2 Instances Running Node.js:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-nodejs.html
###################################################################################################

files:
   /etc/nginx/conf.d/proxy.conf:
     owner: root
     group: root
     mode: "000644"
     content: |
       # Elastic Beanstalk Managed
       
       # Elastic Beanstalk managed configuration file
       # Some configuration of nginx can be by placing files in /etc/nginx/conf.d
       # using Configuration Files.
       # http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers.html 
       
       
       upstream nodejs {
           server 127.0.0.1:8081;
           keepalive 256;
       }
       
       server {
           listen 8080;
       
       
           if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
               set $year $1;
               set $month $2;
               set $day $3;
               set $hour $4;
           }
           access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
           access_log  /var/log/nginx/access.log  main;
       
       
           location / {
               set $redirect 0;
               if ($http_x_forwarded_proto != "https") {
                 set $redirect 1;
               }
               if ($http_user_agent ~* "ELB-HealthChecker") {
                 set $redirect 0;
               }
               if ($redirect = 1) {
                 return 301 https://$host$request_uri;
               }
       
               proxy_pass  http://nodejs;
               proxy_set_header   Connection "";
               proxy_http_version 1.1;
               proxy_set_header        Host            $host;
               proxy_set_header        X-Real-IP       $remote_addr;
               proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
           }
       
       gzip on;
       gzip_comp_level 4;
       gzip_types text/html text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
       
       }

   /opt/elasticbeanstalk/hooks/configdeploy/post/99_kill_default_nginx.sh:
     owner: root
     group: root
     mode: "000755"
     content: |
       #!/bin/bash -xe
       rm -f /etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf
       if [[ -e /etc/init/nginx.conf ]] ; then
         echo Using initctl to stop and start nginx
         initctl stop nginx || true
         initctl start nginx
       else
         echo Using service to stop and start nginx
         service nginx stop 
         service nginx start
       fi
 
container_commands:
  removeconfig:
    command: "rm -f /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf /etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures IIS for .NET environments to redirect HTTP requests on
#### port 80 to HTTPS on port 443 after you have configured your environment to support HTTPS
#### connections:
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
###################################################################################################

files:
  "C:\\Windows\\Temp\\ELB_HTTP_redirect.cmd":
    content: |
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /-"[name='ELB_HTTP_redirect']" > C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /+"[name='ELB_HTTP_redirect',enabled='true',stopProcessing='true']" >> C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /"[name='ELB_HTTP_redirect'].match.url:"^^(.*)$"" >> C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /+"[name='ELB_HTTP_redirect'].conditions.[input='{HTTP_X_FORWARDED_PROTO}',pattern='^https$',negate='true']" >> C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /+"[name='ELB_HTTP_redirect'].conditions.[input='{HTTP_USER_AGENT}',pattern='ELB-HealthChecker',negate='true']" >> C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /"[name='ELB_HTTP_redirect'].action.type:"Redirect"" /"[name='ELB_HTTP_redirect'].action.url:"https://{SERVER_NAME}{URL}"" >> C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1
      iisreset >> C:\Windows\Temp\ELB_HTTP_redirect.log 2>&1

commands:
  00-http_redirect:
    command: "C:\\Windows\\Temp\\ELB_HTTP_redirect.cmd"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures IIS for .NET environments to redirect HTTP requests on
#### port 80 to HTTPS on port 443 after you have configured your environment to support HTTPS
#### connections:
####
#### Terminating HTTPS on EC2 Instances Running .NET:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/SSLNET.SingleInstance.html
###################################################################################################

files:
  "C:\\Windows\\Temp\\HTTP_redirect.cmd":
    content: |
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /-"[name='HTTP_redirect']" >> log.txt 2>&1 && time /t >> log.txt
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /+"[name='HTTP_redirect',enabled='true',stopProcessing='true']" >> log.txt 2>&1 && time /t >> log.txt
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /"[name='HTTP_redirect'].match.url:"^^(.*)$"" >> log.txt 2>&1 && time /t >> log.txt
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /+"[name='HTTP_redirect'].conditions.[input='{HTTPS}',pattern='^OFF$']" >> log.txt 2>&1 && time /t >> log.txt
      C:\Windows\System32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/rewrite/rules /"[name='HTTP_redirect'].action.type:"Redirect"" /"[name='HTTP_redirect'].action.url:"https://{SERVER_NAME}{URL}"" >> log.txt 2>&1 && time /t >> log.txt

commands:
  00-http_redirect:
    command: "C:\\Windows\\Temp\\HTTP_redirect.cmd"



{
   "nginx_config_template" : "/opt/elasticbeanstalk/support/conf/http-redirection.erb"
}



files:
  "/opt/elasticbeanstalk/support/conf/http-redirection.erb":
    owner: root
    group: root
    mode: "000644"
    content: |
      ##############################################################
      #  Phusion Passenger Standalone uses a template file to
      #  generate an Nginx configuration file. The original template
      #  file can be found by running the following command:
      #
      #    ls $(passenger-config about resourcesdir)/templates/standalone/config.erb
      #
      #  You can create a copy of this template file and customize it
      #  to your liking. Just make sure you tell Phusion Passenger Standalone
      #  to use your template file by passing the --nginx-config-template
      #  parameter.
      #
      #  *** NOTE ***
      #  If you customize the template file, make sure you keep an eye
      #  on the original template file and merge any changes.
      #  New Phusion Passenger features may require changes to the template
      #  file.
      ##############################################################
      
      
      master_process on;
      worker_processes 1;
      daemon on;
      error_log '<%= @options[:log_file] %>' <% if debugging? %>info<% end %>;
      pid '<%= @options[:pid_file] %>';
      
      <% if Process.euid == 0 %>
          <% if @options[:user] %>
              <%# Run workers as the given user. The master process will always run as root and will be able to bind to any port. %>
              user <%= @options[:user] %> <%= default_group_for(@options[:user]) %>;
          <% else %>
              <%# Prevent running Nginx workers as nobody. %>
              user <%= current_user %> <%= default_group_for(current_user) %>;
          <% end %>
      <% end %>
      
      events {
          worker_connections 1024;
      }
      
      http {
          log_format debug '[$time_local] $msec  "$request" $status conn=$connection sent=$bytes_sent body_sent=$body_bytes_sent';
          include '<%= PhusionPassenger.resources_dir %>/mime.types';
          passenger_ruby <%= PlatformInfo.ruby_command %>;
          passenger_root '<%= location_config_filename %>';
          passenger_abort_on_startup_error on;
          passenger_ctl cleanup_pidfiles <%= serialize_strset("#{@temp_dir}/temp_dir_toucher.pid") %>;
          passenger_user_switching off;
          passenger_max_pool_size <%= @options[:max_pool_size] %>;
          passenger_min_instances <%= @options[:min_instances] %>;
          <% if @options[:user] %>
              passenger_user <%= @options[:user] %>;
              passenger_default_user <%= @options[:user] %>;
              passenger_analytics_log_user <%= @options[:user] %>;
          <% else %>
              passenger_user <%= current_user %>;
              passenger_default_user <%= current_user %>;
              passenger_analytics_log_user <%= current_user %>;
          <% end %>
          <% if debugging? %>passenger_log_level 2;<% end %>
          <% if @options[:temp_dir] %>passenger_temp_dir '<%= @options[:temp_dir] %>';<% end %>
          <% if @options[:rolling_restarts] %>passenger_rolling_restarts on;<% end %>
          <% if @options[:resist_deployment_errors] %>passenger_resist_deployment_errors on;<% end %>
          <% if !@options[:load_shell_envvars] %>passenger_load_shell_envvars off;<% end %>
      
          <% if !@options[:friendly_error_pages].nil? -%>
              passenger_friendly_error_pages <%= boolean_config_value(@options[:friendly_error_pages]) %>;
          <% end %>
      
          <% if @options[:union_station_gateway_address] %>
              union_station_gateway_address <%= @options[:union_station_gateway_address] %>;
              union_station_gateway_port <%= @options[:union_station_gateway_port] %>;
              union_station_gateway_cert -;
          <% end %>
          
          default_type application/octet-stream;
          types_hash_max_size 2048;
          server_names_hash_bucket_size 64;
          client_max_body_size 1024m;
          access_log off;
          keepalive_timeout 60;
          underscores_in_headers on;
          gzip on;
          gzip_comp_level 3;
          gzip_min_length 150;
          gzip_proxied any;
          gzip_types text/plain text/css text/json text/javascript \
              application/javascript application/x-javascript application/json \
              application/rss+xml application/vnd.ms-fontobject application/x-font-ttf \
              application/xml font/opentype image/svg+xml text/xml;
          
          <% if @apps.size > 1 %>
          # Default server entry.
          server {
              <% if @options[:ssl] %>
                  <% if @options[:ssl_port] %>
                      listen <%= nginx_listen_address %>;
                      listen <%= nginx_listen_address_with_ssl_port %> ssl;
                  <% else %>
                      listen <%= nginx_listen_address %> ssl;
                  <% end %>
              <% else %>
                  listen <%= nginx_listen_address %>;
              <% end %>
              root '<%= PhusionPassenger.resources_dir %>/standalone_default_root';
          }
          <% end %>
      
          <% if @options[:ping_port] %>
          server {
              listen <%= nginx_listen_address(@options, true) %>;
              root '<%= PhusionPassenger.resources_dir %>/standalone_default_root';
          }
          <% end %>
          
          <% for app in @apps %>
          server {
              <% if app[:ssl] %>
                  <% if app[:ssl_port] %>
                      listen <%= nginx_listen_address(app) %>;
                      listen <%= nginx_listen_address_with_ssl_port(app) %> ssl;
                  <% else %>
                      listen <%= nginx_listen_address(app) %> ssl;
                  <% end %>
              <% else %>
                  listen <%= nginx_listen_address(app) %>;
              <% end %>
              server_name <%= app[:server_names].join(' ') %>;
              <% if app[:static_files_dir] %>
                  root '<%= app[:static_files_dir] %>';
              <% else %>
                  root '<%= app[:root] %>/public';
              <% end %>
              passenger_app_root '<%= app[:root] %>';
              passenger_enabled on;
              passenger_app_env <%= app[:environment] %>;
              passenger_spawn_method <%= app[:spawn_method] %>;
              <% if app[:app_type] %>passenger_app_type <%= app[:app_type] %>;<% end %>
              <% if app[:startup_file] %>passenger_startup_file <%= app[:startup_file] %>;<% end %>
              <% if app[:concurrency_model] != DEFAULT_CONCURRENCY_MODEL %>passenger_concurrency_model <%= app[:concurrency_model] %>;<% end %>
              <% if app[:thread_count] != DEFAULT_THREAD_COUNT %>passenger_thread_count <%= app[:thread_count] %>;<% end %>
              <% if app[:min_instances] %>passenger_min_instances <%= app[:min_instances] %>;<% end %>
              <% if app[:restart_dir] %>passenger_restart_dir '<%= app[:restart_dir] %>';<% end %>
              <% if @options[:sticky_sessions] %>passenger_sticky_sessions on;<% end %>
              <% if @options[:sticky_sessions_cookie_name] %>passenger_sticky_sessions_cookie_name '<%= sticky_sessions_cookie_name %>';<% end %>
              <% if app[:union_station_key] %>
                  union_station_support on;
                  union_station_key <%= app[:union_station_key] %>;
              <% end %>
              <% if app[:ssl] %>
                  ssl_certificate <%= app[:ssl_certificate] %>;
                  ssl_certificate_key <%= app[:ssl_certificate_key] %>;
              <% end %>
      
              set $redirect 0;
              location / {
                  if ($http_x_forwarded_proto != "https") {
                    set $redirect 1;
                  }
                  if ($http_user_agent ~* "ELB-HealthChecker") {
                    set $redirect 0;
                  }
                  if ($redirect = 1) {
                    return 301 https://$host$request_uri;
                  }
                  passenger_enabled on;
              }

              # Rails asset pipeline support.
              location ~ "^/assets/.+-[0-9a-f]{32}\..+" {
                  if ($http_x_forwarded_proto != "https") {
                    set $redirect 1;
                  }
                  if ($http_user_agent ~* "ELB-HealthChecker") {
                    set $redirect 0;
                  }
                  if ($redirect = 1) {
                    return 301 https://$host$request_uri;
                  }

                  error_page 490 = @static_asset;
                  error_page 491 = @dynamic_request;
                  recursive_error_pages on;
      
                  if (-f $request_filename) {
                      return 490;
                  }
                  if (!-f $request_filename) {
                      return 491;
                  }
              }
              location @static_asset {
                  gzip_static on;
                  expires max;
                  add_header Cache-Control public;
                  add_header ETag "";
              }
              location @dynamic_request {
                  passenger_enabled on;
              }
          }
          passenger_pre_start http://<%= nginx_listen_address(app) %>;
          <% end %>                                                                                                                                                                                                           }

container_commands:
  99_restart_passenger:
    command: "service passenger restart || service passenger start"



{
  "nginx_config_template" : "/opt/elasticbeanstalk/support/conf/http-redirection.erb",
}



files:
  "/opt/elasticbeanstalk/support/conf/http-redirection.erb":
    owner: root
    group: root
    mode: "000644"
    content: |
      ##############################################################
      #  Phusion Passenger Standalone uses a template file to
      #  generate an Nginx configuration file. The original template
      #  file can be found by running the following command:
      #
      #    ls $(passenger-config about resourcesdir)/templates/standalone/config.erb
      #
      #  You can create a copy of this template file and customize it
      #  to your liking. Just make sure you tell Phusion Passenger Standalone
      #  to use your template file by passing the --nginx-config-template
      #  parameter.
      #
      #  *** NOTE ***
      #  If you customize the template file, make sure you keep an eye
      #  on the original template file and merge any changes.
      #  New Phusion Passenger features may require changes to the template
      #  file.
      ##############################################################
      
      
      master_process on;
      worker_processes 1;
      daemon on;
      error_log '<%= @options[:log_file] %>' <% if debugging? %>info<% end %>;
      pid '<%= @options[:pid_file] %>';
      
      <% if Process.euid == 0 %>
          <% if @options[:user] %>
              <%# Run workers as the given user. The master process will always run as root and will be able to bind to any port. %>
              user <%= @options[:user] %> <%= default_group_for(@options[:user]) %>;
          <% else %>
              <%# Prevent running Nginx workers as nobody. %>
              user <%= current_user %> <%= default_group_for(current_user) %>;
          <% end %>
      <% end %>
      
      events {
          worker_connections 1024;
      }
      
      http {
          log_format debug '[$time_local] $msec  "$request" $status conn=$connection sent=$bytes_sent body_sent=$body_bytes_sent';
          include '<%= PhusionPassenger.resources_dir %>/mime.types';
          passenger_ruby <%= PlatformInfo.ruby_command %>;
          passenger_root '<%= location_config_filename %>';
          passenger_abort_on_startup_error on;
          passenger_ctl cleanup_pidfiles <%= serialize_strset("#{@temp_dir}/temp_dir_toucher.pid") %>;
          passenger_user_switching off;
          passenger_max_pool_size <%= @options[:max_pool_size] %>;
          passenger_min_instances <%= @options[:min_instances] %>;
          <% if @options[:user] %>
              passenger_user <%= @options[:user] %>;
              passenger_default_user <%= @options[:user] %>;
              passenger_analytics_log_user <%= @options[:user] %>;
          <% else %>
              passenger_user <%= current_user %>;
              passenger_default_user <%= current_user %>;
              passenger_analytics_log_user <%= current_user %>;
          <% end %>
          <% if debugging? %>passenger_log_level 2;<% end %>
          <% if @options[:temp_dir] %>passenger_temp_dir '<%= @options[:temp_dir] %>';<% end %>
          <% if @options[:rolling_restarts] %>passenger_rolling_restarts on;<% end %>
          <% if @options[:resist_deployment_errors] %>passenger_resist_deployment_errors on;<% end %>
          <% if !@options[:load_shell_envvars] %>passenger_load_shell_envvars off;<% end %>
      
          <% if !@options[:friendly_error_pages].nil? -%>
              passenger_friendly_error_pages <%= boolean_config_value(@options[:friendly_error_pages]) %>;
          <% end %>
      
          <% if @options[:union_station_gateway_address] %>
              union_station_gateway_address <%= @options[:union_station_gateway_address] %>;
              union_station_gateway_port <%= @options[:union_station_gateway_port] %>;
              union_station_gateway_cert -;
          <% end %>
          
          default_type application/octet-stream;
          types_hash_max_size 2048;
          server_names_hash_bucket_size 64;
          client_max_body_size 1024m;
          access_log off;
          keepalive_timeout 60;
          underscores_in_headers on;
          gzip on;
          gzip_comp_level 3;
          gzip_min_length 150;
          gzip_proxied any;
          gzip_types text/plain text/css text/json text/javascript \
              application/javascript application/x-javascript application/json \
              application/rss+xml application/vnd.ms-fontobject application/x-font-ttf \
              application/xml font/opentype image/svg+xml text/xml;
          
          <% if @apps.size > 1 %>
          # Default server entry.
          server {
              <% if @options[:ssl] %>
                  <% if @options[:ssl_port] %>
                      listen <%= nginx_listen_address %>;
                      listen <%= nginx_listen_address_with_ssl_port %> ssl;
                  <% else %>
                      listen <%= nginx_listen_address %> ssl;
                  <% end %>
              <% else %>
                  listen <%= nginx_listen_address %>;
              <% end %>
              root '<%= PhusionPassenger.resources_dir %>/standalone_default_root';
          }
          <% end %>
      
          <% if @options[:ping_port] %>
          server {
              listen <%= nginx_listen_address(@options, true) %>;
              root '<%= PhusionPassenger.resources_dir %>/standalone_default_root';
          }
          <% end %>
          
          <% for app in @apps %>
          server {
              <% if app[:ssl] %>
                  <% if app[:ssl_port] %>
                      listen <%= nginx_listen_address(app) %>;
                      listen <%= nginx_listen_address_with_ssl_port(app) %> ssl;
                  <% else %>
                      listen <%= nginx_listen_address(app) %> ssl;
                  <% end %>
              <% else %>
                  listen <%= nginx_listen_address(app) %>;
              <% end %>
              server_name <%= app[:server_names].join(' ') %>;
              <% if app[:static_files_dir] %>
                  root '<%= app[:static_files_dir] %>';
              <% else %>
                  root '<%= app[:root] %>/public';
              <% end %>
              passenger_app_root '<%= app[:root] %>';
              passenger_enabled on;
              passenger_app_env <%= app[:environment] %>;
              passenger_spawn_method <%= app[:spawn_method] %>;
              <% if app[:app_type] %>passenger_app_type <%= app[:app_type] %>;<% end %>
              <% if app[:startup_file] %>passenger_startup_file <%= app[:startup_file] %>;<% end %>
              <% if app[:concurrency_model] != DEFAULT_CONCURRENCY_MODEL %>passenger_concurrency_model <%= app[:concurrency_model] %>;<% end %>
              <% if app[:thread_count] != DEFAULT_THREAD_COUNT %>passenger_thread_count <%= app[:thread_count] %>;<% end %>
              <% if app[:min_instances] %>passenger_min_instances <%= app[:min_instances] %>;<% end %>
              <% if app[:restart_dir] %>passenger_restart_dir '<%= app[:restart_dir] %>';<% end %>
              <% if @options[:sticky_sessions] %>passenger_sticky_sessions on;<% end %>
              <% if @options[:sticky_sessions_cookie_name] %>passenger_sticky_sessions_cookie_name '<%= sticky_sessions_cookie_name %>';<% end %>
              <% if app[:union_station_key] %>
                  union_station_support on;
                  union_station_key <%= app[:union_station_key] %>;
              <% end %>
              <% if app[:ssl] %>
                  ssl_certificate <%= app[:ssl_certificate] %>;
                  ssl_certificate_key <%= app[:ssl_certificate_key] %>;
              <% end %>
      
              set $redirect 0;
              location / {
                  if ($server_port = 80) {
                    return 301 https://$host$request_uri;
                  }
                  passenger_enabled on;
              }

              # Rails asset pipeline support.
              location ~ "^/assets/.+-[0-9a-f]{32}\..+" {
                  if ($server_port = 80) {
                    return 301 https://$host$request_uri;
                  }

                  error_page 490 = @static_asset;
                  error_page 491 = @dynamic_request;
                  recursive_error_pages on;
      
                  if (-f $request_filename) {
                      return 490;
                  }
                  if (!-f $request_filename) {
                      return 491;
                  }
              }
              location @static_asset {
                  gzip_static on;
                  expires max;
                  add_header Cache-Control public;
                  add_header ETag "";
              }
              location @dynamic_request {
                  passenger_enabled on;
              }
          }
          passenger_pre_start http://<%= nginx_listen_address(app) %>;
          <% end %>                                                                                                                                                                                                           }

container_commands:
  99_restart_passenger:
    command: "service passenger restart || service passenger start"



location / {
      set $redirect 0;
      if ($http_x_forwarded_proto != "https") {
        set $redirect 1;
      }
      if ($http_user_agent ~* "ELB-HealthChecker") {
        set $redirect 0;
      }
      if ($redirect = 1) {
        return 301 https://$host$request_uri;
      }   
  
      proxy_pass          http://127.0.0.1:8080;
      proxy_http_version  1.1;
  
      proxy_set_header    Connection          $connection_upgrade;
      proxy_set_header    Upgrade             $http_upgrade;
      proxy_set_header    Host                $host;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
}



<VirtualHost *:80>
   LoadModule rewrite_module modules/mod_rewrite.so
 
   RewriteEngine On
   RewriteCond %{HTTP:X-Forwarded-Proto} !https
   RewriteCond %{HTTP_USER_AGENT} !ELB-HealthChecker
   RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
 
   <Proxy *>
     Order deny,allow
     Allow from all
   </Proxy>
 
   ProxyPass / http://localhost:8080/ retry=0
   ProxyPassReverse / http://localhost:8080/
   ProxyPreserveHost on
 
   ErrorLog /var/log/httpd/elasticbeanstalk-error_log
 
</VirtualHost>



<VirtualHost *:80>
   LoadModule rewrite_module modules/mod_rewrite.so
 
   RewriteEngine On
   RewriteCond %{HTTP:X-Forwarded-Proto} !https
   RewriteCond %{HTTP_USER_AGENT} !ELB-HealthChecker
   RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
 
   <Proxy *>
     Require all granted
   </Proxy>
 
   ProxyPass / http://localhost:8080/ retry=0
   ProxyPassReverse / http://localhost:8080/
   ProxyPreserveHost on
 
   ErrorLog /var/log/httpd/elasticbeanstalk-error_log
 
</VirtualHost>



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Apache for PHP environments to redirect HTTP requests on
#### port 80 to HTTPS on port 443 after you have configured your environment to support HTTPS
#### connections:
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
#### Terminating HTTPS on EC2 Instances Running PHP:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-php.html
###################################################################################################

files:
   /etc/httpd/conf.d/http-redirect.conf:
     mode: "000644"
     owner: root
     group: root
     content: |
       RewriteEngine On
       RewriteCond %{HTTP:X-Forwarded-Proto} !https
       RewriteCond %{HTTP_USER_AGENT} !ELB-HealthChecker
       RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}



location / {
     set $redirect 0;
     if ($http_x_forwarded_proto != "https") {
       set $redirect 1;
     }
     if ($http_user_agent ~* "ELB-HealthChecker") {
       set $redirect 0;
     }
     if ($redirect = 1) {
       return 301 https://$host$request_uri;
     }   
 
     proxy_pass          http://127.0.0.1:5000;
     proxy_http_version  1.1;
 
     proxy_set_header    Connection          $connection_upgrade;
     proxy_set_header    Upgrade             $http_upgrade;
     proxy_set_header    Host                $host;
     proxy_set_header    X-Real-IP           $remote_addr;
     proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
}



location / {
     set $redirect 0;
     if ($http_x_forwarded_proto != "https") {
       set $redirect 1;
     }
     if ($http_user_agent ~* "ELB-HealthChecker") {
       set $redirect 0;
     }
     if ($redirect = 1) {
       return 301 https://$host$request_uri;
     }   
 
     proxy_pass          http://127.0.0.1:5000;
     proxy_http_version  1.1;
 
     proxy_set_header    Connection          $connection_upgrade;
     proxy_set_header    Upgrade             $http_upgrade;
     proxy_set_header    Host                $host;
     proxy_set_header    X-Real-IP           $remote_addr;
     proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
}



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Apache for Python environments to redirect HTTP requests on
#### port 80 to HTTPS on port 443 after you have configured your environment to support HTTPS
#### connections:
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
#### Terminating HTTPS on EC2 Instances Running Python:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-python.html
####
#### Note:
#### This example isn't designed to work with a Django solution.
###################################################################################################

files:
  "/etc/httpd/conf/http-redirect.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      RewriteEngine On
      RewriteCond %{HTTP:X-Forwarded-Proto} !https
      RewriteCond %{HTTP_USER_AGENT} !ELB-HealthChecker
      RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}

  "/opt/elasticbeanstalk/hooks/config.py":
    mode: "000644"
    owner: root
    group: root
    content: |
      import json
      import sys
      import os
      import time
      import shutil
      import urllib2
      import logging
      import ast
      import subprocess
      from subprocess import check_call, call
      from subprocess import Popen, PIPE

      APACHE_TEMPLATE = r'''
      LoadModule wsgi_module modules/mod_wsgi.so
      WSGIPythonHome /opt/python/run/baselinenv
      WSGISocketPrefix run/wsgi
      WSGIRestrictEmbedded On

      <VirtualHost *:%s>
      # Adding an "Include" below rather than the content of "/etc/httpd/conf/http-redirect.conf" as percent characters are intepreted and replaced inside this "/opt/elasticbeanstalk/hooks/config.py" file.
      Include /etc/httpd/conf/http-redirect.conf
      
      %s

      WSGIScriptAlias / %s


      <Directory %s/>
        Require all granted
      </Directory>

      WSGIDaemonProcess wsgi processes=%s threads=%s display-name=%%{GROUP} \
        python-home=/opt/python/run/venv/ \
        python-path=%s user=%s group=%s \
        home=%s
      WSGIProcessGroup wsgi
      </VirtualHost>

      LogFormat "%%h (%%{X-Forwarded-For}i) %%l %%u %%t \"%%r\" %%>s %%b \"%%{Referer}i\" \"%%{User-Agent}i\"" combined

      '''

      ENV_VAR_NAMESPACE = 'aws:elasticbeanstalk:container:python:environment'
      PYCONFIG_NAMESPACE = 'aws:elasticbeanstalk:container:python'
      STATICFILES_NAMESPACE = 'aws:elasticbeanstalk:container:python:staticfiles'

      DEFAULT_ROOTPAGE_CHECK_TIMEOUT = 3 #used for apache root page check timeout
      DEFAULT_RETRY_SLEEP_IN_SECOND = 1 #used for apache root page check sleep

      # Vetted user visible error messages.
      USER_ERROR_MESSAGES = {
          'deployfail': 'Application version failed to deploy.',
          'badappconfig': ("Your application configuration file is invalid. "
                           "Snapshot your logs for details."),
          'badrequirements': ("Your requirements.txt is invalid. Snapshot "
                              "your logs for details."),
          'failedcommands': ("Error running commands specified in your "
                             "application configuration file. Snapshot your "
                             "logs for details."),
          'badoptions': ("The option settings in your application "
                         "configuration file are invalid. Snapshot "
                         "your logs for details."),
          'badwsgipath': 'Your WSGIPath refers to a file that does not exist.',
      }


      log = logging.getLogger('hooks')


      class PythonHooksError(Exception):
          pass


      class ContainerConfigLoader(object):
          def load_config(self):
              pass


      class SimplifiedConfigLoader(ContainerConfigLoader):
          """Converts the configuration into a simpler format."""
          def load_config(self):
              configs = {}
        
              configs['environment'] = get_user_env()
        
              configs['http_port'] = get_container_config('instance_port')
              configs['wsgi_path'] = get_optionsetting('aws:elasticbeanstalk:container:python', 'WSGIPath')
              configs['num_threads'] = int(get_optionsetting('aws:elasticbeanstalk:container:python', 'NumThreads'))
              configs['num_processes'] = int(get_optionsetting('aws:elasticbeanstalk:container:python', 'NumProcesses'))
        
              static_files_optionsetting = ast.literal_eval(get_optionsetting('aws:elasticbeanstalk:container:python:staticfiles', 'PythonStaticFiles'))
              static_files = {}
              for keyval in static_files_optionsetting:
                  key, value = keyval.split('=', 1)
                  static_files[key] = value
              configs['static_files'] = static_files
        
              return configs


      def get_user_env():
          return json.loads(execute(['/opt/elasticbeanstalk/bin/get-config', 'environment']))


      def get_optionsetting(option_namespace, option_name):
          return execute(['/opt/elasticbeanstalk/bin/get-config', 'optionsettings', '-n', option_namespace, '-o', option_name])


      def get_container_config(config_name):
          return execute(['/opt/elasticbeanstalk/bin/get-config', 'container', '-k', config_name])


      def execute(command_arr):
          return Popen(command_arr, stdout = PIPE).communicate()[0]


      def configure_stdout_logger():
          logging.basicConfig(
              level=logging.DEBUG,
              format="%(asctime)-15s %(levelname)-8s %(message)s",
              stream=sys.stdout)


      def get_python_version():
          return get_container_config('python_version')


      def generate_apache_config(params, filename):
          APP_DEPLOY_DIR = get_container_config('app_deploy_dir')
          APP_USER = get_container_config('app_user')
    
          static_file_content = _generate_static_file_config(params.get('static_files', {}))

          contents = APACHE_TEMPLATE % (
              params['http_port'], static_file_content,
              os.path.normpath(os.path.join(APP_DEPLOY_DIR, params['wsgi_path'])),
              APP_DEPLOY_DIR, params['num_processes'], params['num_threads'],
              APP_DEPLOY_DIR,
              APP_USER, APP_USER, APP_DEPLOY_DIR)
          open(filename, 'w').write(contents)


      def _generate_static_file_config(mapping):
          APP_DEPLOY_DIR = get_container_config('app_deploy_dir')
    
          contents = []
          for key, value in mapping.items():
              contents.append('Alias %s %s' % (key, os.path.join(APP_DEPLOY_DIR, value)))
              contents.append('<Directory %s>' % os.path.join(APP_DEPLOY_DIR, value))
              contents.append('Order allow,deny')
              contents.append('Allow from all')
              contents.append('</Directory>')
              contents.append('')
          return '\n'.join(contents)


      def validate_wsgi_path_param(params, base_dir):
          if not os.path.exists(base_dir):
              log.error("The base dir used for validating wsgi path params does not exist: %s", base_dir)
          if not os.path.isfile(os.path.join(base_dir, params['wsgi_path'])):
              emit_error_event(USER_ERROR_MESSAGES['badwsgipath'])
              log.error('The specified WSGIPath of "%s" was not found in the source bundle', params['wsgi_path'])


      def generate_env_var_config(params, filename):
          # Create an environment variable that can be sourced
          # in shell scripts:
          # . <envfile>
          # echo $VAR_FROM_APP_PARAMS
          # In addition to the existing vars, there's two more
          # env vars that are useful, the PYTHONPATH and the PATH.
          # However, with these vars we want to prepend/append values,
          # not completely replace, which is why they're done
          # separately.
          APP_DEPLOY_DIR = get_container_config('app_deploy_dir')
    
          env_var_config = [
              'export PYTHONPATH="%s/:$PYTHONPATH"' % APP_DEPLOY_DIR,
              'export PATH="/opt/python/run/venv/bin/:$PATH"',
          ]
          for env_var in params['environment']:
              value = params['environment'][env_var]
              value = value.replace("\\", "\\\\")
              value = value.replace('"', '\\"')
              env_var_config.append('export %s="%s"' % (env_var, value))

          env_var_config.append('')
          contents = '\n'.join(env_var_config)
          open(filename, 'w').write(contents)


      def inject_python_path(environment):
          APP_STAGING_DIR = get_container_config('app_staging_dir')
          if 'PYTHONPATH' not in environment:
              environment['PYTHONPATH'] = APP_STAGING_DIR
          else:
              environment['PYTHONPATH'] = '%s:%s' % (APP_STAGING_DIR, environment['PYTHONPATH'])


      def inject_path(environment):
          BASE_PATH_DIRS = get_container_config('base_path_dirs')
          if 'PATH' not in environment:
              environment['PATH'] = '/opt/python/run/venv/bin:' + BASE_PATH_DIRS
          else:
              environment['PATH'] = '/opt/python/run/venv/bin/:%s:%s' % (environment['PATH'], BASE_PATH_DIRS)


      def create_new_on_deck_dir():
          APP_STAGING_BASE = get_container_config('app_staging_base')
          BUNDLE_DIR = get_container_config('bundle_dir')
          cleanup_previous_deploy()
          latest_dir = sorted([int(i) for i in os.listdir(BUNDLE_DIR)])[-1]
          new_dir = os.path.join(BUNDLE_DIR, str(latest_dir + 1))
          os.mkdir(new_dir)
          os.symlink(new_dir, APP_STAGING_BASE)


      def cleanup_previous_deploy():
          # If the previous deploy fails, this is our chance to clean it up
          # before we start with our current app deploy.
          APP_STAGING_BASE = get_container_config('app_staging_base')
          if os.path.exists(APP_STAGING_BASE):
              actual_dir = os.readlink(APP_STAGING_BASE)
              os.remove(APP_STAGING_BASE)
              shutil.rmtree(actual_dir)


      def copy_apache_config():
          WSGI_STAGING_CONFIG = get_container_config('wsgi_staging_config')
          WSGI_DEPLOY_CONFIG = get_container_config('wsgi_deploy_config')
    
          if not os.path.exists(WSGI_STAGING_CONFIG):
              raise PythonHooksError("Config file does not exist: %s" % WSGI_STAGING_CONFIG)
          os.rename(WSGI_STAGING_CONFIG, WSGI_DEPLOY_CONFIG)


      def start_supervisord():
          if call('pgrep supervisord', shell=True) != 0:
              check_call('start supervisord', shell=True)

              # The supervisor config specifies that httpd must stay running
              # for 1 second so we have to give it time to startup and settle before
              # verifying that it's running.
              time.sleep(3)
              ensure_apache_is_running()


      def start_apache():
          apache_cmd('start', should_be_running=True)


      def restart_apache():
          apache_cmd('restart', should_be_running=True)


      def apache_cmd(command, should_be_running=True):
          check_call('/usr/local/bin/supervisorctl -c /opt/python/etc/supervisord.conf %s httpd' % command, shell=True)
          time.sleep(1.5)
          if should_be_running:
              ensure_apache_is_running()
              prime_apache(DEFAULT_ROOTPAGE_CHECK_TIMEOUT)


      def apache_is_running():
          rc = call('/usr/local/bin/supervisorctl -c /opt/python/etc/supervisord.conf status httpd | grep RUNNING', shell=True)
          return rc == 0


      def ensure_apache_is_running():
          if not apache_is_running():
              # try killing any other httpd processes and try again
              print "apache failed to start... killing all existing httpd processes and trying again"
              sys.stdout.flush()
              call('killall httpd', shell=True)
              time.sleep(1.5)
              call("echo Semaphores owned by apache:;ipcs -s | grep apache", stderr=subprocess.STDOUT, shell=True)
              check_call("echo Deleting apache semaphores:;ipcs -s | grep apache | awk '{print $2;}' | while read -r line; do ipcrm sem \"$line\"; done", stderr=subprocess.STDOUT, shell=True)
              check_call('/usr/local/bin/supervisorctl -c /opt/python/etc/supervisord.conf start httpd', shell=True)
              time.sleep(1.5)

              if not apache_is_running():
                  raise PythonHooksError("Apache is not running, but it's supposed to be.")


      def prime_apache(max_timeout):
          if (max_timeout is None or type(max_timeout) != int):
              max_timeout = DEFAULT_ROOTPAGE_CHECK_TIMEOUT
          remain_timeout = max_timeout
          while 0 <= remain_timeout:
              try:
                  urllib2.urlopen('http://localhost/', timeout=3).read()
                  return
              except Exception as err:
                  time.sleep(DEFAULT_RETRY_SLEEP_IN_SECOND)
                  remain_timeout = remain_timeout - DEFAULT_RETRY_SLEEP_IN_SECOND
          log.info('Apache is running, but root page is not responding in %s seconds.' % max_timeout)


      def emit_error_event(msg):
          check_call('eventHelper.py --msg "%s" --severity ERROR' % msg, shell=True)


      def diagnostic(msg):
          # Only call from an except block.
          check_call('eventHelper.py --msg "%s" --severity SYSTEM' % msg, shell=True)
          log.error(msg, exc_info=True)




###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Nginx for Single Docker environments to redirect HTTP
#### requests on port 80 to HTTPS on port 443 after you have configured your environment to support
#### HTTPS connections:
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
#### Terminating HTTPS on EC2 Instances Running Docker:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-docker.html
###################################################################################################

files:
   "/etc/nginx/sites-available/elasticbeanstalk-nginx-docker-proxy.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       map $http_upgrade $connection_upgrade {
           default        "upgrade";
           ""            "";
       }
       
       server {
           listen 80;
   
           gzip on;
           gzip_comp_level 4;
           gzip_types text/html text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
   
           if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
               set $year $1;
               set $month $2;
               set $day $3;
               set $hour $4;
           }
           access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
   
           access_log    /var/log/nginx/access.log;
       
           location / {
               set $redirect 0;
               if ($http_x_forwarded_proto != "https") {
                 set $redirect 1;
               }
               if ($http_user_agent ~* "ELB-HealthChecker") {
                 set $redirect 0;
               }
               if ($redirect = 1) {
                 return 301 https://$host$request_uri;
               }
   
               proxy_pass            http://docker;
               proxy_http_version    1.1;
       
               proxy_set_header    Connection            $connection_upgrade;
               proxy_set_header    Upgrade                $http_upgrade;
               proxy_set_header    Host                $host;
               proxy_set_header    X-Real-IP            $remote_addr;
               proxy_set_header    X-Forwarded-For        $proxy_add_x_forwarded_for;
           }
       }



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures Nginx for Ruby Puma environments to redirect HTTP requests
#### on port 80 to HTTPS on port 443 after you have configured your environment to support HTTPS
#### connections:
####
#### Configuring Your Elastic Beanstalk Environment's Load Balancer to Terminate HTTPS:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/configuring-https-elb.html
####
#### Terminating HTTPS on EC2 Instances Running Ruby Puma:
####  http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/https-singleinstance-ruby.html#Puma
###################################################################################################

files:
   "/opt/elasticbeanstalk/support/conf/webapp_healthd.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       upstream my_app {
         server unix:///var/run/puma/my_app.sock;
       }
       
       log_format healthd '$msec"$uri"'
                       '$status"$request_time"$upstream_response_time"'
                       '$http_x_forwarded_for';
       
       server {
         listen 80;
         server_name _ localhost; # need to listen to localhost for worker tier
       
         if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
           set $year $1;
           set $month $2;
           set $day $3;
           set $hour $4;
         }
       
         access_log  /var/log/nginx/access.log  main;
         access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
       
         location / {
             set $redirect 0;
             if ($http_x_forwarded_proto != "https") {
               set $redirect 1;
             }
             if ($http_user_agent ~* "ELB-HealthChecker") {
               set $redirect 0;
             }
             if ($redirect = 1) {
               return 301 https://$host$request_uri;
             }   
           proxy_pass http://my_app; # match the name of upstream directive which is defined above
           proxy_set_header Host $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         }
       
         location /assets {
           alias /var/app/current/public/assets;
           gzip_static on;
           gzip on;
           expires max;
           add_header Cache-Control public;
         }
       
         location /public {
           alias /var/app/current/public;
           gzip_static on;
           gzip on;
           expires max;
           add_header Cache-Control public;
         }
       }
 
container_commands:
  99_restart_nginx:
    command: "service nginx restart || service nginx start"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file modifies the ingress rule that Elastic Beanstalk adds to your
#### instances' security group when you assign a key pair for SSH connections. Use this file to
#### avoid opening port 22 to the entire world by restricting SSH connections to those coming from
#### another security group in AWS, i.e. one that you attach to a bastion host that you only launch
#### when you need to connect to an instance in the environment.
#### Replace "my-security-group" with the name of a security group in the same VPC.
###################################################################################################

option_settings:
  aws:autoscaling:launchconfiguration:
    SSHSourceRestriction: tcp, 22, 22, my-security-group


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file installs the SSL certificate bundle for
#### Redshift into the root Java installation so that your Java Tomcat Elastic Beanstalk
#### can securely talk to a Redshift database over SSL using standard JDBC mechanisms.
####
#### For more details, see:
#### https://docs.aws.amazon.com/redshift/latest/mgmt/connecting-ssl-support.html
#### https://docs.aws.amazon.com/redshift/latest/mgmt/connecting-transitioning-to-acm-certs.html
###################################################################################################

##############################################
#### Do not modify values below this line ####
##############################################

commands:
  01_install:
    command: "/tmp/install-redshift-ssl-cert-bundle.sh"

files:
  "/tmp/install-redshift-ssl-cert-bundle.sh":
      mode: "000755"
      content : |
        #!/bin/bash

        REDSHIFT_ROOT_ALIAS="redshift_bundle"
        REDSHIFT_ROOT_LOCAL_FILE="/tmp/redshift-ssl-ca-bundle.crt"
        JAVA_KEYSTORE_PASSWORD="changeit"

        #via https://docs.aws.amazon.com/redshift/latest/mgmt/connecting-ssl-support.html
        ROOT_REDSHIFT_CERT_URL="https://s3.amazonaws.com/redshift-downloads/redshift-ca-bundle.crt"

        if [ -z "$JAVA_HOME" ]; then
                echo "JAVA_HOME was not set. Setting to default of /usr/lib/jvm/jre..."
                export JAVA_HOME=/usr/lib/jvm/jre
        fi

        JAVA_KEYSTORE_FILE="$JAVA_HOME/lib/security/cacerts"

        echo "Attempting to remove any previously installed Redshift SSL certificate (and ignoring errors)..."

        $JAVA_HOME/bin/keytool -delete -alias $REDSHIFT_ROOT_ALIAS -storepass $JAVA_KEYSTORE_PASSWORD -noprompt -keystore $JAVA_KEYSTORE_FILE

        echo "Downloading ${ROOT_REDSHIFT_CERT_URL}..."
        curl $ROOT_REDSHIFT_CERT_URL > $REDSHIFT_ROOT_LOCAL_FILE
        if [ $? -ne 0 ]; then
                echo "ERROR: Could not download Redshift certificate bundle!"
                exit 1
        fi

        #Installing new cert to the keystore requires root permissions
        echo 'Installing downloaded Redshift certificate into the Java keystore...'

        $JAVA_HOME/bin/keytool -import -trustcacerts -alias $REDSHIFT_ROOT_ALIAS -storepass $JAVA_KEYSTORE_PASSWORD -noprompt -keystore $JAVA_KEYSTORE_FILE -file $REDSHIFT_ROOT_LOCAL_FILE
        if [ $? -ne 0 ]; then
                echo "ERROR: Could not install Redshift certificate bundle!"
                exit 1
        fi
        echo 'Redshift certificate bundle installed successfully!'



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file adds an ingress rule to the instance's security group to allow traffic
#### on port 443 from the Internet. Use this file to allow HTTPS traffic in a single instance
#### environment where you have configured the instance with a secure listener and certificate.
###################################################################################################

Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures the Auto Scaling Group to launch EC2 instances with an
#### existing Security Group. This is an additional Security Group to the one automatically
#### created by Elastic Beanstalk for the EC2 instances. Use this file when needing to place
#### Elastic Beanstalk EC2 instances into an existing Security Group. 
#### Note: It is possible to connect your environment to a database by adding a rule to your
#### database's security group that allows ingress from the autogenerated security group that
#### Elastic Beanstalk attaches to your environment's Auto Scaling group. However, doing so creates
#### a dependency between the two security groups. Subsequently, when you attempt to terminate the
#### environment, Elastic Beanstalk will be unable to delete the environment's security group
#### because the database's security group is dependent on it.
###################################################################################################

option_settings:
  - namespace: aws:autoscaling:launchconfiguration
    option_name: SecurityGroups
    value: my-security-group



## Environment Configuration
Configure settings that apply to the environment as a whole including rolling update and deployment settings.

## Instance Configuration
Configure the software and operating system on the instances in your environment.

## Resource Configuration
Advanced configuration of the peripheral resources in your environment (load balancer) and creation of additional resources.

## Security Configuration
Configure your application to terminate HTTPS connections at the load balancer, on instance, or both (end-to-end encryption), or configure the security groups in your environment to allow traffic on additional ports.


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This file configures your environment's load balancer to update access logs to an existing
#### bucket. Specify the name of your bucket in the Parameters section below. You can also set a
#### prefix for the load balancer to add to the log files in addition to the default prefix, which
#### starts with "AWSLogs" and looks similar to the following:
####    AWSLogs/123456789012/elasticloadbalancing/us-west-2/2017/09/01
####
#### Use this example if you're using a classic load balancer. If you're using one of the newer
#### load balancer types, network load balancer or application load balancer, you don't need the
#### style of configuration shown in this example. With these load balancer types, we support native
#### Elastic Beanstalk options to enable uploading logs to S3 and to configure the S3 bucket.
#### The options are in the aws:elbv2:loadbalancer namespace. You can also configure these options
#### using the Elastic Beanstalk console.
####
#### The load balancer must have permission to upload logs to the bucket. See the following topic
#### for instructions on creating or updating a bucket policy:
#### http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/enable-access-logs.html
####
#### If you don't already have a bucket policy, you can apply one with commands like the following:
####     $ ELBACCOUNT=797873946194  # For us-west-2, see above topic for other regions
####     $ BUCKET=my-bucket
####     $ PREFIX=my-app/
####     $ aws  s3api put-bucket-policy --bucket ${BUCKET} --policy "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"AWS\":\"arn:aws:iam::${ELBACCOUNT}:root\"},\"Action\":\"s3:PutObject\",\"Resource\":\"arn:aws:s3:::${BUCKET}/${PREFIX}AWSLogs/*\"}]}"
###################################################################################################

Parameters:
  bucket:
    Type: String
    Description: "Name of the Amazon S3 bucket in which to store load balancer logs"
    Default: "my-bucket"
  bucketprefix:
    Type: String
    Description: "Optional prefix. Can't start or end with a /, or contain the word AWSLogs"
    Default: ""

##############################################
#### Do not modify values below this line ####
##############################################

Resources:
  AWSEBLoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      AccessLoggingPolicy:
        EmitInterval: 5
        Enabled: true
        S3BucketName: { "Ref" : "bucket" }
        S3BucketPrefix: { "Ref" : "bucketprefix" }



### alb-http-to-https-redirection.config
This configuration file usage resources to configure HTTP to HTTPS auto redirection at application load balancer (ALB) layer. This will not work with an environment using other load balancer (Classic/Network).

### autoscaling-cloudwatch-group-metrics.config
Configures your environment's Auto Scaling Group to send group metrics to Amazon CloudWatch at 1-minute intervals.

### autoscaling-memory-utilization-cwagent.config
This configuration file will create custom CloudWatch metrics and alarms to monitor memory usage of EC2 instances and trigger auto scaling events.  You can find more information about configuring the CloudWatch agent here: https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-cw.html#customize-containers-cw-update-roles

### autoscaling-memory-utlization-AL1.config  
*NOTE: This configuration file only applies to environments running on Amazon Linux AMI (preceding Amazon Linux 2).  For a configuration file that works with Amazon Linux 2 or later, see configuration file: [autoscaling-memory-utlization.config](autoscaling-memory-utlization.config).*
<br/>
This configuration file will create custom cloudwatch metrics along with alarms to monitor memory usage of EC2 instances and Trigger auto-scale events based on cloud watch alarms. You can find more information about custom monitoring script here: https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-cw.html#customize-containers-cw-update-roles.<br/>  

### autoscaling-terminate-newest-instance.config
Terminate newest instance in autoscaling group at the time of scale down event

### autoscaling-triggers-createnew.config
Add scaling triggers to your environment's AutoScaling group, in addition to those provisioned by Elastic Beanstalk.

### autoscaling-triggers-customize.config
Modify the scaling triggers that Elastic Beanstalk creates for your environment's Auto Scaling group.

### autoscaling-triggers-disabledefault.config
Disable the scaling triggers that Elastic Beanstalk creates for your environment's Auto Scaling group.

### loadbalancer-accesslogs-existingbucket.config
Configure the load balancer in your environment to upload access logs to an existing bucket that you have configured to allow ELB write access.

### loadbalancer-accesslogs-newbucket.config
Create a new bucket and configure the load balancer to write access logs to it.

### sns-topic.config
Create an SNS topic for notifications, or to use in your application.



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file creates an Amazon SNS topic and exports its ARN to CloudFormation.
#### You can get the ARN of the topic in another configuration file in the same environment with
#### the Ref function (as shown below), or an external CloudFormation stack with Fn::ImportValue.
####
#### You can also assign information from the resource to an environment property. Under
#### option_settings, the configuration file gets the topic ARN with the Ref function and assigns
#### it to a property named NOTIFICATION_TOPIC. For more on environment properties, see
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-softwaresettings.html
###################################################################################################

Resources:
  NotificationTopic:
    Type: AWS::SNS::Topic

Outputs:
  NotificationTopicArn:
    Description: Notification topic ARN
    Value: { "Ref" : "NotificationTopic" }
    Export:
      Name: NotificationTopicArn

option_settings:
  aws:elasticbeanstalk:application:environment:
    NOTIFICATION_TOPIC: '`{"Ref" : "NotificationTopic"}`'


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file modifies the default port 80 listener attached to an Application Load Balancer 
#### to automatically redirect incoming connections on HTTP to HTTPS.
#### This will not work with an environment using the load balancer type Classic or Network.
#### A prerequisite is that the 443 listener has already been created. 
#### Please use the below link for more information about creating an Application Load Balancer on 
#### the Elastic Beanstalk console.
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-alb.html#environments-cfg-alb-console
###################################################################################################

Resources:
 AWSEBV2LoadBalancerListener:
  Type: AWS::ElasticLoadBalancingV2::Listener
  Properties:
    LoadBalancerArn:
      Ref: AWSEBV2LoadBalancer
    Port: 80
    Protocol: HTTP
    DefaultActions:
      - Type: redirect
        RedirectConfig:
          Host: "#{host}"
          Path: "/#{path}"
          Port: "443"
          Protocol: "HTTPS"
          Query: "#{query}"
          StatusCode: "HTTP_301"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file uses the configuration options in the aws:autoscaling:trigger
#### namespace to modify the default scaling triggers for your environment. It configures the
#### AWS CloudWatch alarms to trigger a scaling operation if average CPU utilization across all
#### instances exceeds 80% or falls below 20% for any three consecutive two minute periods.
####
#### Note that these options use minutes for the period setting whereas the equivalent parameters
#### for a CloudWatch alarm in AWS CloudFormation use seconds.
####
#### See the following topic for more information about the options in this namespace:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.as.html
###################################################################################################

option_settings:
  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Statistic: Average
    Unit: Percent
    Period: '2'
    EvaluationPeriods: '3'
    LowerThreshold: '20'
    UpperThreshold: '80'
    LowerBreachScaleIncrement: '-1'
    UpperBreachScaleIncrement: '1'


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures your environment's Auto Scaling Group to send group metrics
#### to Amazon CloudWatch at 1-minute intervals. Group metrics include the configured minimum and
#### maximum size of the group, the current desire capacity, the total number of instances in the
#### group, and the number of instances in each of the following states: In Service, Pending,
#### Standby, and Terminating.
#### 
#### Use these metrics to confirm that your environment has enough capacity to handle day-to-day
#### traffic patterns, plan for expected spikes in traffic, and identify areas for optimization.
#### For example, if your group's desired capacity changes too frequently, you might want to choose
#### a different instance type or adjust scaling trigger settings.
####
#### You can find the group metrics in the CloudWatch console under Metrics > Auto Scaling, sorted
#### by the name of group. AWS Elastic Beanstalk names groups by using the following format:
####    awseb-<environment ID>-AWSEBAutoScalingGroup-<resource ID>
####
#### See the following topic in the AWS Elastic Beanstalk Developer Guide for more information:
####    http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.as.html.
###################################################################################################

Resources:
  AWSEBAutoScalingGroup:
    Type: "AWS::AutoScaling::AutoScalingGroup"
    Properties: {
        "MetricsCollection": [ {
            "Granularity": "1Minute",
            "Metrics": [
               GroupMinSize,
               GroupMaxSize,
               GroupDesiredCapacity,
               GroupInServiceInstances,
               GroupPendingInstances,
               GroupStandbyInstances,
               GroupTerminatingInstances,
               GroupTotalInstances
             ]
         } ]
    }



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file creates a new bucket with a policy that allows ELB to write logs to it
#### and configures your environment's load balancer to upload logs.
###################################################################################################

Mappings: 
  Region2ELBAccountId: 
    us-east-1: 
      AccountId: "127311923021"
    us-west-2: 
      AccountId: "797873946194"
    us-west-1: 
      AccountId: "027434742980"
    eu-west-1: 
      AccountId: "156460612806"
    eu-central-1: 
      AccountId: "054676820928"
    ap-southeast-1: 
      AccountId: "114774131450"
    ap-northeast-1: 
      AccountId: "582318560864"
    ap-southeast-2: 
      AccountId: "783225319266"
    ap-northeast-2: 
      AccountId: "600734575887"
    sa-east-1: 
      AccountId: "507241528517"
    cn-north-1: 
      AccountId: "638102146993"

Resources: 
  AWSEBLoadBalancer: 
    Properties: 
      AccessLoggingPolicy: 
        EmitInterval: 5
        Enabled: true
        S3BucketName: 
          Ref: LogsBucket
    Type: "AWS::ElasticLoadBalancing::LoadBalancer"
    DependsOn: "LogsBucketPolicy"

  LogsBucket: 
    DeletionPolicy: Retain
    Type: "AWS::S3::Bucket"

  LogsBucketPolicy: 
    Properties: 
      Bucket: 
        Ref: LogsBucket
      PolicyDocument: 
        Statement: 
          - 
            Action: 
              - "s3:PutObject"
            Effect: Allow
            Principal: 
              AWS: 
                ? "Fn::FindInMap"
                : 
                  - Region2ELBAccountId
                  - 
                    Ref: "AWS::Region"
                  - AccountId
            Resource: 
              ? "Fn::Join"
              : 
                - ""
                - 
                  - "arn:aws:s3:::"
                  - 
                    Ref: LogsBucket
                  - /AWSLogs/
                  - 
                    Ref: "AWS::AccountId"
                  - /*
            Sid: ELBAccessLogs20130930
        Version: "2008-10-17"
    Type: "AWS::S3::BucketPolicy"



####################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
####################################################################################################

####################################################################################################
#### This configuration file adds a listener to the Application Load Balancer for port 443, this new listener
#### requires the ARN of a public website certificate create residing in the certificate manager service.
#### The configuration file also modifies the default port 80 listener attached to an Application Load Balancer 
#### to automatically redirect incoming connections on HTTP to HTTPS.
#### This will not work with an environment using the load balancer type Classic or Network.
#### Do not use this configuration file if a listener has already been created for port 443 from the console.
####################################################################################################

Resources:
  AWSEBV2LoadBalancerListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            Host: '#{host}'
            Path: '/#{path}'
            Query: '#{query}'
            StatusCode: HTTP_301
      LoadBalancerArn:
        Ref: AWSEBV2LoadBalancer
      Port: 80
      Protocol: HTTP
  AWSEBV2LoadBalancerListenerHTTPS:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      Certificates:
        - CertificateArn: Replace with Certificate ARN
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: AWSEBV2LoadBalancerTargetGroup
      LoadBalancerArn:
        Ref: AWSEBV2LoadBalancer
      Port: 443
      Protocol: HTTPS
      



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file will create custom CloudWatch metrics and alarms to monitor memory
#### usage of EC2 instances and trigger auto scaling events.
#### You can find more information about configuring the CloudWatch agent here:
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-cw.html#customize-containers-cw-update-roles
###################################################################################################

files:  
  "/opt/aws/amazon-cloudwatch-agent/bin/config.json": 
    mode: "000600"
    owner: root
    group: root
    content: |
      {
        "agent": {
          "metrics_collection_interval": 60,
          "run_as_user": "root"
        },
        "metrics": {
          "append_dimensions": {
            "AutoScalingGroupName": "${aws:AutoScalingGroupName}"
          },
          "metrics_collected": {
            "mem": {
              "measurement": [
                "used_percent"
              ]
            }
          }
        }
      }

container_commands:
  start_cloudwatch_agent: 
    command: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json

Resources:
  AWSEBCloudwatchAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions: []
  AWSEBCloudwatchAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions: []
  MemoryAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, "-Memory-scale-up-alarm." ]]}
      Namespace: CWAgent
      Dimensions:
        - Name: AutoScalingGroupName
          Value: { "Ref" : "AWSEBAutoScalingGroup" }
      MetricName: mem_used_percent
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - Ref: AWSEBAutoScalingScaleUpPolicy
  MemoryAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, "-Memory-scale-down-alarm." ]]}
      Namespace: CWAgent
      Dimensions:
        - Name: AutoScalingGroupName
          Value: { "Ref" : "AWSEBAutoScalingGroup" }
      MetricName: mem_used_percent
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 20
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - Ref: AWSEBAutoScalingScaleDownPolicy


###################################################################################################
#### Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures your environment's Auto Scaling group to enable 
#### the Capacity Rebalancing feature. 
####
#### If you are using Spot Instances on your environment, using Capacity Rebalancing makes your
#### Auto Scaling group attempt to replace Spot Instances at elevated risk of interruption before
#### they are interrupted by Amazon EC2. Capacity Rebalancing complements the capacity-optimized 
#### allocation strategy (designed to help find the most optimal spare capacity) and the mixed 
#### instances policy (designed to enhance availability by deploying across multiple instance types
#### running in multiple Availability Zones). 
####
#### Check out the Capacity Rebalancing documentation for further information:
####      https://docs.aws.amazon.com/autoscaling/ec2/userguide/capacity-rebalance.html
###################################################################################################

Resources:
    AWSEBAutoScalingGroup:
      Type: AWS::AutoScaling::AutoScalingGroup
      Properties:
        CapacityRebalance: true


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file prevents the AWS CloudWatch alarms that Elastic Beanstalk creates
#### for your environment from triggering scaling actions. You can use the other configuration
#### files in this folder to customize or extend the default triggers.
###################################################################################################

Resources:
   AWSEBCloudwatchAlarmHigh:
     Type: AWS::CloudWatch::Alarm
     Properties:
       AlarmActions: [ { "Ref" : "AWS::NoValue" } ]
   AWSEBCloudwatchAlarmLow:
     Type: AWS::CloudWatch::Alarm
     Properties:
       AlarmActions: [ { "Ref" : "AWS::NoValue" } ]



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file creates new high and low AWS CloudWatch alarms and configures them as
#### scaling triggers on your environment's AutoScaling Group. The alarm triggers when average CPU
#### utilization across the AutoScaling Group goes above 70% or below 30% for any 5 minute
#### measurement period.
####
#### This file creates two new alarms in addition to the two that Elastic Beanstalk creates by
#### default. You can use the other configuration files in this folder to modify or disable the
#### default triggers:
####  autoscaling-triggers-customize.config
####  autoscaling-triggers-disabledefault.config
####
#### You can change the values in the mappings section to customize the alarms. See the following
#### topics for details on available metrics, alarm configuration concepts, and valid values for
#### alarm resource properties:
####   http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ec2-metricscollected.html
####   http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html
####   http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html
###################################################################################################

Mappings:
  CustomConfig:
    ScalingConfig: 
      MetricNamespace: AWS/EC2
      TriggerMeasurement: CPUUtilization
      TriggerStatistic: Average
      MeasurementPeriod: '300'
      NumCooldownPeriods: '1'
      LowerThreshold: '30'
      UpperThreshold: '70'
      LowerBreachIncrement: '-1'
      UpperBreachIncrement: '1'

##############################################
#### Do not modify values below this line ####
##############################################

Resources:
  CustomScalingAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
      - {Ref: AutoScalingCustomScaleUpPolicy}
      AlarmDescription: ElasticBeanstalk custom scale up alarm
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: AutoScalingGroupName
        Value: {Ref: AWSEBAutoScalingGroup}
      EvaluationPeriods:
        Fn::FindInMap: [CustomConfig, ScalingConfig, NumCooldownPeriods]
      MetricName:
        Fn::FindInMap: [CustomConfig, ScalingConfig, TriggerMeasurement]
      Namespace:
        Fn::FindInMap: [CustomConfig, ScalingConfig, MetricNamespace]
      Period:
        Fn::FindInMap: [CustomConfig, ScalingConfig, MeasurementPeriod]
      Statistic:
        Fn::FindInMap: [CustomConfig, ScalingConfig, TriggerStatistic]
      Threshold:
        Fn::FindInMap: [CustomConfig, ScalingConfig, UpperThreshold]
  CustomScalingAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
      - {Ref: AutoScalingCustomScaleDownPolicy}
      AlarmDescription: ElasticBeanstalk custom scale down alarm
      ComparisonOperator: LessThanThreshold
      Dimensions:
      - Name: AutoScalingGroupName
        Value: {Ref: AWSEBAutoScalingGroup}
      EvaluationPeriods:
        Fn::FindInMap: [CustomConfig, ScalingConfig, NumCooldownPeriods]
      MetricName:
        Fn::FindInMap: [CustomConfig, ScalingConfig, TriggerMeasurement]
      Namespace:
        Fn::FindInMap: [CustomConfig, ScalingConfig, MetricNamespace]
      Period:
        Fn::FindInMap: [CustomConfig, ScalingConfig, MeasurementPeriod]
      Statistic:
        Fn::FindInMap: [CustomConfig, ScalingConfig, TriggerStatistic]
      Threshold:
        Fn::FindInMap: [CustomConfig, ScalingConfig, LowerThreshold]
  AutoScalingCustomScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: {Ref: AWSEBAutoScalingGroup}
      ScalingAdjustment:
        Fn::FindInMap: [CustomConfig, ScalingConfig, LowerBreachIncrement]
  AutoScalingCustomScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: {Ref: AWSEBAutoScalingGroup}
      ScalingAdjustment:
        Fn::FindInMap: [CustomConfig, ScalingConfig, UpperBreachIncrement]



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file will create custom cloudwatch metrics along with alarms to monitor memory
#### usage of EC2 instances and Trigger auto-scale events based on cloud watch alarms
####
#### Note:  This configuration file only applies to environments running on Amazon Linux AMI (preceding Amazon Linux 2).
####        For a configuration file that works with Amazon Linux 2 or later, 
####        see configuration file: autoscaling-memory-utlization.config
####
#### You can find more information about custom monitoring script here:
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-cw.html#customize-containers-cw-update-roles
###################################################################################################

packages:
  yum:
    perl-DateTime: []
    perl-Sys-Syslog: []
    perl-LWP-Protocol-https: []
    perl-Switch: []
    perl-URI: []
    perl-Bundle-LWP: []

sources:
  /opt/cloudwatch: https://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.1.zip

container_commands:
  01-setupcron:
    command: |
      echo '*/5 * * * * root perl /opt/cloudwatch/aws-scripts-mon/mon-put-instance-data.pl `{"Fn::GetOptionSetting" : { "OptionName" : "CloudWatchMetrics", "DefaultValue" : "--mem-util --disk-space-util --disk-path=/" }}` >> /var/log/cwpump.log 2>&1' > /etc/cron.d/cwpump
  02-changeperm:
    command: chmod 644 /etc/cron.d/cwpump
  03-changeperm:
    command: chmod u+x /opt/cloudwatch/aws-scripts-mon/mon-put-instance-data.pl

option_settings:
  "aws:autoscaling:launchconfiguration" :
    IamInstanceProfile : "aws-elasticbeanstalk-ec2-role"
  "aws:elasticbeanstalk:customoption" :
    CloudWatchMetrics : "--mem-util --mem-used --mem-avail --disk-space-util --disk-space-used --disk-space-avail --disk-path=/ --auto-scaling"


Resources:
  MemoryAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, "-Memory-scale-up-alarm." ]]}
      Namespace: System/Linux
      Dimensions:
        - Name: AutoScalingGroupName
          Value: { "Ref" : "AWSEBAutoScalingGroup" }
      MetricName: MemoryUtilization
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 20
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - Ref: AWSEBAutoScalingScaleUpPolicy

  MemoryAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, "-Memory-scale-down-alarm." ]]}
      Namespace: System/Linux
      Dimensions:
        - Name: AutoScalingGroupName
          Value: { "Ref" : "AWSEBAutoScalingGroup" }
      MetricName: MemoryUtilization
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: LessThanThreshold
      AlarmActions:
        - Ref: AWSEBAutoScalingScaleDownPolicy



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file changes the default AutoScaling to terminate new instances first
#### In case of any scale down event, AutoScaling will teminate the newly lanched instance.
#### Its useful when your environment is going through frequent scaling acivities and
#### terminating a good/healthy old instance where as your new instance is not yet ready.
###################################################################################################

Resources:
  AWSEBAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      TerminationPolicies:
        - NewestInstance



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file Changes MTU for Jumbo-Frame enabled instances e.g->C3.large
#### In order to get a 1500 MTU you need to also tell dhclient to ignore the interface-mtu option
#### received from the DHCP server
###################################################################################################

files:
  "/etc/dhcp/dhclient.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
     timeout 300;
     request subnet-mask,  broadcast-address, time-offset, routers, domain-name, domain-search, domain-name-servers, host-name, nis-domain, nis-servers, ntp-servers;

  "/etc/sysconfig/network-scripts/ifcfg-eth0":
    mode: "000644"
    owner: root
    group: root
    content: |
      DEVICE=eth0
      BOOTPROTO=dhcp
      ONBOOT=yes
      MTU=1500
      TYPE=Ethernet
      USERCTL=yes
      PEERDNS=yes
      IPV6INIT=no
      PERSISTENT_DHCLIENT=yes

commands:
  restart_network:
    command: sudo /sbin/service network restart
    ignoreErrors: true



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following sets the reverse proxy for a Node.js environment to Apache httpd rather than the
#### default, nginx.
####
#### You can also set ProxyServer to "none" to disable the proxy and serve
#### requests directly from your application. If you disable the proxy server, the other settings
#### in this namespace (static file mappings and gzip compression) are disabled.
####
#### See the following topic in the developer guide for more information:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_nodejs.container.html
###################################################################################################

option_settings:
   aws:elasticbeanstalk:container:nodejs:
     ProxyServer: apache



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file shows an example of running a cron job on all linux instances in the
#### environment.
#### 
#### In the example, the script "/usr/local/bin/myscript.sh" is run from the cron file
#### "/etc/cron.d/mycron" once a minute running "date" and sending the output to "/tmp/date".
####
#### The "commands" section cleans up the backup file. ".bak" files are created when
#### "/etc/cron.d/mycron" already exists during deployment.
####
###################################################################################################

files:
    "/etc/cron.d/mycron":
        mode: "000644"
        owner: root
        group: root
        content: |
            * * * * * root /usr/local/bin/myscript.sh

    "/usr/local/bin/myscript.sh":
        mode: "000755"
        owner: root
        group: root
        content: |
            #!/bin/bash

            date > /tmp/date
            # Your actual script content

            exit 0

commands:
    remove_old_cron:
        command: "rm -f /etc/cron.d/mycron.bak"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following config uses a set of commands to download and install new relic agent and monitors
#### You should update the MSI download path and your NR_LICENSE_KEY before applying this config
#### in your environment.
####
#### Please find the latest information/configuration files under new relic public documentation
#### https://docs.newrelic.com/docs/infrastructure/new-relic-infrastructure/installation/install-infrastructure-agent-aws-elastic-beanstalk
###################################################################################################

files:
  "/etc/newrelic-infra.yml" :
    mode: "000644"
    owner: root
    group: root
    content: |
      license_key: YOUR_LICENSE_KEY

commands:
# Create the agentâs yum repository
  "01-agent-repository":
    command: sudo curl -o /etc/yum.repos.d/newrelic-infra.repo https://download.newrelic.com/infrastructure_agent/linux/yum/el/6/x86_64/newrelic-infra.repo

# Update your yum cache
  "02-update-yum-cache":
    command: yum -q makecache -y --disablerepo='*' --enablerepo='newrelic-infra'

# Run the installation script
  "03-run-installation-script":
    command: sudo yum install newrelic-infra -y



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file allows a cron job to run only on one Linux instance in the environment.
#### 
#### The script "/usr/local/bin/test_cron.sh" will sort and compare the current instances in the
#### Auto Scaling group and if it matches the first instance in the sorted list it will exit 0.
#### This will mean that this script will only exit 0 for one of the instances in your environment.
####
#### The second script is an example of how you might use the "/usr/local/bin/test_cron.sh" script
#### to execute commands and log a timestamp to "/tmp/cron_example.log".
####
#### A cron example is setup at "/etc/cron.d/cron_example" to execute the script 
#### "/usr/local/bin/cron_example.sh" every minute. A command is also run upon each deployment to 
#### clear any previous versions of "/etc/cron.d/cron_example" by removing 
#### "/etc/cron.d/cron_example.bak".
####
#### Note that for the first script to gather the required information, additional IAM permissions
#### will be needed to be added to a policy attached to the instance profile used by the instances
#### in the environment. The policy shown below will grant the access needed. Note that the default
#### instance profile for Elastic Beanstalk is "aws-elasticbeanstalk-ec2-role".
####
#### How to create a New Policy
####         - https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html
####
#### Adding Permissions to the Default Instance Profile
####         - https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/iam-instanceprofile.html#iam-instanceprofile-addperms
####
#### NB: Please note that as the "/usr/local/bin/test_cron.sh" script makes use of the EC2 health
#### status to determine "InService" instances in the Auto Scaling Group, the cron could fail to
#### run if the "leader" instance has failed and Auto Scaling has not yet changed the EC2 instance
#### state.
###################################################################################################
####
#### {
####   "Version": "2012-10-17",
####   "Statement": [
####     {
####       "Sid": "Stmt1409855610000",
####       "Effect": "Allow",
####       "Action": [ "autoscaling:DescribeAutoScalingGroups" ],
####       "Resource": [ "*" ]
####     },
####     {
####       "Sid": "Stmt1409855649000",
####       "Effect": "Allow",
####       "Action": [ "ec2:DescribeTags" ],
####       "Resource": [ "*" ]
####     }
####   ]
#### }
####
###################################################################################################
###################################################################################################

packages: 
  yum:
    jq: [] 

files:
  "/usr/local/bin/test_cron.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      INSTANCE_ID=`curl http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null`
      REGION=`curl -s http://169.254.169.254/latest/dynamic/instance-identity/document 2>/dev/null | jq -r .region`

      # Find the Auto Scaling Group name from the Elastic Beanstalk environment
      ASG=`aws ec2 describe-tags --filters "Name=resource-id,Values=$INSTANCE_ID" \
          --region $REGION --output json | jq -r '.[][] | select(.Key=="aws:autoscaling:groupName") | .Value'`

      # Find the first instance in the Auto Scaling Group
      FIRST=`aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names $ASG \
          --region $REGION --output json | \
          jq -r '.AutoScalingGroups[].Instances[] | select(.LifecycleState=="InService") | .InstanceId' | sort | head -1`

      # If the instance ids are the same exit 0
      [ "$FIRST" = "$INSTANCE_ID" ]

  "/usr/local/bin/cron_example.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /usr/local/bin/test_cron.sh || exit
      # Now run commands that should run on only 1 instance.
      echo "Cron running at "`date` > /tmp/cron_example.log

  "/etc/cron.d/cron_example":
    mode: "000644"
    owner: root
    group: root
    content: |
      * * * * * root /usr/local/bin/cron_example.sh

commands:
  rm_old_cron:
    command: "rm -fr /etc/cron.d/cron_example.bak"
    ignoreErrors: true



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file installs Amazon Inspector Agents on the instance launched under Elastic Beanstalk
#### https://docs.aws.amazon.com/inspector/latest/userguide/inspector_installing-uninstalling-agents.html
###################################################################################################

files:
  "/tmp/install" :
    mode: "000755"
    owner: root
    group: root
    source: https://inspector-agent.amazonaws.com/linux/latest/install
commands:
  install_inspector:
    command: bash -x install -u false
    cwd: /tmp/



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following file configures the AWS CloudWatch agent to push logs to a Log Group in CloudWatch Logs.
#### 
#### The configuration below sets the logs to be pushed, the Log Group name to push the logs to,
#### the Log Stream name as the instance id, and the log retention period.
#### This example streams /var/log/messages, but you can modify it stream other files.
#### `retention_in_days` is optional.
####
#### Find more information about configuring the CloudWatch agent here:
#### https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html
####
#### You can then access the CloudWatch Logs by accessing the AWS CloudWatch Console and clicking
#### the "Logs" link on the left. The Log Group name will follow this format:
####
#### /aws/elasticbeanstalk/<environment name>/<full log name path>
####
#### Please note this configuration should be used additionally to the "Log Streaming" feature:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.cloudwatchlogs.html
###################################################################################################

files:
  "/opt/aws/amazon-cloudwatch-agent/etc/my_log_config.json":
    mode: "0644"
    owner: root
    group: root
    content: |
      {
        "logs": {
          "logs_collected": {
            "files": {
              "collect_list": [
                {
                  "file_path": "/var/log/messages",
                  "log_group_name": "`{"Fn::Join":["/", ["/aws/elasticbeanstalk", { "Ref":"AWSEBEnvironmentName" }, "var/log/messages"]]}`",
                  "log_stream_name": "{instance_id}",
                  "retention_in_days": 7
                }
              ]
            }
          }
        }
      }
container_commands:
  01_append_cloudwatch_agent_config:
    command: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/my_log_config.json
  02_remove_backup_file:
    command: rm -f /opt/aws/amazon-cloudwatch-agent/etc/my_log_config.json.bak
    ignoreErrors: true



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures the timezone on each instance in the environment.
####
#### It begins by setting an environment property "TZ" to a timezone of your choosing. Have a look
#### in /usr/share/zoneinfo on any of the instances in your environment for all possible options.
#### Additionally this configuration file sets the same chosen timezone on the instance itself by
#### changing the "/etc/localtime" and "/etc/sysconfig/clock".
#### This example uses pool.ntp.org, which requires that your instance has access to the internet.
#### The Amazon Time Sync Service is available through NTP at 169.254.169.123 for any instance 
#### running in a VPC.
###################################################################################################

option_settings:
  - namespace: aws:elasticbeanstalk:application:environment
    option_name: TZ
    value: "Africa/Johannesburg"

files:
  "/tmp/set_timezone.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      NEWTIMEZONE="$(/opt/elasticbeanstalk/bin/get-config environment -k TZ)"
      if [ -z $NEWTIMEZONE ] ; then
          echo "TZ" environment property not set
          exit 1
      fi
      if [ ! -f /usr/share/zoneinfo/$NEWTIMEZONE ] ; then
          echo /usr/share/zoneinfo/$NEWTIMEZONE does not exist
          exit 1
      fi
      echo 'ZONE="'$NEWTIMEZONE'"' > /etc/sysconfig/clock
      echo 'UTC=true' >> /etc/sysconfig/clock
      ln -f -s /usr/share/zoneinfo/$NEWTIMEZONE /etc/localtime
      ntpdate -u pool.ntp.org

commands:
  00-custom-timezone:
    command: /tmp/set_timezone.sh



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following file installs and configures the AWS CloudWatch Logs agent to push logs to a Log
#### Group in CloudWatch Logs.
####
#### NOTE: This example is for the legacy Amazon Linux AMI (preceding Amazon Linux 2) platform versions.
#### For a current example, see: logs-streamtocloudwatch-linux.config
#### 
#### The configuration below sets the logs to be pushed, the Log Group name to push the logs to and
#### the Log Stream name as the instance id. The following files are examples of logs that will be
#### streamed to CloudWatch Logs in near real time:
#### 
#### /var/log/messages
#### /var/log/dmesg
#### 
#### You can then access the CloudWatch Logs by accessing the AWS CloudWatch Console and clicking
#### the "Logs" link on the left. The Log Group name will follow this format:
####
#### /aws/elasticbeanstalk/<environment name>/<full log name path>
####
#### Please note this configuration can be used additionally to the "Log Streaming" feature:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.cloudwatchlogs.html
###################################################################################################

packages:
  yum:
    awslogs: []

files:
  "/etc/awslogs/awscli.conf" :
    mode: "000600"
    owner: root
    group: root
    content: |
      [plugins]
      cwlogs = cwlogs
      [default]
      region = `{"Ref":"AWS::Region"}`

  "/etc/awslogs/awslogs.conf" :
    mode: "000600"
    owner: root
    group: root
    content: |
      [general]
      state_file = /var/lib/awslogs/agent-state

  "/etc/awslogs/config/logs.conf" :
    mode: "000600"
    owner: root
    group: root
    content: |
      [/var/log/messages]
      log_group_name = `{"Fn::Join":["/", ["/aws/elasticbeanstalk", { "Ref":"AWSEBEnvironmentName" }, "var/log/messages"]]}`
      log_stream_name = {instance_id}
      file = /var/log/messages

      [/var/log/dmesg]
      log_group_name = `{"Fn::Join":["/", ["/aws/elasticbeanstalk", { "Ref":"AWSEBEnvironmentName" }, "var/log/dmesg"]]}`
      log_stream_name = {instance_id}
      file = /var/log/dmesg

commands:
  "01":
    command: chkconfig awslogs on
  "02":
    command: service awslogs restart



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Increase available file descriptors to Node.js
###################################################################################################


files:
    "/etc/security/limits.d/node.conf":
        mode: "000644"
        owner: root
        group: root
        content: |
            nodejs	hard	nofile	8192
            nodejs	soft	nofile	8192

container_commands:
    01_restart_node:
        command: "/sbin/restart nodejs"
    02_cleanup:
        command: "rm /etc/security/limits.d/node.conf.bak"
        ignoreErrors: true



### websockets
Configure the proxy server that runs in front of your application to allow websockets.
If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html

### add-ebs-volume.config
This configuration file add a new volume to the instance, create filesystem and mount it.

### add-secondary-network-interface.config
This configuration file adds a secondary NetworkInterface to the EC2 instance. The SubnetId for the secondary interface has to be in the same Availability Zone as the instance.

### amazon-inspector-install.config
This configuration file installs Amazon Inspector Agents on the instance launched under Elastic Beanstalk.

### apache-mpm_prefork.config
This configuration file increases the number of MPM Prefork daemons. Its Useful on larger instance types that run out of these daemons well before memory or CPU exhaustion.

### awslogs-change-frequency.config
This configuration file modifies logrotate frequency to 5 minutes and upload to S3.

### change-nginx-max-body-size.config
This configuration file client_max_body_size in nginx within a Java environment by adding a hook.

### cron-leaderonly-linux.config
Run a cron job on only one Linux instance in the environment.

### cron-linux.config
This configuration file shows an example of running a cron job on all linux instances in the environment.

### env-regionname.config
Configure Elastic Beanstalk to pass your environment's region to your application with an environment variable.

### files-downloadfromS3.config
Use the `files` key to download a file from a bucket in Amazon S3 to the instances in your environment, providing the instance profile role to use for authorization. Use this mechanism to securely provide your application with secrets that you can't include in your source code, such as private keys and database passwords.

### install-newrelic-agent.config
This configuration file install the infrastructure agent on the instance launched under Elastic Beanstalk. Please find the latest information/config files under new relic public documentation: https://docs.newrelic.com/docs/infrastructure/new-relic-infrastructure/installation/install-infrastructure-agent-aws-elastic-beanstalk

### install-nodejs.config
This configuration file installs nodejs to a non-NodeJs solution stack.

### java-increase-file-descriptors.config
Increase file descriptors for Java Tomcat environment.

### logs-streamtocloudwatch-linux.config
Configure Cloudwatch log agent to stream logs to Cloudwatch

### logs-uploadonterminate-linux.config
Publish logs to S3 on termination of a linux instance.

### network-mtu-jumboframe.config
This configuration file Changes MTU for Jumbo-Frame enabled instances e.g->C3.large

### nodejs-increase-file-descriptors.config
Increase available file descriptors to Node.js.

### package-oracle-jdk.config
Install Oracle JDK and set as default

### proxy-configure-nodejs.configs
Use the option_settings key to modify Node.js Platform Options ProxyServer to select which web server should be used to proxy connections to Node.js.
Supported values for ProxyServer can be either nginx, apache or none

### storage-efs-createfilesystem.config
Use the `Resources` key to create a new file system in Amazon Elastic File System (Amazon EFS). All of the instances in your environment can connect to the same EFS file system for shared, scalable storage. Use `storage-efs-mountfilesystem.config` to mount the file system on each instance. Note that any resources that you create with configuration files are tied to the lifecycle of your environment and will be lost if you terminate your environment or remove the configuration file.

### storage-efs-mountfilesystem.config
Mount an Amazon EFS file system to a local path on the instances in your environment. You can create the volume as part of the environment with `storage-efs-createfilesystem.config`, or external to your environment by using the Amazon EFS Management Console, AWS CLI, or an SDK.

### storage-imagevolume-docker.config
Configure the volume used by the instances in your Docker environment.

### t2unlimited-instance.config
This configuration file will allow T2 Unlimited with Elastic Beanstalk for Linux based Environments. Since it is not directly possible to use T2 Unlimited instances with Elastic Beanstalk as of now, the below provided ebextensions config file lets you use T2 instances with Surplus credits.
Note: Since the container_command "set-t2-unlimited" makes an api call "modify-instance-credit-specification", the instance profile associated with the Beanstalk environment's instance must have necessary
permissions to make the api call (ec2:ModifyInstanceCreditSpecification).

### timezone-linux.config
Configure the timezone on each instance.



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file enables WindowsFeature Web-Http-Tracing on the windows instance launched
#### under Elastic Beanstalk and request tracing will capture traces for requests which resulted in
#### status codes from 400 to 599; by default, the latest 50 error traces will be saved on:
#### %systemdrive%\inetpub\logs\FailedReqLogFiles\. Request Monitor will enable the feature to
#### monitor currently/hanging requests.
###################################################################################################


commands:
  00_install-web-http-tracing:
    command: "powershell.exe Install-WindowsFeature -Name Web-Http-Tracing"
    waitAfterCompletion: 0
  01_enable-web-http-tracing:
    command: "powershell.exe Enable-WebRequestTracing -StatusCodes 400-599"
    waitAfterCompletion: 0
  02_install-web-request-monitoring:
    command: "powershell.exe Install-WindowsFeature -Name Web-Request-Monitor"
    waitAfterCompletion: 0



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file install the infrastructure agent on the instance launched under Elastic Beanstalk.
#### You should update the MSI download path and your NR_LICENSE_KEY before applying this config
#### in your environment. Please find the latest information/config files under new relic public
#### documentation https://docs.newrelic.com/docs/infrastructure/new-relic-infrastructure/installation/install-infrastructure-agent-aws-elastic-beanstalk
###################################################################################################

packages:
  msi:
    infrastructure: https://download.newrelic.com/infrastructure_agent/windows/newrelic-infra.msi
files:
  "C:\\Program Files\\New Relic\\newrelic-infra\\newrelic-infra.yml":
    content: |
      license_key: YOUR_LICENSE_KEY
commands:
  01_stop-newrelic-infra:
    command: net stop newrelic-infra
    ignoreErrors: true
  02_start-newrelic-infra:
    command: net start newrelic-infra
    ignoreErrors: true



### adding-writepermission-iisfolder.config  
This configuration file uses powershell to add write permission to a custom IIS folder. Its allowing DefaultAppPool to write in custom IIS folder "C:\inetpub\wwwroot\uploads"
You can change the path as per your use-case or to the path your application is going to write.

### aws-inspector-install.config             
This configuration file to installs Amazon Inspector Agents on the windows instance launched under Elastic Beanstalk.
Please find more information here: https://docs.aws.amazon.com/inspector/latest/userguide/inspector_installing-uninstalling-agents.html

### change-iislog-location.config  
This configuration file uses appcmd.exe to set new IIS log file directory to a custom folder path. You should change the directory path 'X:\\folder\\' to your desired path before applying this configuration.

### elastic-ip-instance.config
This configuration file can be used to assign EIP on the instance launched under Elastic Beanstalk
Replace "MYEIPS" values with the list of your EIP Allocation IDs. The solution was tested on solution stack (64bit Windows Server 2016 v1.2.0 running IIS 10.0) and AMI (ami-xxxxxxxx).

### install-newrelic-agent.config
This configuration file install the infrastructure agent on the instance launched under Elastic Beanstalk. Please find the latest information/config files under new relic public documentation: https://docs.newrelic.com/docs/infrastructure/new-relic-infrastructure/installation/install-infrastructure-agent-aws-elastic-beanstalk

### join-domain-ssm.config
This configuration file uses SSM association to join windows instances launched under Elastic Beanstalk to domain. With the use of IAM Policy, AWS Directory Service (Microsoft AD)
and SSM, you can join your Elastic Beanstalk IIS Windows Instances to the AWS Directory Service domain. You can look at the our documentation in order to create IAM Policy and SSM document which is not part of this configuration file: https://aws.amazon.com/blogs/security/how-to-configure-your-ec2-instances-to-automatically-join-a-microsoft-active-directory-domain/

### t2unlimited-instance.config  
This configuration file will allow T2 Unlimited with Elastic Beanstalk for Windows based Environments. Since it is not directly possible to use T2 Unlimited instances with Elastic Beanstalk as of now the provided ebextensions config file lets you use T2 instances with Surplus credits.

### timezone-windows.config  
This configuration file configures the timezone on each instance in the environment. Its using tzutil command to set timezone on the instance.
Have a look at the URL https://technet.microsoft.com/en-us/library/cc749073%28v=ws.10%29.aspx for all possible time zone values in this case its done for UTC+1.

### web-http-tracing.config
This configuration file enables WindowsFeature Web-Http-Tracing on the windows instance launched under Elastic Beanstalk and request tracing will capture traces for requests which resulted in status codes from 400 to 599; by default, the latest 50 error traces will be saved on: %systemdrive%\inetpub\logs\FailedReqLogFiles\. Request Monitor will enable the feature to  monitor currently/hanging requests.



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file uses SSM association to join windows instances launched under
#### Elastic Beanstalk to domain. With the use of IAM Policy, AWS Directory Service (Microsoft AD)
#### and SSM, you can join your Elastic Beanstalk IIS Windows Instances to the AWS Directory Service domain.

#### You can look at the following documentation in order to create IAM Policy and SSM document which
#### is not part of this config https://aws.amazon.com/blogs/security/how-to-configure-your-ec2-instances-to-automatically-join-a-microsoft-active-directory-domain/
###################################################################################################

files:
 "C:\\scripts\\SSMAssociation.ps1":
   content: |
     Import-Module AWSPowerShell
     $date =get-date
     if(test-path C:\\transcript.txt) {ri C:\\transcript.txt}
     Start-transcript -Path C:\\transcript.txt -Force -NoClobber
     "Date Ran $date"
     $InstanceId = Invoke-Restmethod -uri http://169.254.169.254/latest/meta-data/instance-id
     "Instance ID: $InstanceId"
     $AvailabilityZone = Invoke-RestMethod -uri http://169.254.169.254/latest/meta-data/placement/availability-zone
     "Availability Zone: $AvailabilityZone"
     $Region = $AvailabilityZone.Substring(0,$AvailabilityZone.Length-1)
     "Region: $Region"
     Set-DefaultAWSRegion $Region
     "Instance Name: $InstanceName"
     Rename-Computer -NewName $InstanceId -confirm:$false -force
     New-SSMAssociation -InstanceId $InstanceId -Name "ssm01" -Region $Region
     Stop-transcript
     Restart-Computer -Force
container_commands:
  01_SSMAssociation:
     command: powershell.exe -ExecutionPolicy Bypass -File C:\\scripts\\SSMAssociation.ps1



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file to installs Amazon Inspector Agents on the windows instance launched
#### under Elastic Beanstalk.
#### https://docs.aws.amazon.com/inspector/latest/userguide/inspector_installing-uninstalling-agents.html
###################################################################################################


files:
  "C:\\Temp\\AWSAgentInstall.exe":
    source: https://inspector-agent.amazonaws.com/windows/installer/latest/AWSAgentInstall.exe
commands:
  install_inspector:
    command: "C:\\Temp\\AWSAgentInstall.exe /quiet"
    cwd: "C:\\Temp\\"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures the timezone on each instance in the environment.
#### Its using tzutil command to set timezone on the instance. Have a look
#### at the URL https://technet.microsoft.com/en-us/library/cc749073%28v=ws.10%29.aspx for all possible
#### timezone values in this case its done for UTC+1
###################################################################################################

commands:
  setting_time_zone:
    command: tzutil /s "W. Europe Standard Time"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file uses powershell to add write permission to a custom IIS folder.
#### Its allowing DefaultAppPool to write in custom IIS folder "C:\inetpub\wwwroot\uploads"
#### You can change the path as per your use-case or to the path your application wants to write
###################################################################################################

files:
  "C:\\scripts\\permissions.ps1":
    content: |
      Import-Module WebAdministration
      $appPoolName='DefaultAppPool'

      # Update your custom IIS folder path here
      $folderDirectory='C:\inetpub\wwwroot\uploads'

      $appPoolSid = (Get-ItemProperty IIS:\AppPools\$appPoolName).applicationPoolSid
      $identifier = New-Object System.Security.Principal.SecurityIdentifier $appPoolSid
      $user = $identifier.Translate([System.Security.Principal.NTAccount])

      If(!(test-path $folderDirectory))
      {
         New-Item -ItemType Directory -Force -Path $folderDirectory
      }
      $acl = Get-Acl $folderDirectory

      # SetAccessRuleProtection (bool isProtected, bool preserveInheritance);
      # isProtected - true to protect the access rules associated with this ObjectSecurity object from inheritance; false to allow inheritance.
      # preserveInheritance - true to preserve inherited access rules; false to remove inherited access rules. This parameter is ignored if isProtected is false.

      $acl.SetAccessRuleProtection($False, $True)
      $rule = New-Object System.Security.AccessControl.FileSystemAccessRule($user,"FullControl", "ContainerInherit, ObjectInherit", "None", "Allow")
      $acl.AddAccessRule($rule)
      Set-Acl $folderDirectory $acl

      # Print the final ACL in log
      # Get-Acl $folderDirectory  | Format-List

container_commands :
  set_permission:
    command: powershell.exe -ExecutionPolicy Bypass -Command "C:\\scripts\\permissions.ps1"
    ignoreErrors: false
    waitAfterCompletion: 5



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file uses appcmd.exe to set new IIS log file directory to a custom folder path
#### You should change the directory path 'X:\\folder\\' to your desired path before applying this configuration
###################################################################################################

commands:
  ChangeLogLocation:
    command: "%systemroot%\\system32\\inetsrv\\appcmd.exe set config -section:system.applicationHost/sites /siteDefaults.logFile.directory:'X:\\folder\\' /commit:apphost"
  IISreset:
    command: "%systemroot%\\system32\\iisreset.exe"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file can be used to assign EIP on the instance launched under Elastic Beanstalk
#### - Replace "MYEIPS" values with the list of your EIP Allocation IDs.
#### - The solution was tested on solution stack (64bit Windows Server 2016 v1.2.0 running IIS 10.0) and AMI (ami-xxxxxxxxxx).
###################################################################################################

packages:
  msi:
    awscli: https://s3.amazonaws.com/aws-cli/AWSCLI64PY3.msi
files:
  "C:\\assigneip.ps1":
    content: |
      $env:Path += ";C:\Program Files\Amazon\AWSCLI\bin\"
      $MYEIPS="eipalloc-xxxxxxxxxxxxxxxxx", "eipalloc-xxxxxxxxxxxxxxxxx", "eipalloc-xxxxxxxxxxxxxxxxx"
      $IID = (New-Object System.Net.WebClient).DownloadString("http://169.254.169.254/latest/meta-data/instance-id")
      $AV = (New-Object System.Net.WebClient).DownloadString("http://169.254.169.254/latest/meta-data/placement/availability-zone")
      $REGION=$AV -replace ".$"
      foreach ($EIP in $MYEIPS) {aws ec2 associate-address --allocation-id $EIP --instance-id $IID --no-allow-reassociation --region=$REGION}
container_commands:
  script:
    command: powershell.exe -ExecutionPolicy Bypass -File "C:\\assigneip.ps1"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### T2 Unlimited with Elastic Beanstalk for Windows based Environments
#### Since it is not directly possible to use T2 Unlimited instances with Elastic Beanstalk as of now
#### the below provided ebextensions config file lets you use T2 instances with Surplus credits.
###################################################################################################

files:
  "c:\\windows\\temp\\t2-test.ps1":
     content : |
      $instance = (Invoke-WebRequest http://169.254.169.254/latest/meta-data/instance-type).Content
      if(echo "$instance" | Select-String 't2.*'){ exit 0}else{exit 1}

  "c:\\users\\Administrator\\changecredit.ps1":
     content: |
       $az = (Invoke-WebRequest http://169.254.169.254/latest/meta-data/placement/availability-zone).content
       $region = $az.Substring(0,$az.length-1)
       $instanceId = (New-Object System.Net.WebClient).DownloadString("http://169.254.169.254/latest/meta-data/instance-id")
       #Set Default Region
       Set-DefaultAWSRegion -Region $region

       #Check current credit model
       Get-EC2CreditSpecification -InstanceId $instanceId

       #Change to unlimit
       $unlimitedCredit = New-Object -TypeName Amazon.EC2.Model.InstanceCreditSpecificationRequest
       $unlimitedCredit.InstanceId = $instanceId
       $unlimitedCredit.CpuCredits = "unlimited"
       Set-DefaultAWSRegion -Region $region
       #Get-EC2CreditSpecification -InstanceId $instanceId
       Edit-EC2InstanceCreditSpecification -InstanceCreditSpecification $unlimitedCredit
       #Get-EC2CreditSpecification -InstanceId $instanceId

commands:
  unlimited:
    command: powershell.exe -ExecutionPolicy Bypass -File C:\\users\\Administrator\\changecredit.ps1



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file client_max_body_size in nginx within a Java environment by adding a hook
###################################################################################################

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/enact/12_add_nginx_configuration.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      /bin/echo "client_max_body_size 50M;" > /etc/nginx/conf.d/proxy.conf
      /sbin/service nginx reload



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file modifies logrotate frequency to 5 minutes and upload to S3
###################################################################################################

files:
    "/etc/cron.d/cron.logrotate.elasticbeanstalk.httpd.conf":
        mode: "000644"
        owner: root
        group: root
        content: |
            SHELL=/bin/sh
            PATH=/sbin:/bin:/usr/sbin:/usr/bin
            MAILTO=root
            HOME=/
            */5 * * * * root test -x /usr/sbin/logrotate || exit 0 && /usr/sbin/logrotate -f /etc/logrotate.elasticbeanstalk.hourly/logrotate.elasticbeanstalk.httpd.conf

    "/etc/cron.d/cron.logrotate.elasticbeanstalk.webapp.conf":
        mode: "000644"
        owner: root
        group: root
        content: |
            SHELL=/bin/sh
            PATH=/sbin:/bin:/usr/sbin:/usr/bin
            MAILTO=root
            HOME=/
            */5 * * * * root test -x /usr/sbin/logrotate || exit 0 && /usr/sbin/logrotate -f /etc/logrotate.elasticbeanstalk.hourly/logrotate.elasticbeanstalk.webapp.conf

    "/etc/cron.d/publishlogs":
        mode: "000644"
        owner: root
        group: root
        content: |
            SHELL=/bin/bash
            PATH=/sbin:/bin:/usr/sbin:/usr/bin
            MAILTO=""
            HOME=/
            #This will run every 5 minutes starting at minute 5 of each hour
            1-59/5 * * * * root publishLogs.py --de-dupe --conf-path '/opt/elasticbeanstalk/tasks/publishlogs.d/*' --location-prefix resources/environments/logs/publish/ --num-concurrent 2
            #This will run every 20 minutes starting at minute 6 of each hour
            6-59/20 * * * * root clearStaleLogPublishingRecords.py

# Commands are executed after file creation
commands:
    # Ensure that automatically created .bak files are removed from cron.d
    remove_.bak_crons:
        command: rm -f *.bak
        cwd: /etc/cron.d
    remove_rotate_crons:
        command: rm -f cron.logrotate.elasticbeanstalk.httpd.conf cron.logrotate.elasticbeanstalk.webapp.conf
        cwd: /etc/cron.hourly



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file installs nodejs to a non-NodeJs solution stack. Uncomment the line that
#### relates to the specific major node version
###################################################################################################

files:
  "/tmp/prep_node_installation.sh" :
    mode: "000755"
    owner: root
    group: root
    content: |
      #! /bin/bash
      # Uncomment the line that relates to the specific major node version you want installed

      #  The URL without a major version branch below will result in a node 0.10 installation
      #  curl --silent --location https://rpm.nodesource.com/setup | bash -
      #
      #  curl --silent --location https://rpm.nodesource.com/setup_4.x | bash -
      #  curl --silent --location https://rpm.nodesource.com/setup_6.x | bash -

  "/tmp/install_node.sh" :
    mode: "000755"
    owner: root
    group: root
    content: |
      #! /bin/bash
      yum -y install nodejs

commands:
  00_prep_for_node_install:
    command: "sh /tmp/prep_node_installation.sh"
    ignoreErrors: false

  10_install_node:
    command: "sh /tmp/install_node.sh"
    ignoreErrors: false



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file add a new volume to the instance, create filesystem and mount it
###################################################################################################

commands:
  01mkfs:
    command: "mkfs -t ext3 /dev/sdh"
  02mkdir:
    command: "mkdir /media/volume1"
  03mount:
    command: "mount /dev/sdh /media/volume1"

option_settings:
  - namespace: aws:autoscaling:launchconfiguration
    option_name: BlockDeviceMappings
    value: /dev/sdh=:100



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file adds a secondary NetworkInterface to the EC2 instance. The SubnetId for the
#### secondary interface has to be in the same Availability Zone as the instance.
###################################################################################################

Resources:
  MyNetworkInterface:
    Type: 'AWS::EC2::NetworkInterface'
    Properties:
      Tags:
        - Key: MyInterface
          Value: Address
      Description: Secondary interface.
      SourceDestCheck: 'false'
      SubnetId: subnet-XXXXXXXX     #Subnet for the second interface has to be in the same "AZ" as the instance.
files:
  /etc/elasticbeanstalk/environmentMetadata.sh:
    mode: '000755'
    owner: ec2-user
    group: ec2-user
    content:
      'Fn::Join':
        - ''
        - - "# /etc/elasticbeanstalk/environmentMetadata.sh"
          -  "\n"
          - "export eb_environmentname='"
          - Ref: AWSEBEnvironmentName
          - "\n"
          - "export eb_instancetype='"
          - 'Fn::GetOptionSetting':
              Namespace: 'aws:autoscaling:launchconfiguration'
              OptionName: InstanceType
          - "\n"
          - "export eb_region='"
          - Ref: 'AWS::Region'
          - "\n"
          - export eb_instanceIP='$(curl -s 169.254.169.254/latest/meta-data/local-ipv4)
          - "\n"
          - export eb_InstanceID=$(curl -s 169.254.169.254/latest/meta-data/instance-id)
          - "\n"
          - export eb_NetworkENI=$(aws ec2 describe-network-interfaces
          - ' --region '
          - Ref: 'AWS::Region'
          - ' --filter Name=status,Values=available'
          - " --query 'NetworkInterfaces[?PrivateIpAddress==`"
          - 'Fn::GetAtt':
              - MyNetworkInterface
              - PrimaryPrivateIpAddress
          - "`].NetworkInterfaceId' --output text)"
          - "\n"

  /tmp/env_variables.sh:
    mode: '000775'
    owner: ec2-user
    group: ec2-user
    content:
      'Fn::Join':
        - ''
        - - "#!/bin/bash"
          - "\n"
          - "# /tmp/env_variables.sh"
          - "\n"
          - "source /etc/elasticbeanstalk/environmentMetadata.sh"
          - "\n"
          - "aws ec2 attach-network-interface --network-interface-id $eb_NetworkENI --instance-id $eb_InstanceID --device-index 1"
          - " --region "
          - Ref: 'AWS::Region'
          - "\n"

commands:
  Environment_Variables:
    command: /tmp/env_variables.sh



###################################################################################################
#### Copyright 2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file creates an Amazon EFS file system with mount targets in two subnets,
#### and a security group that allows traffic from the default AWS Elastic Beanstalk instance
#### security group. Each mount target corresponds to a single Availability Zone (AZ). Depending on
#### the region, the number of available AZs will vary. You can add mount target resources and the
#### corresponding subnet option for use in more than two AZs.
####
#### EFS requires a VPC. You can use the default VPC or create a custom VPC to use. If you
#### use a custom VPC, configure it to allow DNS resolution and DNS host names. For more
#### information, see this topic in the Elastic Beanstalk Developer Guide:
####    http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/vpc.html
####
#### Specify your VPC ID and subnet IDs in the "option_settings" section below. In a custom VPC,
#### use the VPC ID and subnet IDs that you chose for the Amazon EC2 instances running your
#### application. When you create a new environment, you can specify VPC settings in a
#### configuration file with the options in the aws:ec2:vpc namespace. See
#### vpc-custom-loadbalanced.config in the environment_configuration folder for an example.
####
#### To use this configuration file in your default VPC, you must have a mount target for each
#### default subnet to ensure that all instances can connect to the file system. Use the VPC
#### management console (https://console.aws.amazon.com/vpc) to determine the number of available
#### AZs and the default subnet for each. Add a subnet option and mount target resource for
#### each additional AZ.
####
#### EFS supports two performance modes for file systems, "generalPurpose" and "maxIO". Change the
#### "PerformanceMode" value under "FileSystem" to "maxIO" for increased throughput and IOPS
#### at the expense of slightly increased latency.
####
#### EFS supports encrypted file systems. To create an EFS encrypted file system, change the
#### "Encrypted" property value to "true". If you keep the "KMSKeyId" property commented out,
#### EFS uses a default KMS key. Alternatively, you can uncomment "KMSKeyId" (remove the initial "#")
#### and set its value to a valid ARN of a KMS key.
#### For information about creating and managing keys, see the AWS Key Management Service
#### Developer Guide:
####    http://docs.aws.amazon.com/kms/latest/developerguide
####
#### To avoid creating the file system more than once, add this configuration file in a deployment
#### without any other configuration changes. After the environment update completes and the file
#### system is ready, use storage-efs-mountfilesystem.config to mount the file system on each
#### instance. Any errors caused by other configuration files added in the same deployment will
#### cause the deployment to fail and the file system to be terminated.
####
#### Back up the contents of your file system to avoid data loss when your environment is
#### terminated. The file system will also be terminated if this configuration file is removed or
#### if you change the performance mode setting.
###################################################################################################

option_settings:
  aws:elasticbeanstalk:customoption:
    VPCId: "vpc-00000000"
## Subnet Options
    SubnetA: "subnet-00000000"
    SubnetB: "subnet-00000000"

Resources:
  FileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      FileSystemTags:
      - Key: Name
        Value: "EB-EFS-FileSystem"
      PerformanceMode: "generalPurpose"
      Encrypted: "false"
#      KmsKeyId: "KMS-key-ARN"

## Mount Target Resources
  MountTargetA:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: {Ref: FileSystem}
      SecurityGroups:
      - {Ref: MountTargetSecurityGroup}
      SubnetId:
        Fn::GetOptionSetting: {OptionName: SubnetA}
  MountTargetB:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: {Ref: FileSystem}
      SecurityGroups:
      - {Ref: MountTargetSecurityGroup}
      SubnetId:
        Fn::GetOptionSetting: {OptionName: SubnetB}

##############################################
#### Do not modify values below this line ####
##############################################

  MountTargetSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for mount target
      SecurityGroupIngress:
      - FromPort: '2049'
        IpProtocol: tcp
        SourceSecurityGroupId:
          Fn::GetAtt: [AWSEBSecurityGroup, GroupId]
        ToPort: '2049'
      VpcId:
        Fn::GetOptionSetting: {OptionName: VPCId}


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### To enable WebSockets on the Node.js platform, this configuration file
#### configures the Nginx proxy server.
#### It replaces the Nginx configuration file with a version that includes the
#### "Upgrade" and "Connection" headers: https://www.nginx.com/blog/websocket-nginx/
####
#### This Elastic Beanstalk configuration file replaces the entire Nginx configuration file.
#### As a result, you won't get our managed updates to the Nginx configuration file, if we make
#### updates in future platform updates. Be sure to test this configuration with new platform versions.
####
#### This configuration file works with single-instance and load-balanced environments.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################

files:
   /etc/nginx/conf.d/proxy.conf:
     owner: root
     group: root
     mode: "000644"
     content: |
       # Elastic Beanstalk Managed

       # Elastic Beanstalk managed configuration file
       # Some configuration of nginx can be by placing files in /etc/nginx/conf.d
       # using Configuration Files.
       # http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers.html

       upstream nodejs {
           server 127.0.0.1:8081;
           keepalive 256;
       }

       server {
           listen 8080;

           if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
               set $year $1;
               set $month $2;
               set $day $3;
               set $hour $4;
           }
           access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
           access_log  /var/log/nginx/access.log  main;

           location / {
               proxy_pass  http://nodejs;
               proxy_http_version 1.1;
               proxy_set_header        Upgrade $http_upgrade;
               proxy_set_header        Connection "upgrade";
               proxy_set_header        Host            $host;
               proxy_set_header        X-Real-IP       $remote_addr;
               proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
           }

       gzip on;
       gzip_comp_level 4;
       gzip_types text/html text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

       }

   /opt/elasticbeanstalk/hooks/configdeploy/post/99_kill_default_nginx.sh:
     owner: root
     group: root
     mode: "000755"
     content: |
       #!/bin/bash -xe
       rm -f /etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf
       service nginx stop
       service nginx start

container_commands:
  removeconfig:
    command: "rm -f /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf /etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file will enable windows features 'Web-WebSockets' on the instance launched
#### under Elastic Beanstalk, also uses appcmd.exe command to enable webSocket on "Default Web Site".
###################################################################################################


commands:
  InstallWebsocket:
    command: powershell.exe Install-WindowsFeature -name Web-WebSockets
  EnableWebsocket:
    command: 'C:\windows\system32\inetsrv\appcmd.exe set config "Default Web Site" -section:system.webServer/webSocket /enabled:"True" /receiveBufferLimit:"4194304" /pingInterval:"00:00:10"  /commit:apphost'



###################################################################################################
#### This is a collection of configuration files, one per platform. Each configuration file
#### configures the platform's proxy server that runs in front of your application to enable WebSockets.
####
#### These configuration files work with single-instance and load-balanced environments.
####
#### Browse to the folder matching your environment's platform for platform-specific information.
###################################################################################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### You don't need to add any configuration to the proxy server of your Ruby with Passenger environment
#### to enable WebSockets.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### To enable WebSockets on the Java with Tomcat platform, this configuration file
#### sets the environment's proxy server to Nginx.
####
#### This configuration file works with single-instance and load-balanced environments.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################

option_settings:
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### You don't need to add any configuration to the proxy server of your Multicontainer Docker environment
#### to enable WebSockets.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### To enable WebSockets on the PHP platform, this configuration file
#### configures the Apache proxy server to use ProxyPass and ProxyPassReverse to proxy the
#### connections through to a PHP application running on port 8000. Change the port number to suit
#### your application's needs. The configuration file also enables the mod_proxy_wstunnel module,
#### which is required for WebSockets to work.
####
#### This configuration file works with single-instance and load-balanced environments.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################

files:
  "/etc/httpd/conf.d/proxy-pass.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      ProxyPass /ws/ ws://127.0.0.1:8000/
      ProxyPassReverse /ws/ ws://127.0.0.1:8000/

  "/etc/httpd/conf.modules.d/99-wstunnel.conf":
    owner: root
    group: root
    mode: "000644"
    content: |
      <IfModule !proxy_wstunnel_module>
      LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
      </IfModule>



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### You don't need to add any configuration to the proxy server of your Go environment
#### to enable WebSockets.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### You don't need to add any configuration to the proxy server of your Java SE environment
#### to enable WebSockets.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### To enable WebSockets on the Python platform, this configuration file
#### configures the Apache proxy server to use ProxyPass and ProxyPassReverse to proxy the
#### connections through to a Python application running on port 8000. Change the port number to suit
#### your application's needs. The configuration file also enables the mod_proxy_wstunnel module,
#### which is required for WebSockets to work.
####
#### This configuration file works with single-instance and load-balanced environments.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################

files:
  "/etc/httpd/conf.d/proxy-pass.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      ProxyPass /ws/ ws://127.0.0.1:8000/
      ProxyPassReverse /ws/ ws://127.0.0.1:8000/

  "/etc/httpd/conf.modules.d/99-mod_proxy_wstunnel.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      <IfModule !proxy_wstunnel_module>
      LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
      </IfModule>



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### You don't need to add any configuration to the proxy server of your Single Container Docker environment
#### to enable WebSockets.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### To enable WebSockets on the Ruby with Puma platform, this configuration file
#### configures the Nginx proxy server.
#### It replaces the Nginx configuration file with a version that includes the
#### "Upgrade" and "Connection" headers: https://www.nginx.com/blog/websocket-nginx/
####
#### This Elastic Beanstalk configuration file replaces the entire Nginx configuration file.
#### As a result, you won't get our managed updates to the Nginx configuration file, if we make
#### updates in future platform updates. Be sure to test this configuration with new platform versions.
####
#### This configuration file works with single-instance and load-balanced environments.
####
#### If you're using a Classic Load Balancer, you need to enable TCP listeners. See:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.elb.html
###################################################################################################

files:
   "/opt/elasticbeanstalk/support/conf/webapp_healthd.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       upstream my_app {
         server unix:///var/run/puma/my_app.sock;
       }

       log_format healthd '$msec"$uri"'
                       '$status"$request_time"$upstream_response_time"'
                       '$http_x_forwarded_for';

       server {
         listen 80;
         server_name _ localhost; # need to listen to localhost for worker tier

         if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
           set $year $1;
           set $month $2;
           set $day $3;
           set $hour $4;
         }

         access_log  /var/log/nginx/access.log  main;
         access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;

         location / {
           proxy_pass http://my_app; # match the name of upstream directive which is defined above
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           proxy_set_header Host $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         }

         location /assets {
           alias /var/app/current/public/assets;
           gzip_static on;
           gzip on;
           expires max;
           add_header Cache-Control public;
         }

         location /public {
           alias /var/app/current/public;
           gzip_static on;
           gzip on;
           expires max;
           add_header Cache-Control public;
         }
       }

   "/opt/elasticbeanstalk/support/conf/webapp.conf":
     owner: root
     group: root
     mode: "000644"
     content: |
       upstream my_app {
         server unix:///var/run/puma/my_app.sock;
       }

       server {
         listen 80;
         server_name _ localhost; # need to listen to localhost for worker tier

         location / {
           proxy_pass http://my_app; # match the name of upstream directive which is defined above
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           proxy_set_header Host $host;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         }

         location /assets {
           alias /var/app/current/public/assets;
           gzip_static on;
           gzip on;
           expires max;
           add_header Cache-Control public;
         }

         location /public {
           alias /var/app/current/public;
           gzip_static on;
           gzip on;
           expires max;
           add_header Cache-Control public;
         }
       }


container_commands:
  99_restart_nginx:
    command: "service nginx restart || service nginx start"



###################################################################################################
#### Copyright 2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file mounts an Amazon EFS file system to a directory named /efs. To mount
#### the file system to a different path, modify the MOUNT_DIRECTORY value in the "option_settings"
#### section.
####
#### The FILE_SYSTEM_ID setting references a resource named "FileSystem", which is created by the
#### storage-efs-createfilesystem.config configuration file. To use this file to mount a
#### file system that you created outside of AWS Elastic Beanstalk, replace the Ref with the
#### resource ID (e.g., fs-e7605f4e):
####
####      FILE_SYSTEM_ID: fs-e7605f4e
####
#### If your environment and file system are in a custom VPC, you must configure the VPC to allow
#### DNS resolution and DNS host names. See this topic in the VPC User Guide for more information:
####    http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-dns.html
###################################################################################################

option_settings:
  aws:elasticbeanstalk:application:environment:
    FILE_SYSTEM_ID: '`{"Ref" : "FileSystem"}`'
    MOUNT_DIRECTORY: '/efs'

##############################################
#### Do not modify values below this line ####
##############################################

packages:
  yum:
    amazon-efs-utils: []

commands:
  01_mount:
    command: "/tmp/mount-efs.sh"

files:
  "/tmp/mount-efs.sh":
      mode: "000755"
      content : |
        #!/bin/bash

        EFS_MOUNT_DIR=$(/opt/elasticbeanstalk/bin/get-config environment -k MOUNT_DIRECTORY)
        EFS_FILE_SYSTEM_ID=$(/opt/elasticbeanstalk/bin/get-config environment -k FILE_SYSTEM_ID)

        echo "Mounting EFS filesystem ${EFS_FILE_SYSTEM_ID} to directory ${EFS_MOUNT_DIR} ..."

        echo 'Stopping NFS ID Mapper...'
        service rpcidmapd status &> /dev/null
        if [ $? -ne 0 ] ; then
            echo 'rpc.idmapd is already stopped!'
        else
            service rpcidmapd stop
            if [ $? -ne 0 ] ; then
                echo 'ERROR: Failed to stop NFS ID Mapper!'
                exit 1
            fi
        fi

        echo 'Checking if EFS mount directory exists...'
        if [ ! -d ${EFS_MOUNT_DIR} ]; then
            echo "Creating directory ${EFS_MOUNT_DIR} ..."
            mkdir -p ${EFS_MOUNT_DIR}
            if [ $? -ne 0 ]; then
                echo 'ERROR: Directory creation failed!'
                exit 1
            fi
        else
            echo "Directory ${EFS_MOUNT_DIR} already exists!"
        fi

        mountpoint -q ${EFS_MOUNT_DIR}
        if [ $? -ne 0 ]; then
            echo "mount -t efs -o tls ${EFS_FILE_SYSTEM_ID}:/ ${EFS_MOUNT_DIR}"
            mount -t efs -o tls ${EFS_FILE_SYSTEM_ID}:/ ${EFS_MOUNT_DIR}
            if [ $? -ne 0 ] ; then
                echo 'ERROR: Mount command failed!'
                exit 1
            fi
            chmod 777 ${EFS_MOUNT_DIR}
            runuser -l  ec2-user -c "touch ${EFS_MOUNT_DIR}/it_works"
            if [[ $? -ne 0 ]]; then
                echo 'ERROR: Permission Error!'
                exit 1
            else
                runuser -l  ec2-user -c "rm -f ${EFS_MOUNT_DIR}/it_works"
            fi
        else
            echo "Directory ${EFS_MOUNT_DIR} is already a valid mountpoint!"
        fi

        echo 'EFS mount complete.'



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file installs Oracle JDK rpm from Amazon S3 and configures the instance(s)
#### in the Elastic Beanstalk environment to use it.
#### Prior to running the below configuration please download the required Oracle JDK version
#### you wish to use and upload this file to an Amazon S3 bucket:
#### http://www.oracle.com/technetwork/java/javase/downloads/index.html
#### Replace the "Default" value in the Parameters section with the S3 URL of the Oracle JDK rpm 
#### key that you have uploaded to Amazon S3.
###################################################################################################

Parameters:
  oraclejdk: 
    Type: String
    Description: "The path to the Oracle JDK rpm in Amazon S3"
    Default: "https://s3-region.amazonaws.com/bucketname/jdk-xxxx-linux-x64.rpm"

files:
  "/tmp/oracle-jdk.rpm":
    mode: "000755"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "oraclejdk" }

  "/tmp/install-oracle-jdk.sh":
    mode: "000755"
    owner: ec2-user
    group: ec2-user
    content: |
      #!/bin/bash
      rpm -Uvh /tmp/oracle-jdk.rpm
      alternatives --install /usr/bin/java java /usr/java/default/bin/java 3
      alternatives --set java /usr/java/default/bin/java

commands:
  execute-install-oracle-jdk-script:
    command: /tmp/install-oracle-jdk.sh

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following parameters configure a bucket name and file path for a file in Amazon S3 that
#### you want to download to the instances in your environment. Replace the placeholder values with
#### your own. The authrole specifies the role to use to download the file. The role must have
#### read access to Amazon S3. You can add S3ReadOnlyAccess to the default instance profile 
#### "aws-elasticbeanstalk-ec2-role", or create a separate role and specify the name below.
###################################################################################################

Parameters:
  bucket: 
    Type: CommaDelimitedList
    Description: "Name of the Amazon S3 bucket that contains your file"
    Default: "elasticbeanstalk-region-accountid"
  fileuri: 
    Type: String
    Description: "Path to the file in S3"
    Default: "https://s3-region.amazonaws.com/elasticbeanstalk-region-accountid/prefix/myfile.txt"
  authrole:
    Type: String
    Description: "Role with permissions to download the file from Amazon S3"
    Default: "aws-elasticbeanstalk-ec2-role"

###################################################################################################
#### Replace the path "/home/ec2-user/myfile.txt" with the path where you want to put the file.
###################################################################################################

files:
  /home/ec2-user/myfile.txt:
    mode: "000777"
    owner: ec2-user
    group: ec2-user
    source: { "Ref" : "fileuri" }
    authentication: S3AccessCred

##############################################
#### Do not modify values below this line ####
##############################################

Resources:
  AWSEBAutoScalingGroup:
    Type: "AWS::AutoScaling::AutoScalingGroup"
    Metadata:
      AWS::CloudFormation::Authentication:
        S3AccessCred:
          type: "S3"
          roleName: { "Ref" : "authrole" } 
          buckets: { "Ref" : "bucket" }



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following file configures a new service, on each Amazon Linux instance in the environment,
#### that publishes logs to S3 upon instance shutdown. An example use case for this would be for
#### root cause analysis after an instance terminates.
#### 
#### The configuration below enables LogPublicationControl allowing log rotation to S3 perodically.
#### A service is then created named "publishlogs" which, upon shutdown, will push the latest
#### logs to S3. These logs are then available on S3 from this location:
####
#### <s3 bucket>/resources/environments/logs/publish/<environment id>/<instance id>/<log name>
####
#### Please note for near realtime "Log Streaming" please have a look here:
#### http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo.cloudwatchlogs.html
###################################################################################################

option_settings:
    aws:elasticbeanstalk:hostmanager:
        LogPublicationControl: true

services:
    sysvinit:
        publishlogs:
            enabled: true
            ensureRunning: true

files:
    "/etc/init.d/publishlogs":
        group: "root"
        owner: "root"
        mode: "000755"
        content: |
            #!/bin/sh
            #
            # publishlogs      PublishLogs on instance shutdown
            #
            # chkconfig 2345 100 00
            # description: this mock service will cause the instance to publish logs at \
            #              instance shutdown, preventing logs from being lost.
            #
            
            ### BEGIN INIT INFO
            # Provides: publishlogs
            # Required-Start:
            # Required-Stop: $network 
            # Default-Start: 2 3 4 5
            # Default-Stop: 0 1 6
            # Short-Description: PublishLogs on instance shutdown
            # Description: this mock service will cause the instance to publish logs at
            #              instance shutdown, preventing logs from being lost.
            ### END INIT INFO
            
            # Source funciton library
            . /etc/rc.d/init.d/functions
            
            prog="publishlogs"
            lockfile=/var/lock/subsys/$prog
            
            [ -e /etc/sysconfig/$prog ] && . /etc/sysconfig/$prog
            
            start() {
                touch $lockfile
            }
            
            stop() {
                echo $"Attempting to publish the remaining logs before shutdown..."
                run-parts /etc/cron.hourly/
                sleep 5
                /usr/bin/publishLogs.py --de-dupe --conf-path '/opt/elasticbeanstalk/tasks/publishlogs.d/*' --location-prefix resources/environments/logs/publish/ --num-concurrent 2 
                /usr/bin/clearStaleLogPublishingRecords.py
                echo $"Log rotation to S3 completed."
                rm $lockfile
            }
            
            restart() {
                stop
                start
            }
            
            rh_status() {
                echo $"$prog is not a service, checking for lockfile..."
                if ! [ -e $lockfile ]
                then
                    echo $"$lockfile missing!"
                    /bin/false
                fi
            }
            
            rh_status_q() {
                rh_status >/dev/null 2>&1
            }
            
            case $1 in
                start)
                    rh_status_q && exit 0
                    $1
                    ;;
                stop)
                    rh_status_q || exit 0
                    $1
                    ;;
                restart)
                    $1
                    ;;
                status)
                    rh_status
                    ;;
                *)
                    echo $"Usage: $0 {start|stop|status|restart}"
                    exit 2
            esac
            
            exit $?



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following option sets an environment property that you can read in your application code
#### to determine the current region. The AWS::Region ref returns the region name as it is used
#### in AWS endpoints, e.g. us-west-2, eu-central-1 etc.
###################################################################################################

option_settings:
  aws:elasticbeanstalk:application:environment:
    AWS_REGION: '`{"Ref" : "AWS::Region"}`'



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file increases the number of MPM Prefork daemons.
#### Its Useful on larger instance types that run out of these daemons well before memory or CPU exhaustion
#### Add this section on the end under MaxRequestWorkers to allow you to verify the change at http://yourenvironmentnamehere.elasticbeanstalk.com/server-info
#### <Location /server-info>
#### SetHandler server-info
#### </Location>
###################################################################################################

files:
  "/etc/httpd/conf.d/mpm_prefork.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      ServerLimit 512
      MaxRequestWorkers 512



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file modifies the launch configuration for the auto scaling group that
#### Elastic Beanstalk uses and sets the device, size (in GB's) and volume type used by its
#### instances. The example below will set device /dev/xvdcz with 40GB a volume using a gp2
#### volume type. This example is particularly useful for setting the size of the docker volume
#### used by default.
###################################################################################################

option_settings:
    aws:autoscaling:launchconfiguration:
        BlockDeviceMappings: "/dev/xvdcz=:40::gp2"




###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file modifies the default rate limiting provided by Amazon Linux to increase 
#### frequency of logging on EB instances.
####
#### Logging rate limits on Elastic Beanstalk instances are modified by:
#### 1. Creating custom config files for journald and rsyslog with increased rate limits
#### 2. Moving these files to their respective .d directories (/etc/systemd/journald.conf.d/ and /etc/rsyslog.d/)
#### 3. Restarting both logging services to apply the changes
####
#### Note: Complete disabling of rate limiting is NOT RECOMMENDED as it could lead to excessive
#### disk usage or system performance issues during unexpected log bursts.
###################################################################################################

files:
    /tmp/custom_journald.conf:
        mode: "000644"
        owner: root
        group: root
        content: |
            [Journal]
            RateLimitIntervalSec=600
            RateLimitBurst=100000

    /tmp/custom_rsyslog.conf:
        mode: "000644"
        owner: root
        group: root
        content: |
            $SystemLogRateLimitInterval 600
            $SystemLogRateLimitBurst    100000
            $imjournalRateLimitInterval 600
            $imjournalRatelimitBurst    1000000

commands:
    01_mv_custom_rsyslog.conf:
        command: mv /tmp/custom_rsyslog.conf /etc/rsyslog.d/
    02_create_journald.conf.d_dir:
        command: cd /etc/systemd && mkdir journald.conf.d
    03_mv_custom_journald.conf:
        command: mv /tmp/custom_journald.conf /etc/systemd/journald.conf.d
    04_restart_journald:
        command: systemctl restart systemd-journald
    05_restart_rsyslog:
        command: systemctl restart rsyslog



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### T2 Unlimited with Elastic Beanstalk for Linux based Environments
#### Since it is not directly possible to use T2 Unlimited instances with Elastic Beanstalk as of now,
#### the below provided ebextensions config file lets you use T2 instances with Surplus credits.
####
#### Note: Since the container_command "set-t2-unlimited" makes an api call "modify-instance-credit-specification",
#### the instance profile associated with the Beanstalk environment's instance must have necessary
#### permissions to make the api call (ec2:ModifyInstanceCreditSpecification).
###################################################################################################

files:
  "/tmp/t2-test.sh":
      mode: "000755"
      content : |
        #!/bin/bash
        instanceType=$(curl -s http://169.254.169.254/latest/meta-data/instance-type)
        if echo "$instanceType" | grep -qe 't2.*'
        then
          exit 0
        else
          exit 1
        fi

container_commands:
  set-t2-unlimited:
    command: |
      aws ec2 modify-instance-credit-specification --region $(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone | sed 's/[a-z]$//') --instance-credit-specification '[{"InstanceId": "'"$(curl -s http://169.254.169.254/latest/meta-data/instance-id)"'","CpuCredits": "unlimited"}]'
    test: "[ /tmp/t2-test.sh ]"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
#### http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Increase file descriptors for Java Tomcat environment
#### Note: Replace 20000 by the desired number of file descriptors.
#### This will increase the number of file descriptors available to all users.
###################################################################################################

files:
  "/etc/security/limits.d/openfiles.conf":
    mode: "00644"
    owner: "root"
    group: "root"
    content: |
      * soft nofile 20000
      * hard nofile 20000

container_commands:
  01_increase_ulimit:
    command: "ulimit -HSn 20000; monit restart httpd tomcat; exit 0"
  02_cleanup:
    command: "rm /etc/security/limits.d/openfiles.conf.bak"
    ignoreErrors: true



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following waitconditiontimeout parameter increases the instance bootstrap timeout. The
#### default is 15 minutes for Linux-based platforms and 20 for Windows Server. Set a longer
#### timeout if you get wait condition failures during environment creation. This setting can only
#### be applied during environment creation and cannot be updated. If your application takes a long
#### time to deploy due to scripts or other tasks in configuration files, increase the command
#### timeout (see `timeout-commands.config`) as well.
###################################################################################################

Parameters:
  waitconditiontimeout: 
    Type: Number
    Description: Number of seconds to wait for instances to notify Elastic Beanstalk that they have launched successfully during environment creation.
    Default: 1500

##############################################
#### Do not modify values below this line ####
##############################################

Resources:
 AWSEBInstanceLaunchWaitCondition:
  Type: AWS::CloudFormation::WaitCondition
  Properties:
    Timeout: { "Ref": "waitconditiontimeout" }


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following command timeout setting increases default timeout to 20 minutes from 10. Set a 
#### longer timeout if your application deployment and instance configuration operations time out.
###################################################################################################

option_settings:
  aws:elasticbeanstalk:command:
    Timeout: 1200



### timeout-commands.config
Use the `Timeout` option in the `aws:elasticbeanstalk:command` to allow the instances in your environment more time to complete deployments and on-instance configuration changes.

### timeout-waitcondition.config
Modify the `Timeout` setting on the wait condition that Elastic Beanstalk creates to allow instances time to bootstrap during environment creation, including time to install libraries, deploy your application, and perform on-instance confguration. If your application takes a long time to deploy due to long running scripts in configuration files, use this setting in conjunction with command timeout (`timeout-commands.config`) to avoid timeouts during environment creation.

### updates-immutable.config
Use immutable updates for all deployments and configuration changes that require instance replacement.

### workertier-scaleonqueuesize.config
By default, worker environments scale based on network throughput. Use this configuration file to scale based on the number of jobs waiting in the environment's SQS queue instead.

### vpc-custom-loadbalanced.config
Use this configuration file to tell Elastic Beanstalk to create your instances and load balancer in a custom VPC that you created, instead of in the default VPC.

### loadbalancer-clb-workertier.config
Use this example when you want to enables an internal classic load balancer for a worker-tier environment. Update the Availability Zones details before applying this configuration file in your environment. Test this configuration file in your test environment before applying to production.

### loadbalancer-cross-zone.config
This configuration file can help in enabling Cross Zone Balancing on a Classic Load Balance. Other configuration options are listed here: https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html#command-options-general-elbloadbalancer



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file creates two CloudWatch alarms to scale the number of instances in a
#### worker environment based on the number of messages available in the environment's SQS queue.
#### The high alarm triggers if more than 20 messages are available, the low alarm if there are 
#### less than five.
####
#### The template gets the name of the queue from the AWSEBWorkerQueue resource,
#### which is the queue that Elastic Beanstalk creates for a worker environment by default.
#### If you configure the environment to use an existing queue instead of creating a new one,
#### Replace the JSON in the Value key under both alarms' dimension with the name of your queue.
###################################################################################################

Resources:
  QueueDepthScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: "ChangeInCapacity"
      PolicyType: "SimpleScaling"
      Cooldown: "300"
      AutoScalingGroupName: {Ref: AWSEBAutoScalingGroup}
      ScalingAdjustment: 1
      
  QueueDepthScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: "ChangeInCapacity"
      PolicyType: "SimpleScaling"
      Cooldown: "300"
      AutoScalingGroupName: {Ref: AWSEBAutoScalingGroup}
      ScalingAdjustment: -1

  QueueDepthAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alarm if queue depth grows beyond 20 messages"
      Namespace: "AWS/SQS"
      MetricName: ApproximateNumberOfMessagesVisible
      Dimensions:
        - Name: QueueName
          Value: { "Fn::GetAtt": ["AWSEBWorkerQueue", "QueueName"] }
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 20
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - Ref: QueueDepthScaleUpPolicy

  QueueDepthAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alarm if queue depth is less than 5 messages"
      Namespace: "AWS/SQS"
      MetricName: ApproximateNumberOfMessagesVisible
      Dimensions:
        - Name: QueueName
          Value: { "Fn::GetAtt": ["AWSEBWorkerQueue", "QueueName"] }
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: LessThanThreshold
      AlarmActions:
        - Ref: QueueDepthScaleDownPolicy


###################################################################################################
#### Copyright 2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file configures your environment to use a custom VPC. If you don't specify
#### VPC settings, AWS Elastic Beanstalk creates your environment's load balancer and instances in
#### the default VPC or, for older accounts without a default VPC, in EC2-Classic.
####
#### Enter your custom VPC's ID and subnet IDs in the "option_settings" section below. In most
#### cases, you will choose public subnets for your load balancer ("ELBSubnets" setting) and
#### private subnets for your instances ("Subnets" setting).
####
#### For more information about configuring VPC settings, see this topic in the Elastic Beanstalk
#### Developer Guide:
####    http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.managing.vpc.html
###################################################################################################

option_settings:
  aws:ec2:vpc:
    VPCId: "vpc-00000000"
    Subnets: "subnet-00000000,subnet-00000000"
    ELBSubnets: "subnet-00000000,subnet-00000000"


###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### The following settings configure your environment to use immutable updates for both
#### a) configuration updates that require instances to be replaced, and b) version deployments.
#### See "Immutable Environment Updates" for more information:
####  https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environmentmgmt-updates-immutable.html
###################################################################################################

option_settings:
  aws:autoscaling:updatepolicy:rollingupdate:
    RollingUpdateType: Immutable
  aws:elasticbeanstalk:command:
    DeploymentPolicy: Immutable



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file can help in enabling Cross Zone Balancing on a Classic Load Balancer
#### Other configuration options are listed here:
#### https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html#command-options-general-elbloadbalancer
###################################################################################################

option_settings:
    - namespace: aws:elb:loadbalancer
      option_name: CrossZone
      value: true



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### Use this example when you want to enables an internal classic load balancer for a worker-tier environment
#### Update the AvailabilityZones details before applying this configuration file in your environment
#### Test this configuration file in your test environment before applying to production
###################################################################################################

Resources:
  AWSEBLoadBalancer:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      AvailabilityZones:
        - YOUR_SUBNETS
        - YOUR_SUBNETS
        - YOUR_SUBNETS
      ConnectionDrainingPolicy:
        Enabled: true
        Timeout: 20
      CrossZone: true
      HealthCheck:
        HealthyThreshold: '3'
        Interval: '10'
        Target:
          'Fn::Join':
            - ''
            - - HTTP
              - ':'
              - 80
              - '/'
        Timeout: '5'
        UnhealthyThreshold: '5'
      SecurityGroups:
        - Ref: AWSEBSecurityGroup
      Scheme: internal
      Listeners:
        - InstancePort: 80
          LoadBalancerPort: '80'
          Protocol: HTTP



gitdir: ../../../.git/modules/repos/awsdocs/elastic-beanstalk-samples



# elastic-beanstalk-samples
This repository complements the AWS Elastic Beanstalk documentation.
It contains examples of [configuration files (.ebextensions)](https://github.com/awslabs/elastic-beanstalk-samples/tree/master/configuration-files) and [AWS CloudFormation templates](https://github.com/awslabs/elastic-beanstalk-samples/tree/master/configuration-files) that you can use to improve your Elastic Beanstalk applications.

To use a configuration file, create a folder named `.ebextensions` in the root of your application source and save the `.config` file from the repository in that folder. Follow the instructions in the configuration file to make it work with your application. Then deploy your application to an Elastic Beanstalk, and make sure you include the `.ebextensions` folder in your source bundle.

To use a CloudFormation template, use the [CloudFormation console](https://console.aws.amazon.com/cloudformation/home) to create a stack from the template. The templates in this repo create resources that you may want to manage independently of your Elastic Beanstalk environment. For example, you can create a VPC to run multiple environments in, and not worry about losing it when you terminate an environment.

You can report issues, make pull requests, and contribute your own resources to help other AWS Elastic Beanstalk customers use the service. We are committed to helping developers learn more about Beanstalk, and we hope you find the this forum useful. Please don't hesitate to let us know how we can improve it to be more useful.

The full set of Elastic Beanstalk documents is at http://aws.amazon.com/documentation/elastic-beanstalk/.


## Sample applications
Sample applications that show the use of additional web frameworks, libraries and tools are available as open source projects on GitHub.

### AWS-provided sample applications
- [Load Balanced WordPress](https://github.com/awslabs/eb-php-wordpress) ([tutorial](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/php-hawordpress-tutorial.html)) â Configuration files for installing WordPress securely and running it in a load balanced AWS Elastic Beanstalk environment.
- [Load Balanced Drupal](https://github.com/awslabs/eb-php-drupal) ([tutorial](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/php-hadrupal-tutorial.html)) â Configuration files and instructions for installing Drupal securely and running it in a load balanced AWS Elastic Beanstalk environment.
- [Scorekeep](https://github.com/awslabs/eb-java-scorekeep) - RESTful web API that uses the Spring framework and the AWS SDK for Java to provide an interface for creating and managing users, sessions, and games. The API is bundled with an Angular 1.5 web app that consumes the API over HTTP. Includes branches that show integration with Amazon Cognito, AWS X-Ray, and Amazon Relational Database Service. The application uses features of the Java SE platform to download dependencies and build on-instance, minimizing the size of the souce bundle. The application also includes nginx configuration files that override the default configuration to serve the frontend web app statically on port 80 through the proxy, and route requests to paths under /api to the API running on localhost:5000.
- [Does it Have Snakes?](https://github.com/awslabs/eb-tomcat-snakes) - Tomcat application that shows the use of RDS in a Java EE web application in AWS Elastic Beanstalk. The project shows the use of Servlets, JSPs, Simple Tag Support, Tag Files, JDBC, SQL, Log4J, Bootstrap, Jackson, and Elastic Beanstalk configuration files.
- [Locust Load Generator](https://github.com/awslabs/eb-locustio-sample) - This project shows the use of Java SE platform features to install and run Locust, a load generating tool written in Python. The project includes configuration files that install and configure Locust, a build script that configures a DynamoDB table, and a Procfile that runs Locust.
- [Share Your Thoughts](https://github.com/awslabs/eb-demo-php-simple-app) ([tutorial](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/php-ha-tutorial.html)) - PHP application that shows the use of MySQL on Amazon RDS, Composer, and configuration files.
- [A New Startup](https://github.com/awslabs/eb-node-express-sample) ([tutorial](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/nodejs-dynamodb-tutorial.html)) - Node.js sample application that shows the use of DynamoDB, the AWS SDK for JavaScript in Node.js, npm package management, and configuration files.
- [Cognito Quickstart](https://github.com/awslabs/aws-cognito-angular2-quickstart) - an AngularV4-based QuickStart web app utilizing Amazon Cognito, S3 or Elastic Beanstalk, and DynamoDB (serverless architecture).

### Community-provided sample applications
- [go-beanstalk-gin](https://github.com/sudo-suhas/go-beanstalk-gin) - Demonstrates the deployment of a simple webapp built using `gin` to Elastic Beanstalk. Dependencies are managed using `dep`. Provided by [Suhas Karanth](https://github.com/sudo-suhas).



Use the templates in this folder to create external resources for your environment in AWS CloudFormation.

**To create resources in CloudFormation**
1. Open the [CloudFormation console](https://console.aws.amazon.com/cloudformation/home).
2. Choose **Create stack**.
3. Choose **Upload a template to Amazon S3**.
4. Choose **Upload file** and upload the template file from your local machine.
5. Choose **Next** and follow the instructions to create a stack with the resources in the template.

To save a template from a web browser, right click the link in the following list and choose **Save as**.

## [instanceprofile-web.yaml](https://raw.githubusercontent.com/awslabs/elastic-beanstalk-samples/master/cfn-templates/instanceprofile-web.yaml)
Create an instance profile for a web application.

## [instanceprofile-worker.yaml](https://raw.githubusercontent.com/awslabs/elastic-beanstalk-samples/master/cfn-templates/instanceprofile-worker.yaml)
Create an instance profile for a worker application.

## [servicerole.yaml](https://raw.githubusercontent.com/awslabs/elastic-beanstalk-samples/master/cfn-templates/servicerole.yaml)
Create a service role that lets Elastic Beanstalk monitor and update your environments.

## [vpc-privatepublic.yaml](https://raw.githubusercontent.com/awslabs/elastic-beanstalk-samples/master/cfn-templates/vpc-privatepublic.yaml)
Create a VPC with public and private subnets.

## [vpc-public.yaml](https://raw.githubusercontent.com/awslabs/elastic-beanstalk-samples/master/cfn-templates/vpc-public.yaml)
Create a VPC with public subnets.



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This template creates a service role that allows Elastic Beanstalk to monitor and manage AWS
#### resources on your behalf. You can use the service role that Elastic Beanstalk creates for all
#### of your environments. But if you need to use separate roles, you can use this template to
#### create them.
###################################################################################################

Resources:
  ServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkService"
      RoleName: "beanstalk-servicerole"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### By default, Elastic Beanstalk creates all of your application's compute and networking
#### resources in the default VPC. Use this template to create a custom VPC with public subnets in
#### two availability zones.
####
#### This template creates the following resources-
####   - A VPC with the IP range 172.31.0.0/16
####   - 2 public subnets
####   - An Internet gateway, and route table to allow environment resources to connect to each
#### other and the Internet.
####
###################################################################################################

Resources:
  PublicVPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 172.31.0.0/16
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName']]
  PublicSubnet1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref PublicVPC
      AvailabilityZone:
        Fn::Select:
         - 0
         - Fn::GetAZs: ""
      CidrBlock: 172.31.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName',Public]]
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone:
        Fn::Select:
         - 1
         - Fn::GetAZs: ""
      VpcId: !Ref PublicVPC
      CidrBlock: 172.31.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName',Public]]
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName']]
  GatewayToInternet:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref PublicVPC
      InternetGatewayId: !Ref InternetGateway
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref PublicVPC
  PublicRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: GatewayToInternet
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  PublicSubnet1RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable
  PublicSubnet2RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable
Outputs:
  PublicVPCID:
    Description: VPC ID
    Value: !Ref "PublicVPC"
    Export:
      Name: BeanstalkPublicVPCID
  PublicSubnet1ID:
    Description: Public Subnet A ID
    Value: !Ref "PublicSubnet1"
    Export:
      Name: BeanstalkPublicVPCSubnet1ID
  PublicSubnet2ID:
    Description: Public Subnet B ID
    Value: !Ref "PublicSubnet2"
    Export:
      Name: BeanstalkPublicVPCSubnet2ID



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### When you run multiple applications with Elastic Beanstalk, it is a good practice to have
#### separate instance profiles for each application. The AWSElasticBeanstalkWebTier managed policy
#### gives the instance permission to use platform features that upload logs and performance data
#### to Amazon S3, AWS CloudWatch, and AWS X-Ray.
####
#### If you use the AWS SDK to access other services from your instances, add policies for those
#### services to the list of managed policies attached to the role. For example-
####
####        - "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
####        - "arn:aws:iam::aws:policy/AmazonSNSFullAccess"
####        - "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
####
#### If you use the Multicontainer Docker platform, add ECS and ECR permissios with these policies-
####
####        - "arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker"
####        - "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
####
###################################################################################################

Resources:
  InstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier"
      RoleName: "beanstalk-web-instanceprofile-role"
  InstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Roles:
        - !Ref 'InstanceProfileRole'
      InstanceProfileName: "beanstalk-web-instanceprofile"



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### By default, Elastic Beanstalk creates all of your application's compute and networking
#### resources in the default VPC. Use this template to create a custom VPC to isolate your
#### environment's resources in a private subnet with customizable security.
####
#### This template creates the following resources-
####   - A VPC with the IP range 172.31.0.0/16
####   - 2 private subnets for the EC2 instances that run your application
####   - 2 public subnets for the load balancer that routes traffic to the instances
####   - An Internet gateway, NAT gateway, and route table to allow the instances
####     to communicate with the load balancer and the Internet.
####
###################################################################################################

Resources:
  PubPrivateVPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 172.31.0.0/16
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName']]
  PublicSubnet1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref PubPrivateVPC
      AvailabilityZone:
        Fn::Select:
         - 0
         - Fn::GetAZs: ""
      CidrBlock: 172.31.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName',Public]]
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone:
        Fn::Select:
         - 1
         - Fn::GetAZs: ""
      VpcId: !Ref PubPrivateVPC
      CidrBlock: 172.31.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName',Public]]
  PrivateSubnet1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref PubPrivateVPC
      AvailabilityZone:
        Fn::Select:
         - 0
         - Fn::GetAZs: ""
      CidrBlock: 172.31.3.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName',Private]]
  PrivateSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref PubPrivateVPC
      AvailabilityZone:
        Fn::Select:
         - 1
         - Fn::GetAZs: ""
      CidrBlock: 172.31.2.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName',Private]]
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: !Join [_, [!Ref 'AWS::StackName']]
  GatewayToInternet:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref PubPrivateVPC
      InternetGatewayId: !Ref InternetGateway
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref PubPrivateVPC
  PublicRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: GatewayToInternet
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  PublicSubnet1RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable
  PublicSubnet2RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable
  NatGateway:
    Type: "AWS::EC2::NatGateway"
    DependsOn: NatPublicIP
    Properties:
      AllocationId: !GetAtt NatPublicIP.AllocationId
      SubnetId: !Ref PublicSubnet1
  NatPublicIP:
    Type: "AWS::EC2::EIP"
    DependsOn: PubPrivateVPC
    Properties:
      Domain: vpc
  PrivateRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref PubPrivateVPC
  PrivateRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway
  PrivateSubnet1RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable
  PrivateSubnet2RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable
Outputs:
  PubPrivateVPCID:
    Description: VPC ID
    Value: !Ref "PubPrivateVPC"
    Export:
      Name: BeanstalkVPCID
  PrivateSubnet1ID:
    Description: Private Subnet A ID
    Value: !Ref "PrivateSubnet1"
    Export:
      Name: BeanstalkPrivateSubnet1ID
  PrivateSubnet2ID:
    Description: Private Subnet B ID
    Value: !Ref "PrivateSubnet2"
    Export:
      Name: BeanstalkPrivateSubnet2ID
  PublicSubnet1ID:
    Description: Public Subnet A ID
    Value: !Ref "PublicSubnet1"
    Export:
      Name: BeanstalkPublicSubnet1ID
  PublicSubnet2ID:
    Description: Public Subnet B ID
    Value: !Ref "PublicSubnet2"
    Export:
      Name: BeanstalkPublicSubnet2ID



###################################################################################################
#### Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### By default, Elastic Beanstalk creates all of your application's compute and networking
#### resources in the default VPC. Use this template to create a custom VPC to isolate your
#### environment's resources in a private subnet with customizable security.
####
#### The template creates a VPC with no public subnets. It's suitable for use when your application
#### doesn't need public internet access. It's particularly useful when combined with interface VPC
#### endpoints.
#### For details, see https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/vpc-vpce.html .
####
#### This template creates the following resources-
####   - A VPC with the IP range 172.31.0.0/16
####   - 2 private subnets for the EC2 instances that run your application
####  ####
###################################################################################################

Resources:
  PrivateVPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 172.31.0.0/16
      Tags:
        - Key: Name
          Value: !Join 
            - _
            - - !Ref 'AWS::StackName'
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PrivateVPC
      Tags:
      - Key: Name
        Value: Private Subnets
      - Key: Network
        Value: Private            
  PrivateSubnet1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref PrivateVPC
      AvailabilityZone:
        'Fn::Select':
          - 0
          - 'Fn::GetAZs': ''
      CidrBlock: 172.31.3.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Join 
            - _
            - - !Ref 'AWS::StackName'
              - Private
  PrivateSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref PrivateVPC
      AvailabilityZone:
        'Fn::Select':
          - 1
          - 'Fn::GetAZs': ''
      CidrBlock: 172.31.2.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Join 
            - _
            - - !Ref 'AWS::StackName'
              - Private
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable              
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable          
Outputs:
  PrivateVPCID:
    Description: VPC ID
    Value: !Ref PrivateVPC
    Export:
      Name: BeanstalkVPCID
  PrivateSubnet1ID:
    Description: Private Subnet A ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: BeanstalkPrivateSubnet1ID
  PrivateSubnet2ID:
    Description: Private Subnet B ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: BeanstalkPrivateSubnet2ID



###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### When you run multiple applications with Elastic Beanstalk, it is a good practice to have
#### separate instance profiles for each application. The AWSElasticBeanstalkWorkerTier managed
#### policy gives the instance permission to use DynamoDB to perform leader election, SQS
#### permissions to manage items in the worker queue, and Amazon S3, AWS CloudWatch, and AWS X-Ray
#### permission to use platform features that upload logs and performance data.
####
#### If you use the AWS SDK to access other services from your instances, add policies for those
#### services to the list of managed policies attached to the role. For example-
####
####        - "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
####        - "arn:aws:iam::aws:policy/AmazonSNSFullAccess"
####        - "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
####
#### If you use the Multicontainer Docker platform, add ECS and ECR permissios with these policies-
####
####        - "arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker"
####        - "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
####
###################################################################################################

Resources:
  InstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier"
      RoleName: "scorekeep-beanstalk-ecs-role"
  InstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Roles:
        - !Ref 'InstanceProfileRole'
      InstanceProfileName: "scorekeep-beanstalk-ecs-role"



print("Hello World")
print("Hello World") #2nd one

def hello():
  return "hello"

#welcome funtion



